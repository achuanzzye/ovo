<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="ç‹¸ç‹¸èŠå¤©å™¨" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="application-name" content="ç‹¸ç‹¸èŠå¤©å™¨" />
    <meta name="theme-color" content="#ffffff" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

    <title>ç‹¸ç‹¸èŠå¤©å™¨</title>
    <link rel="apple-touch-icon" href="https://img.remit.ee/api/file/BQACAgUAAyEGAASHRsPbAALeQGiurXWalX9xKJAFjN2D5-leZgIXAAJsHwACj8BxVUCgv_URGrTRNgQ.jpeg" />
    <style>
        /* â€”â€” åŸºç¡€é‡è®¾ â€”â€” */
        * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
        html,body { height:100%; width:100%; font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, "Helvetica Neue", Arial; background: #ffffff; color:#111; overflow:hidden; -webkit-font-smoothing:antialiased; }
        body { -webkit-user-select: none; user-select: none; }

        /* android-only status bar (é»˜è®¤éšè—ï¼Œé€šè¿‡ JS body.android æ‰“å¼€) */
        .status-bar { display:none; height:24px; background:#f7f7f8; color:#000; font-size:12px; align-items:center; gap:8px; padding:0 10px; }
        body.android .status-bar { display:flex; justify-content:space-between; }
        .status-left, .status-right { display:flex; align-items:center; gap:8px; }

        /* app container - iOS é£æ ¼æ¡Œé¢ï¼ˆç™½è‰²ï¼‰ */
        .app-container { position:fixed; inset:0; padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom); display:flex; flex-direction:column; background: var(--bg-image, #fff); }

        /* é¡¶éƒ¨æ—¶é—´åŒº */
        .home-top { padding: 28px 20px 10px; text-align:center; }
        .time-widget .time { font-size:64px; font-weight:600; color:#111; line-height:0.95; }
        .time-widget .date { margin-top:8px; font-size:14px; color:#666; }

        /* åº”ç”¨å›¾æ ‡ç½‘æ ¼ */
        .app-grid { padding: 14px 20px 0; display:grid; grid-template-columns:repeat(4,1fr); gap:18px; margin-bottom:auto; }
        .app-icon { width:64px; height:64px; border-radius:14px; display:flex; align-items:center; justify-content:center; font-size:28px; cursor:pointer; background:#f5f6f7; border:1px solid rgba(0,0,0,0.04); transition: transform .18s ease, box-shadow .18s ease; overflow:hidden; }
        .app-icon:active { transform: scale(.96); }
        .app-icon img { width:100%; height:100%; object-fit:cover; display:block; }

        /* Dock æ ·å¼ï¼ˆiOS 26 é£æ ¼ï¼Œçº¯å›¾æ ‡ï¼‰ */
        .dock { position:fixed; left:16px; right:16px; bottom: calc(18px + env(safe-area-inset-bottom)); height:78px; display:flex; align-items:center; justify-content:center; gap:24px; background: rgba(255,255,255,0.9); border-radius:22px; box-shadow: 0 8px 28px rgba(20,20,20,0.06); border: 1px solid rgba(0,0,0,0.04); padding:12px 18px; backdrop-filter: blur(6px); z-index:50; }
        .dock .dock-icon { width:58px; height:58px; border-radius:14px; display:flex; align-items:center; justify-content:center; background: #fff; box-shadow: 0 2px 6px rgba(0,0,0,0.06); font-size:26px; cursor:pointer; }
        .dock .dock-icon:active{ transform:scale(.97); }

        /* Chat App (è¦†ç›–å¼å…¨å±æ¨¡æ€ï¼Œåº•éƒ¨å¯¼èˆªä¸ºåˆ†æ®µå¼æ‚¬æµ®) */
        .chat-app { display:none; position:fixed; inset:0; z-index:1000; background: var(--chat-overlay-bg, rgba(255,255,255,1)); }
        .chat-top { position:sticky; top:0; display:flex; align-items:center; gap:12px; padding:12px 14px; background: transparent; transition: all .25s ease; z-index:40; }
        .chat-top.blur { background: linear-gradient(180deg, rgba(255,255,255,0.82), rgba(255,255,255,0.6)); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(0,0,0,0.04); }
        .home-btn { width:36px; height:36px; border-radius:10px; display:flex; align-items:center; justify-content:center; font-size:16px; cursor:pointer; background:#fff; border:1px solid rgba(0,0,0,0.04); }

        .chat-content { height: calc(100dvh - 110px - env(safe-area-inset-top)); overflow:auto; padding: 16px; background: var(--chat-bg, #fff); }

        /* æ‚¬æµ®åº•éƒ¨åˆ†æ®µå¼å¯¼èˆª */
        .chat-bottom-nav { position: fixed; left: 20px; right: 20px; bottom: calc(20px + env(safe-area-inset-bottom)); height: 72px; display:flex; align-items:center; justify-content:space-between; gap:12px; z-index:60; }
        .chat-bottom-nav .capsule { flex:1; display:flex; align-items:center; justify-content:space-around; background: rgba(245,246,247,0.95); border-radius: 999px; padding: 8px 14px; box-shadow:0 8px 20px rgba(20,20,20,0.04); border:1px solid rgba(0,0,0,0.03); gap:10px; }
        .chat-bottom-nav .capsule .nav-item { flex:1; text-align:center; padding:8px 10px; border-radius:999px; cursor:pointer; font-size:13px; color:#666; }
        .chat-bottom-nav .capsule .nav-item.active { background:#007AFF; color:#fff; box-shadow:0 4px 12px rgba(3,102,214,0.12); }
        .chat-bottom-nav .me-circle { width:62px; height:62px; border-radius:50%; background:#fff; display:flex; align-items:center; justify-content:center; box-shadow:0 8px 20px rgba(20,20,20,0.06); border:1px solid rgba(0,0,0,0.04); cursor:pointer; }

        /* èŠå¤©æ¶ˆæ¯åŒº */
        .chat-messages { display:flex; flex-direction:column; gap:12px; padding-bottom:20px; }
        .message { display:flex; max-width:78%; }
        .message.user { margin-left:auto; flex-direction:row-reverse; }
        .message-bubble { padding:10px 14px; border-radius:16px; background:#f3f4f6; color:#111; word-wrap:break-word; }
        .message.user .message-bubble { background:#007AFF; color:#fff; border-bottom-right-radius:6px; }
        .message.ai .message-bubble { background:#f3f4f6; color:#111; border-bottom-left-radius:6px; }

        /* è¾“å…¥åŒº */
        .chat-input-area { position:sticky; bottom:0; background:linear-gradient(180deg, rgba(255,255,255,0.6), rgba(255,255,255,1)); padding:12px; display:flex; flex-direction:column; gap:8px; border-top:1px solid rgba(0,0,0,0.04); }
        .chat-tools { display:flex; gap:8px; }
        .tool-btn { flex:1; height:38px; border-radius:12px; border:none; background:#f5f6f7; display:flex; align-items:center; justify-content:center; cursor:pointer; font-size:16px; }
        .chat-input { display:flex; gap:8px; align-items:center; }
        .chat-input input[type="text"] { flex:1; height:44px; border-radius:12px; padding:0 14px; border:1px solid rgba(0,0,0,0.06); background:#fff; outline:none; font-size:15px; }
        .send-btn { width:54px; height:44px; border-radius:12px; border:none; background:#007AFF; color:#fff; display:flex; align-items:center; justify-content:center; cursor:pointer; font-weight:600; }

        /* è®¾ç½® / ä¸»é¢˜ / æ¸¸æˆ / æ¨¡æ€ åŸºæœ¬æ ·å¼ */
        .screen { display:none; position:fixed; inset:0; z-index:900; background: #fff; overflow:auto; }
        .screen .header { padding: 12px 16px; display:flex; gap:12px; align-items:center; border-bottom:1px solid rgba(0,0,0,0.04); position:sticky; top:0; background:rgba(255,255,255,0.9); backdrop-filter:blur(6px); z-index:80; }
        .screen .content { padding:16px; color:#111; }
        .setting-item { margin-bottom:14px; }
        .setting-label { font-size:13px; color:#333; margin-bottom:8px; display:block; }
        .modal { display:none; position:fixed; inset:0; z-index:1200; background: rgba(0,0,0,0.45); align-items:center; justify-content:center; padding:20px; }
        .modal .box { width:100%; max-width:420px; background:#fff; border-radius:12px; padding:18px; }

        /* ä¸»é¢˜ç•Œé¢çš„ä¸Šä¼ æŒ‰é’® */
        .file-input { display:inline-block; padding:10px 14px; background:#007AFF; color:#fff; border-radius:10px; cursor:pointer; }

        /* åœ†å½¢å¤´åƒ */
        .avatar { width:64px; height:64px; border-radius:50%; background:#f5f6f7; display:flex; align-items:center; justify-content:center; font-size:28px; overflow:hidden; }

        /* moments å¡ç‰‡ */
        .moment-card { background:#fff; border-radius:12px; box-shadow:0 6px 18px rgba(18,18,18,0.04); padding:12px; margin-bottom:12px; border:1px solid rgba(0,0,0,0.03); }
        .moment-header { display:flex; gap:12px; align-items:center; margin-bottom:8px; }
        .moment-content { color:#222; line-height:1.5; margin-bottom:8px; }
        .moment-actions { display:flex; gap:12px; color:#666; font-size:13px; }

        /* æ¸¸æˆä¸»ç•Œé¢å¡ç‰‡ */
        .game-grid { display:flex; flex-direction:column; gap:12px; padding:16px; }
        .game-card { background:#fff; border-radius:12px; padding:16px; display:flex; align-items:center; justify-content:space-between; box-shadow:0 8px 20px rgba(20,20,20,0.04); cursor:pointer; border:1px solid rgba(0,0,0,0.03); }

        /* å°å±å¹•å…¼å®¹ */
        @media (max-width:360px) {
            .time-widget .time { font-size:48px; }
            .app-icon { width:56px; height:56px; border-radius:12px; font-size:24px; }
            .dock { height:68px; }
        }
    </style>
</head>
<body>

    <!-- Android ä¸“ç”¨çŠ¶æ€æ ï¼ˆä»…åœ¨ body.android æ—¶æ˜¾ç¤ºï¼‰ -->
    <div class="status-bar" aria-hidden="true">
        <div class="status-left"><span>09:41</span></div>
        <div class="status-right"><span>LTE</span> <span>ğŸ”‹ 92%</span></div>
    </div>

    <div class="app-container" id="appContainer">
        <!-- ä¸»å±ï¼šæ—¶é—´ + å›¾æ ‡ -->
        <div class="home-top">
            <div class="time-widget">
                <div class="time" id="currentTime">--:--</div>
                <div class="date" id="currentDate">--æœˆ--æ—¥ æ˜ŸæœŸ-</div>
            </div>
        </div>

        <div class="app-grid" id="appGrid">
            <!-- å›¾æ ‡æŒ‰éœ€æ¸²æŸ“ -->
        </div>

        <!-- Dockï¼ˆåªæ˜¾ç¤ºå›¾æ ‡ï¼‰ -->
        <div class="dock" id="dock">
            <div class="dock-icon" id="dock-chat" title="èŠå¤©" onclick="openChatApp()">ğŸ’¬</div>
            <div class="dock-icon" id="dock-game" title="æ¸¸æˆ" onclick="openGameApp()">ğŸ®</div>
            <div class="dock-icon" id="dock-settings" title="è®¾ç½®" onclick="openSettings()">âš™ï¸</div>
            <div class="dock-icon" id="dock-theme" title="ä¸»é¢˜" onclick="openTheme()">ğŸ¨</div>
        </div>
    </div>

    <!-- èŠå¤© App ä¸»ä½“ï¼ˆè¦†ç›–å¼ï¼‰ -->
    <div class="chat-app" id="chatApp">
        <div class="chat-top" id="chatTop">
            <div class="home-btn" onclick="goHome()">âŒ‚</div>
            <div style="flex:1; text-align:center; font-weight:600;">æ¶ˆæ¯</div>
            <div style="width:36px"></div>
        </div>

        <div class="chat-content" id="chatContent">
            <!-- å­è§†å›¾ æŒ‰éœ€åˆ‡æ¢ -->
            <div id="chatsView" class="subview">
                <!-- æ¶ˆæ¯åˆ—è¡¨ -->
                <div class="chat-messages" id="chatMessagesMain">
                    <div style="color:#888; text-align:center; margin-top:30px;">è¯·é€‰æ‹©æˆ–æ·»åŠ è”ç³»äººå¼€å§‹èŠå¤©</div>
                </div>
            </div>

            <div id="contactsView" class="subview" style="display:none;">
                <div style="padding:8px 0 18px; display:flex; justify-content:space-between; align-items:center;">
                    <div style="font-weight:600;">è”ç³»äºº</div>
                    <button class="home-btn" onclick="openAddContactModal()">ï¼‹</button>
                </div>
                <div id="contactsList"></div>
            </div>

            <div id="momentsView" class="subview" style="display:none;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                    <div style="font-weight:600;">æœ‹å‹åœˆ</div>
                    <button class="file-input" onclick="openMomentModal()">å‘ä¸€æ¡</button>
                </div>
                <div id="momentsContainer"></div>
            </div>

            <div id="meView" class="subview" style="display:none;">
                <div style="display:flex; gap:12px; align-items:center; margin-bottom:12px;">
                    <div class="avatar" id="meAvatar" onclick="openEditProfileModal()">ğŸ˜Š</div>
                    <div style="flex:1;">
                        <div id="meName" style="font-weight:700;">æˆ‘</div>
                        <div id="mePrompt" style="color:#666; font-size:13px;">ä¸ªäºº prompt</div>
                    </div>
                </div>
                <div style="display:flex; gap:10px;">
                    <button class="file-input" onclick="openEditProfileModal()">ç¼–è¾‘èµ„æ–™</button>
                    <button class="file-input" onclick="exportData()">å¯¼å‡ºæ•°æ®</button>
                </div>
            </div>
        </div>

        <!-- åˆ†æ®µå¼åº•éƒ¨å¯¼èˆª + me åœ†å½¢ -->
        <div class="chat-bottom-nav" id="chatBottomNav">
            <div class="capsule" id="leftCapsule">
                <div class="nav-item active" data-tab="chats" onclick="switchChatTab('chats')">æ¶ˆæ¯</div>
                <div class="nav-item" data-tab="contacts" onclick="switchChatTab('contacts')">è”ç³»äºº</div>
                <div class="nav-item" data-tab="moments" onclick="switchChatTab('moments')">æœ‹å‹åœˆ</div>
            </div>
            <div class="me-circle" onclick="switchChatTab('me')" title="æˆ‘">æˆ‘</div>
        </div>

        <!-- è¾“å…¥åŒºåŸŸï¼ˆç»Ÿä¸€ï¼‰ -->
        <div style="position:fixed; left:20px; right:20px; bottom: calc(100px + env(safe-area-inset-bottom)); z-index:70;">
            <div class="chat-input-area" id="chatInputArea">
                <div class="chat-tools">
                    <button class="tool-btn" onclick="openImageModal()">ğŸ–¼ï¸</button>
                    <button class="tool-btn" onclick="openVoiceModal()">ğŸ¤</button>
                    <button class="tool-btn" onclick="openLinkModal()">ğŸ”—</button>
                    <button class="tool-btn" onclick="openMoneyModal()">ğŸ’°</button>
                </div>
                <div class="chat-input">
                    <input type="text" id="messageInput" placeholder="è¾“å…¥æ¶ˆæ¯...ï¼ˆå›è½¦åªå‘é€æœ¬åœ°ï¼Œä¸ä¼šè§¦å‘å›å¤ï¼›ç‚¹å‡»å‘é€é”®ä¼šè¯·æ±‚ AI å›å¤ï¼‰" onkeydown="handleKeyPress(event)" />
                    <button class="send-btn" onclick="sendMessageWithReply()">å‘é€</button>
                </div>
            </div>
        </div>

    </div>

    <!-- å•èŠçª—å£ï¼ˆå…¨å±å±•å¼€ï¼‰ -->
    <div class="screen" id="chatScreen">
        <div class="header">
            <div class="home-btn" onclick="backToChatApp()">â†</div>
            <div style="flex:1; text-align:center; font-weight:600;" id="chatScreenTitle">å¯¹è¯</div>
            <div style="width:36px"></div>
        </div>
        <div class="content" id="chatScreenContent"></div>
    </div>

    <!-- è®¾ç½®ç•Œé¢ï¼ˆæ–°å¢ä¸–ç•Œä¹¦ + äº‘å¤‡ä»½ï¼‰ -->
    <div class="screen" id="settingsScreen">
        <div class="header">
            <div class="home-btn" onclick="goHome()">â†</div>
            <div style="flex:1; text-align:center; font-weight:600;">è®¾ç½®</div>
            <div style="width:36px"></div>
        </div>
        <div class="content">
            <div class="setting-item">
                <label class="setting-label">API æœåŠ¡å•†</label>
                <select id="apiProvider" onchange="updateApiSettings()">
                    <option value="openai">OpenAI</option>
                    <option value="claude">Claude</option>
                    <option value="custom">è‡ªå®šä¹‰</option>
                </select>
            </div>
            <div class="setting-item">
                <label class="setting-label">API åœ°å€</label>
                <input type="text" id="apiUrl" placeholder="https://api.openai.com/v1/chat/completions" style="width:100%; padding:10px; border:1px solid rgba(0,0,0,0.06); border-radius:8px;" />
            </div>
            <div class="setting-item">
                <label class="setting-label">API å¯†é’¥</label>
                <input type="password" id="apiKey" placeholder="è¾“å…¥ä½ çš„ API å¯†é’¥" style="width:100%; padding:10px; border:1px solid rgba(0,0,0,0.06); border-radius:8px;" />
            </div>
            <div class="setting-item">
                <label class="setting-label">é»˜è®¤æ¨¡å‹</label>
                <input type="text" id="modelName" placeholder="gpt-3.5-turbo" style="width:100%; padding:10px; border:1px solid rgba(0,0,0,0.06); border-radius:8px;" />
            </div>

            <!-- Worldbookï¼ˆä¸–ç•Œä¹¦ï¼‰ -->
            <div class="setting-item">
                <label class="setting-label">ä¸–ç•Œä¹¦ï¼ˆWorldbookï¼‰</label>
                <div style="display:flex; gap:8px; margin-bottom:8px;">
                    <button class="file-input" onclick="document.getElementById('worldbookImport').click()">å¯¼å…¥ JSON</button>
                    <button class="file-input" onclick="openWorldbookModal()">æ–°å»ºæ¡ç›®</button>
                </div>
                <input type="file" id="worldbookImport" accept=".json" style="display:none" onchange="handleWorldbookImport(event)" />
                <div id="worldbookList" style="margin-top:10px;"></div>
            </div>

            <!-- äº‘å¤‡ä»½é…ç½® -->
            <div class="setting-item">
                <label class="setting-label">è‡ªåŠ¨äº‘å¤‡ä»½</label>
                <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
                    <select id="cloudProvider" style="padding:8px; border:1px solid rgba(0,0,0,0.06); border-radius:8px;">
                        <option value="">æœªé€‰æ‹©</option>
                        <option value="google">Google Drive</option>
                        <option value="dropbox">Dropbox</option>
                        <option value="onedrive">OneDrive</option>
                    </select>
                    <label style="display:flex; align-items:center; gap:8px;">
                        <input type="checkbox" id="autoBackupToggle" /> è‡ªåŠ¨å¤‡ä»½
                    </label>
                </div>
                <div style="margin-bottom:8px;">
                    <input id="cloudToken" placeholder="äº‘ç›˜ä»¤ç‰Œ / å‡­è¯ï¼ˆç”¨äºè‡ªåŠ¨å¤‡ä»½ï¼‰" style="width:100%; padding:10px; border:1px solid rgba(0,0,0,0.06); border-radius:8px;" />
                </div>
                <div style="color:#666; font-size:13px;">æ³¨ï¼šæ­¤å¤„ä¸ºé…ç½®é¡¹ï¼Œå®é™…å¤‡ä»½éœ€è¦ä¸ç½‘ç›˜ API æˆæƒé…åˆã€‚æˆ‘ä»¬ä¼šæŠŠå¤‡ä»½æ–‡ä»¶ä»¥ JSON å½¢å¼æ¨é€åˆ°ä½ çš„ç½‘ç›˜è·¯å¾„ã€‚</div>
            </div>

            <div class="setting-item" style="margin-top:8px;">
                <button class="file-input" onclick="saveSettings()">ä¿å­˜è®¾ç½®</button>
            </div>
        </div>
    </div>

    <!-- ä¸»é¢˜ç•Œé¢ï¼ˆå£çº¸ / åº”ç”¨å›¾æ ‡ / å­—ä½“ URL / èŠå¤©èƒŒæ™¯ï¼‰ -->
    <div class="screen" id="themeScreen">
        <div class="header">
            <div class="home-btn" onclick="goHome()">â†</div>
            <div style="flex:1; text-align:center; font-weight:600;">ä¸»é¢˜</div>
            <div style="width:36px"></div>
        </div>
        <div class="content">
            <div class="setting-item">
                <label class="setting-label">å£çº¸ï¼ˆæ¡Œé¢ï¼‰</label>
                <input type="file" id="wallpaperFile" accept="image/*" onchange="uploadWallpaper(event)" />
                <div style="margin-top:8px; color:#666;">ä¸Šä¼ å›¾ç‰‡å°†ä½œä¸ºæ¡Œé¢å£çº¸</div>
            </div>

            <div class="setting-item">
                <label class="setting-label">èŠå¤©èƒŒæ™¯ï¼ˆèŠå¤© App å†…ï¼‰</label>
                <input type="file" id="chatBgFile" accept="image/*" onchange="uploadChatBg(event)" />
                <div style="margin-top:8px; color:#666;">èŠå¤© App çš„æ‰€æœ‰ç•Œé¢èƒŒæ™¯å¯åœ¨æ­¤å¤„è®¾ç½®ï¼ˆé»˜è®¤ç™½è‰²ï¼‰</div>
            </div>

            <div class="setting-item">
                <label class="setting-label">åº”ç”¨å›¾æ ‡è‡ªå®šä¹‰</label>
                <select id="iconAppSelect" style="width:100%; padding:10px; border:1px solid rgba(0,0,0,0.06); border-radius:8px;">
                    <option value="chat">èŠå¤©</option>
                    <option value="game">æ¸¸æˆ</option>
                    <option value="settings">è®¾ç½®</option>
                    <option value="theme">ä¸»é¢˜</option>
                </select>
                <input type="file" id="iconImageFile" accept="image/*" style="margin-top:8px;" onchange="updateAppIcon(event)" />
                <div style="margin-top:8px;">
                    <button class="file-input" onclick="saveCustomIcon()">ä¿å­˜å›¾æ ‡</button>
                </div>
            </div>

            <div class="setting-item">
                <label class="setting-label">å…¨å±€å­—ä½“ï¼ˆä»…æ”¯æŒ URLï¼‰</label>
                <input id="fontUrlInput" placeholder="https://example.com/yourfont.woff2" style="width:100%; padding:10px; border:1px solid rgba(0,0,0,0.06); border-radius:8px;" />
                <div style="margin-top:8px; display:flex; gap:8px;">
                    <button class="file-input" onclick="applyFontUrl()">åº”ç”¨å­—ä½“</button>
                    <button class="file-input" onclick="clearCustomFont()">æ¸…é™¤å­—ä½“</button>
                </div>
                <div style="margin-top:8px; color:#666; font-size:13px;">è¯´æ˜ï¼šè¾“å…¥å¯ç›´æ¥è®¿é—®çš„å­—ä½“æ–‡ä»¶ URLï¼ˆwoff/woff2/ttfï¼‰ï¼Œç³»ç»Ÿä¼šå°è¯•é€šè¿‡ @font-face åŠ è½½å¹¶åº”ç”¨ã€‚</div>
            </div>
        </div>
    </div>

    <!-- æ¸¸æˆ Appï¼ˆå ä½ï¼šå–µå–µç‰Œ + æ‰­è›‹æœºï¼‰ -->
    <div class="screen" id="gameScreen">
        <div class="header">
            <div class="home-btn" onclick="goHome()">â†</div>
            <div style="flex:1; text-align:center; font-weight:600;">æ¸¸æˆ</div>
            <div style="width:36px"></div>
        </div>
        <div class="content">
            <div class="game-grid">
                <div class="game-card" onclick="openGame('meow')">
                    <div>
                        <div style="font-weight:700;">å–µå–µç‰Œ</div>
                        <div style="color:#666; font-size:13px;">ç©å–µå–µç‰Œå¯è·å¾—æ‰­è›‹å¸</div>
                    </div>
                    <div>â¡</div>
                </div>

                <div class="game-card" onclick="openGame('gacha')">
                    <div>
                        <div style="font-weight:700;">æ‰­è›‹æœº</div>
                        <div style="color:#666; font-size:13px;">ç”¨æ‰­è›‹å¸æŠ½å¥–è·å¾—ç¨€æœ‰å›¾æ ‡/è£…é¥°</div>
                    </div>
                    <div>â¡</div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ¨¡æ€ / å¼¹çª— -->
    <div class="modal" id="addContactModal">
        <div class="box">
            <div style="font-weight:700; margin-bottom:8px;">æ·»åŠ  AI è”ç³»äºº</div>
            <input id="contactName" placeholder="è”ç³»äººå§“å" style="width:100%; padding:10px; border:1px solid rgba(0,0,0,0.06); border-radius:8px; margin-bottom:8px;" />
            <textarea id="contactPrompt" placeholder="ä¸ªæ€§åŒ– prompt..." style="width:100%; padding:10px; border:1px solid rgba(0,0,0,0.06); border-radius:8px; min-height:100px;"></textarea>
            <div style="display:flex; gap:8px; margin-top:8px;">
                <button class="file-input" onclick="confirmAddContact()">æ·»åŠ </button>
                <button class="file-input" onclick="closeModal('addContactModal')">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <div class="modal" id="momentModal">
        <div class="box">
            <div style="font-weight:700; margin-bottom:8px;">å‘å¸ƒæœ‹å‹åœˆ</div>
            <textarea id="momentText" style="width:100%; padding:10px; border:1px solid rgba(0,0,0,0.06); border-radius:8px; min-height:100px;"></textarea>
            <div style="display:flex; gap:8px; margin-top:8px;">
                <button class="file-input" onclick="postMoment()">å‘å¸ƒ</button>
                <button class="file-input" onclick="closeModal('momentModal')">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <div class="modal" id="worldbookModal">
        <div class="box">
            <div style="font-weight:700; margin-bottom:8px;">æ–°å¢ä¸–ç•Œä¹¦æ¡ç›®</div>
            <input id="worldbookTitle" placeholder="æ¡ç›®åç§°" style="width:100%; padding:10px; border:1px solid rgba(0,0,0,0.06); border-radius:8px; margin-bottom:8px;" />
            <textarea id="worldbookContent" placeholder="æ¡ç›®å†…å®¹/Prompt..." style="width:100%; padding:10px; border:1px solid rgba(0,0,0,0.06); border-radius:8px; min-height:120px;"></textarea>
            <div style="display:flex; gap:8px; margin-top:8px;">
                <button class="file-input" onclick="saveWorldbookEntry()">ä¿å­˜</button>
                <button class="file-input" onclick="closeModal('worldbookModal')">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- å…¶å®ƒæ¨¡æ€ï¼ˆå›¾ç‰‡/è¯­éŸ³/é“¾æ¥/è½¬è´¦ï¼‰ä¿æŒç®€æ´ -->
    <div class="modal" id="imageModal"><div class="box"><div style="font-weight:700;margin-bottom:8px;">å‘é€å›¾ç‰‡ï¼ˆæè¿°ï¼‰</div><input id="imageTitle" placeholder="æ ‡é¢˜" style="width:100%;padding:8px;border:1px solid rgba(0,0,0,0.06);border-radius:8px;margin-bottom:8px;"><textarea id="imageDesc" placeholder="æè¿°..." style="width:100%;padding:8px;border:1px solid rgba(0,0,0,0.06);border-radius:8px;min-height:100px;"></textarea><div style="display:flex;gap:8px;margin-top:8px;"><button class="file-input" onclick="sendImage()">å‘é€</button><button class="file-input" onclick="closeModal('imageModal')">å–æ¶ˆ</button></div></div></div>

    <div class="modal" id="voiceModal"><div class="box"><div style="font-weight:700;margin-bottom:8px;">å‘é€è¯­éŸ³ï¼ˆæ–‡å­—è½¬è¯­ï¼‰</div><input id="voiceDuration" placeholder="æ—¶é•¿ï¼ˆç§’ï¼‰" style="width:100%;padding:8px;border:1px solid rgba(0,0,0,0.06);border-radius:8px;margin-bottom:8px;"><textarea id="voiceContent" placeholder="è¯·è¾“å…¥è¦å‘é€çš„è¯­éŸ³å†…å®¹..." style="width:100%;padding:8px;border:1px solid rgba(0,0,0,0.06);border-radius:8px;min-height:100px;"></textarea><div style="display:flex;gap:8px;margin-top:8px;"><button class="file-input" onclick="sendVoice()">å‘é€</button><button class="file-input" onclick="closeModal('voiceModal')">å–æ¶ˆ</button></div></div></div>

    <div class="modal" id="linkModal"><div class="box"><div style="font-weight:700;margin-bottom:8px;">åˆ†äº«é“¾æ¥</div><input id="linkTitle" placeholder="æ ‡é¢˜" style="width:100%;padding:8px;border:1px solid rgba(0,0,0,0.06);border-radius:8px;margin-bottom:8px;"><input id="linkUrl" placeholder="é“¾æ¥åœ°å€" style="width:100%;padding:8px;border:1px solid rgba(0,0,0,0.06);border-radius:8px;margin-bottom:8px;"><textarea id="linkDesc" placeholder="æè¿°..." style="width:100%;padding:8px;border:1px solid rgba(0,0,0,0.06);border-radius:8px;min-height:80px;"></textarea><div style="display:flex;gap:8px;margin-top:8px;"><button class="file-input" onclick="sendLink()">å‘é€</button><button class="file-input" onclick="closeModal('linkModal')">å–æ¶ˆ</button></div></div></div>

    <div class="modal" id="moneyModal"><div class="box"><div style="font-weight:700;margin-bottom:8px;">è½¬è´¦ / çº¢åŒ…</div><input id="moneyAmount" placeholder="é‡‘é¢" style="width:100%;padding:8px;border:1px solid rgba(0,0,0,0.06);border-radius:8px;margin-bottom:8px;"><input id="moneyNote" placeholder="å¤‡æ³¨" style="width:100%;padding:8px;border:1px solid rgba(0,0,0,0.06);border-radius:8px;margin-bottom:8px;"><select id="moneyType" style="width:100%;padding:8px;border:1px solid rgba(0,0,0,0.06);border-radius:8px;margin-bottom:8px;"><option value="transfer">è½¬è´¦</option><option value="redpack">çº¢åŒ…</option></select><div style="display:flex;gap:8px;margin-top:8px;"><button class="file-input" onclick="sendMoney()">å‘é€</button><button class="file-input" onclick="closeModal('moneyModal')">å–æ¶ˆ</button></div></div></div>

    <input type="file" id="importFile" accept=".json" style="display:none" onchange="handleImportFile(event)">

<script>
/* ------------- çŠ¶æ€ä¸åˆå§‹æ•°æ® ------------- */
const state = {
    currentTab: 'chats',
    contacts: [],
    messages: {},
    moments: [],
    profile: { name:'æˆ‘', bio:'', avatar:'ğŸ˜Š', prompt:'' },
    appIcons: { chat:null, game:null, settings:null, theme:null },
    config: { apiProvider:'openai', apiUrl:'https://api.openai.com/v1/chat/completions', apiKey:'', modelName:'gpt-3.5-turbo', npcComments:false },
    worldbook: [], // {id,title,content}
    theme: { wallpaper:null, chatBg:null, fontUrl:null },
    cloud: { provider:'', token:'', auto:false }
};

/* å¹³å°æ£€æµ‹ï¼šå°† android class åŠ åˆ° bodyï¼ˆç”¨äºæ˜¾ç¤ºçŠ¶æ€æ ï¼‰ */
(function detectPlatform(){
    const ua = navigator.userAgent || navigator.vendor || window.opera;
    if (/android/i.test(ua)) document.body.classList.add('android');
})();

/* ------------- åˆå§‹åŒ– ------------- */
window.addEventListener('load', initApp);
function initApp(){
    loadData();
    renderHomeGrid();
    renderDockIcons();
    renderChatList();
    renderContactsList();
    renderMoments();
    updateClock();
    setInterval(updateClock, 1000);
    attachScrollBlur();
}

/* ------------- æ—¶é—´ ------------- */
function updateClock(){
    const now = new Date();
    const hhmm = now.toTimeString().slice(0,5);
    const options = { month:'numeric', day:'numeric', weekday:'long' };
    const date = now.toLocaleDateString('zh-CN', options);
    document.getElementById('currentTime').textContent = hhmm;
    document.getElementById('currentDate').textContent = date;
}

/* ------------- æ•°æ®ä¿å­˜ / è¯»å– ------------- */
function loadData(){
    try{
        const raw = localStorage.getItem('xphone_state');
        if(raw){
            const loaded = JSON.parse(raw);
            Object.assign(state, loaded);
            if(state.theme.wallpaper) setWallpaper(state.theme.wallpaper);
            if(state.theme.chatBg) setChatBg(state.theme.chatBg);
            if(state.theme.fontUrl) applyFont(state.theme.fontUrl);
        }
    }catch(e){ console.warn('load fail', e); }
    updateProfileUI();
}

function saveData(){
    try {
        localStorage.setItem('xphone_state', JSON.stringify(state));
    } catch(e) { console.warn('save fail', e); }
}

/* ------------- Home & Dock ------------- */
function renderHomeGrid(){
    const grid = document.getElementById('appGrid');
    const apps = [
        {id:'chat', label:'èŠå¤©', icon: state.appIcons.chat?.image || 'ğŸ’¬', onClick: openChatApp},
        {id:'game', label:'æ¸¸æˆ', icon: state.appIcons.game?.image || 'ğŸ®', onClick: openGameApp},
        {id:'settings', label:'è®¾ç½®', icon: state.appIcons.settings?.image || 'âš™ï¸', onClick: openSettings},
        {id:'theme', label:'ä¸»é¢˜', icon: state.appIcons.theme?.image || 'ğŸ¨', onClick: openTheme},
    ];
    grid.innerHTML = '';
    apps.forEach(a=>{
        const el = document.createElement('div');
        el.className = 'app-icon';
        el.title = a.label;
        el.onclick = a.onClick;
        if(typeof a.icon === 'string' && a.icon.startsWith('data:image')) {
            el.style.backgroundImage = `url(${a.icon})`; el.textContent='';
        } else if (typeof a.icon === 'object' && a.icon.image) {
            el.style.backgroundImage = `url(${a.icon.image})`; el.textContent='';
        } else {
            el.textContent = a.icon;
        }
        grid.appendChild(el);
    });
}

function renderDockIcons(){
    const mapping = { dock-chat:'chat', dock-game:'game', dock-settings:'settings', dock-theme:'theme' };
    Object.keys(mapping).forEach(id=>{
        const el = document.getElementById(id);
        const key = mapping[id];
        const icon = state.appIcons[key];
        if(icon && icon.image){
            el.style.backgroundImage = `url(${icon.image})`;
            el.textContent = '';
        }
    });
}

/* ------------- Wallpaper / Chat BG / Font apply ------------- */
function uploadWallpaper(e){
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = function(evt){
        setWallpaper(`url(${evt.target.result})`);
        state.theme.wallpaper = `url(${evt.target.result})`;
        saveData();
    };
    reader.readAsDataURL(file);
}
function setWallpaper(value){
    document.documentElement.style.setProperty('--bg-image', value || '#fff');
    document.body.style.background = value || '#fff';
}

function uploadChatBg(e){
    const file = e.target.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = function(evt){
        setChatBg(`url(${evt.target.result})`);
        state.theme.chatBg = `url(${evt.target.result})`;
        saveData();
    };
    reader.readAsDataURL(file);
}
function setChatBg(val){
    document.documentElement.style.setProperty('--chat-bg', val || '#fff');
}

function updateAppIcon(e){
    const file = e.target.files[0]; if(!file) return;
    const app = document.getElementById('iconAppSelect').value;
    const reader = new FileReader();
    reader.onload = function(evt){
        state.appIcons[app] = { image: evt.target.result };
    };
    reader.readAsDataURL(file);
}

function saveCustomIcon(){ saveData(); renderHomeGrid(); renderDockIcons(); goHome(); }

/* å­—ä½“åŠ è½½ï¼ˆä»…é€šè¿‡ URLï¼Œæ³¨æ„ CORSï¼‰*/
function applyFontUrl(){
    const url = document.getElementById('fontUrlInput').value.trim();
    if(!url) return alert('è¯·è¾“å…¥å­—ä½“æ–‡ä»¶ URL');
    applyFont(url);
    state.theme.fontUrl = url; saveData();
}
function applyFont(url){
    // æ¸…ç†æ—§çš„ font-face
    const existing = document.getElementById('customFontStyle');
    if(existing) existing.remove();
    const style = document.createElement('style');
    style.id = 'customFontStyle';
    style.textContent = `@font-face{ font-family: 'CustomFont'; src: url('${url}'); } body, input, textarea { font-family: 'CustomFont', -apple-system, BlinkMacSystemFont, Roboto, 'Helvetica Neue', Arial; }`;
    document.head.appendChild(style);
}
function clearCustomFont(){ const s=document.getElementById('customFontStyle'); if(s) s.remove(); state.theme.fontUrl=null; saveData(); }

/* ------------- ç•Œé¢å¯¼èˆª ------------- */
function goHome(){ closeAllScreens(); document.getElementById('appContainer').style.display='flex'; }
function closeAllScreens(){ ['chatApp','chatScreen','settingsScreen','themeScreen','gameScreen'].forEach(id=>document.getElementById(id).style.display='none'); }
function openChatApp(){ closeAllScreens(); document.getElementById('chatApp').style.display='block'; switchChatTab('chats'); }
function openSettings(){ closeAllScreens(); document.getElementById('settingsScreen').style.display='block'; renderWorldbookList(); updateSettingsUI(); }
function openTheme(){ closeAllScreens(); document.getElementById('themeScreen').style.display='block'; }
function openGameApp(){ closeAllScreens(); document.getElementById('gameScreen').style.display='block'; }
function backToChatApp(){ closeAllScreens(); document.getElementById('chatApp').style.display='block'; }

function switchChatTab(tab){
    state.currentTab = tab;
    ['chats','contacts','moments','me'].forEach(t=>{
        const v = document.getElementById(t + 'View');
        if(v) v.style.display = (t===tab)?'block':'none';
    });
    // capsule active
    document.querySelectorAll('.chat-bottom-nav .nav-item').forEach(it=>{
        it.classList.toggle('active', it.getAttribute('data-tab')===tab);
    });
}

/* ------------- chat top blur on scroll ------------- */
function attachScrollBlur(){
    const chatContent = document.getElementById('chatContent');
    chatContent.addEventListener('scroll', ()=>{
        const top = document.getElementById('chatTop');
        if(chatContent.scrollTop > 10) top.classList.add('blur'); else top.classList.remove('blur');
    });
}

/* ------------- è”ç³»äºº / èŠå¤© åˆ—è¡¨ ------------- */
function renderChatList(){
    // åœ¨èŠå¤©ä¸»è§†å›¾ä¸­æ˜¾ç¤ºæœ€è¿‘ä¼šè¯æˆ–æç¤º
    const el = document.getElementById('chatMessagesMain');
    el.innerHTML = '';
    if(Object.keys(state.messages).length===0){
        el.innerHTML = '<div style="color:#888;text-align:center;margin-top:30px;">è¿˜æ²¡æœ‰è”ç³»äººï¼Œç‚¹å‡»å³ä¸Šæ·»åŠ æˆ–å›åˆ°æ¡Œé¢æ·»åŠ </div>';
        return;
    }
    Object.keys(state.messages).forEach(cid=>{
        const msgs = state.messages[cid] || [];
        const last = msgs[msgs.length-1];
        const name = (state.contacts.find(c=>c.id===cid) || {name:cid}).name;
        const item = document.createElement('div');
        item.style.padding='10px'; item.style.borderBottom='1px solid rgba(0,0,0,0.03)'; item.style.display='flex'; item.style.justifyContent='space-between'; item.style.alignItems='center';
        item.onclick = ()=> openChatDirect(cid);
        item.innerHTML = `<div><div style="font-weight:600">${name}</div><div style="color:#888; font-size:13px;">${last?last.text.slice(0,40):'æš‚æ— æ¶ˆæ¯'}</div></div><div style="color:#aaa; font-size:12px;">${last?new Date(last.timestamp).toLocaleTimeString().slice(0,5):''}</div>`;
        el.appendChild(item);
    });
}

function renderContactsList(){
    const list = document.getElementById('contactsList');
    list.innerHTML = '';
    if(state.contacts.length===0){
        list.innerHTML = '<div style="color:#888; text-align:center; padding:20px;">æš‚æ— è”ç³»äººï¼Œç‚¹å‡»å³ä¸Š + æ·»åŠ </div>';
        return;
    }
    state.contacts.forEach(c=>{
        const row = document.createElement('div');
        row.style.display='flex'; row.style.gap='12px'; row.style.alignItems='center'; row.style.padding='10px 0'; row.style.borderBottom='1px solid rgba(0,0,0,0.03)';
        const avatar = document.createElement('div'); avatar.className='avatar';
        if(c.avatar && c.avatar.startsWith('data:image')) avatar.style.backgroundImage=`url(${c.avatar})`, avatar.textContent='';
        else avatar.textContent = c.avatar || 'ğŸ¤–';
        const info = document.createElement('div'); info.style.flex='1';
        const name = document.createElement('div'); name.style.fontWeight='600'; name.textContent = c.name;
        const status = document.createElement('div'); status.style.fontSize='13px'; status.style.color='#666'; status.textContent = generateOnlineStatus(c);
        info.appendChild(name); info.appendChild(status);
        row.appendChild(avatar); row.appendChild(info);
        row.onclick = ()=> openChatDirect(c.id);
        list.appendChild(row);
    });
}

function generateOnlineStatus(contact){
    // ç®€å•ç¤ºä¾‹ï¼šè‹¥æœ€åä¸€æ¡æ¶ˆæ¯åœ¨ 5 åˆ†é’Ÿå†… => åœ¨çº¿ï¼ˆå®é™…é€»è¾‘å¯ä»¥ç”¨ prompt / å†…å®¹åˆ†æç”Ÿæˆï¼‰
    const msgs = state.messages[contact.id] || [];
    if(msgs.length===0) return 'ç¦»çº¿';
    const last = msgs[msgs.length-1];
    const diff = Date.now() - last.timestamp;
    if(diff < 1000*60*5) return 'åœ¨çº¿';
    if(diff < 1000*60*60) return 'åˆšåˆš';
    return 'æœ€è¿‘æ´»è·ƒ';
}

/* ------------- æ·»åŠ è”ç³»äºº ------------- */
function openAddContactModal(){ document.getElementById('addContactModal').style.display='flex'; }
function confirmAddContact(){
    const name = document.getElementById('contactName').value.trim();
    const prompt = document.getElementById('contactPrompt').value.trim();
    if(!name || !prompt) return alert('è¯·å¡«å†™å§“åå’Œä¸ªæ€§ prompt');
    const id = 'c-' + Date.now();
    state.contacts.push({ id, name, avatar:'ğŸ¤–', prompt });
    state.messages[id] = [];
    saveData(); renderContactsList(); renderChatList(); closeModal('addContactModal');
}

/* ------------- æ‰“å¼€å•èŠ ------------- */
function openChatDirect(contactId){
    const contact = state.contacts.find(c=>c.id===contactId) || { id:contactId, name:'AI' };
    // å•èŠç•Œé¢ç®€ç¤º
    closeAllScreens();
    document.getElementById('chatScreen').style.display='block';
    document.getElementById('chatScreenTitle').textContent = contact.name;
    const content = document.getElementById('chatScreenContent');
    content.innerHTML = '';
    const msgs = state.messages[contactId] || [];
    msgs.forEach(m=>{
        const d = document.createElement('div');
        d.style.margin='10px 0';
        d.innerHTML = `<div class="message ${m.sender}"><div class="message-bubble">${escapeHtml(m.text)}</div></div>`;
        content.appendChild(d);
    });
}

/* ------------- æ¶ˆæ¯å‘é€é€»è¾‘ï¼šEnter æœ¬åœ°å‘é€ï¼›å‘é€é”®è§¦å‘å›å¤ ------------- */
function handleKeyPress(e){
    if(e.key === 'Enter'){
        e.preventDefault();
        sendMessageLocal();
    }
}
function sendMessageLocal(){
    const input = document.getElementById('messageInput');
    const text = input.value.trim();
    if(!text) return;
    // ä¸´æ—¶å°† message å­˜åˆ°å½“å‰ pseudo-contact "local"
    const id = 'local';
    if(!state.messages[id]) state.messages[id]=[];
    state.messages[id].push({ text, sender:'user', timestamp: Date.now() });
    saveData();
    renderChatList();
    addToChatWindow(text,'user');
    input.value = '';
}
function sendMessageWithReply(){
    const input = document.getElementById('messageInput');
    const text = input.value.trim();
    if(!text) return;
    // æœ¬åœ°å…ˆæ·»åŠ ç”¨æˆ·æ¶ˆæ¯
    addToChatWindow(text,'user');
    const id = 'local';
    if(!state.messages[id]) state.messages[id]=[];
    state.messages[id].push({ text, sender:'user', timestamp: Date.now() });
    saveData();
    input.value='';
    // å‘èµ· AI è¯·æ±‚ï¼ˆéœ€é…ç½® API Keyï¼‰
    if(!state.config.apiKey) {
        addToChatWindow('è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½® API å¯†é’¥', 'ai');
        return;
    }
    const sendIcon = document.querySelector('.send-btn');
    const original = sendIcon.innerHTML;
    sendIcon.innerHTML = 'â€¦';
    callAI(text).then(resp=>{
        addToChatWindow(resp,'ai');
        state.messages[id].push({ text:resp, sender:'ai', timestamp: Date.now() });
        saveData();
    }).catch(err=>{
        addToChatWindow('AI æœåŠ¡é”™è¯¯ï¼š' + (err.message || err), 'ai');
    }).finally(()=> sendIcon.innerHTML = original);
}

function addToChatWindow(text, sender){
    const container = document.getElementById('chatMessagesMain');
    const div = document.createElement('div');
    div.className = 'message ' + (sender==='user'?'user':'ai');
    const bubble = document.createElement('div'); bubble.className='message-bubble';
    bubble.textContent = text;
    div.appendChild(bubble);
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
}

/* ------------- AI é€šä¿¡ï¼ˆä¿ç•™åŸç»“æ„ï¼Œç®€å•åŒ…è£…ï¼‰ ------------- */
async function callAI(message){
    const body = {
        model: state.config.modelName || 'gpt-3.5-turbo',
        messages: [{ role:'user', content: message }],
        max_tokens: 800,
        temperature: 0.7
    };
    if(state.config.apiProvider === 'claude'){
        // å…¼å®¹å¤„ç†ï¼ˆç¤ºä¾‹ï¼‰
    }
    const resp = await fetch(state.config.apiUrl, {
        method:'POST',
        headers:{ 'Content-Type':'application/json', 'Authorization': 'Bearer '+state.config.apiKey },
        body: JSON.stringify(body)
    });
    if(!resp.ok) throw new Error('HTTP ' + resp.status);
    const data = await resp.json();
    // å…¼å®¹ OpenAI è¿”å›æ ¼å¼
    if(data.choices && data.choices[0] && data.choices[0].message) return data.choices[0].message.content;
    if(data.result) return data.result;
    return JSON.stringify(data);
}

/* ------------- ç‰¹æ®Šæ¶ˆæ¯çš„å‘é€ï¼ˆå›¾ç‰‡/è¯­éŸ³/é“¾æ¥/è½¬è´¦ï¼‰ ------------- */
function openImageModal(){ openModal('imageModal'); }
function openVoiceModal(){ openModal('voiceModal'); }
function openLinkModal(){ openModal('linkModal'); }
function openMoneyModal(){ openModal('moneyModal'); }

function sendImage(){
    const title = document.getElementById('imageTitle').value || 'å›¾ç‰‡';
    const desc = document.getElementById('imageDesc').value || '';
    addToChatWindow(`[å›¾ç‰‡] ${title}\n${desc}`,'user');
    closeModal('imageModal');
}
function sendVoice(){
    const d = document.getElementById('voiceDuration').value||'';
    const c = document.getElementById('voiceContent').value||'';
    addToChatWindow(`[è¯­éŸ³ ${d}s] ${c}`,'user');
    closeModal('voiceModal');
}
function sendLink(){
    const t = document.getElementById('linkTitle').value||'é“¾æ¥';
    const u = document.getElementById('linkUrl').value||'';
    addToChatWindow(`[é“¾æ¥] ${t}\n${u}`,'user');
    closeModal('linkModal');
}
function sendMoney(){
    const a = document.getElementById('moneyAmount').value||'0';
    const n = document.getElementById('moneyNote').value||'';
    addToChatWindow(`[${document.getElementById('moneyType').value}] é‡‘é¢ Â¥${a}\n${n}`,'user');
    closeModal('moneyModal');
}

/* ------------- Momentsï¼ˆæœ‹å‹åœˆï¼‰ ------------- */
function openMomentModal(){ openModal('momentModal'); }
function postMoment(){
    const text = document.getElementById('momentText').value.trim();
    if(!text) return alert('è¯·è¾“å…¥å†…å®¹');
    const m = { id:'m-'+Date.now(), author: state.profile.name || 'æˆ‘', content:text, timestamp:Date.now(), likes:[], comments:[] };
    state.moments.unshift(m);
    saveData(); renderMoments(); closeModal('momentModal');
}
function renderMoments(){
    const c = document.getElementById('momentsContainer');
    c.innerHTML = '';
    if(state.moments.length===0){ c.innerHTML='<div style="color:#888;text-align:center;">æœ‹å‹åœˆé™æ‚„æ‚„</div>'; return; }
    state.moments.forEach(m=>{
        const card = document.createElement('div'); card.className='moment-card';
        card.innerHTML = `<div class="moment-header"><div class="avatar">${m.author[0]||'æˆ‘'}</div><div><div style="font-weight:700">${m.author}</div><div style="color:#888;font-size:13px">${new Date(m.timestamp).toLocaleString()}</div></div></div>
            <div class="moment-content">${escapeHtml(m.content)}</div>
            <div class="moment-actions"><span onclick="toggleLikeMoment('${m.id}')">â¤ï¸ ${m.likes.length}</span> <span onclick="openCommentModal('${m.id}')">ğŸ’¬ ${m.comments.length}</span></div>`;
        c.appendChild(card);
    });
}

function toggleLikeMoment(id){
    const mm = state.moments.find(x=>x.id===id);
    if(!mm) return;
    const idx = mm.likes.indexOf('me');
    if(idx>-1) mm.likes.splice(idx,1); else mm.likes.push('me');
    saveData(); renderMoments();
}
function openCommentModal(id){
    const txt = prompt('è¯„è®ºå†…å®¹');
    if(!txt) return;
    const mm = state.moments.find(x=>x.id===id);
    mm.comments.push({ author: state.profile.name, content: txt, timestamp: Date.now() });
    saveData(); renderMoments();
}

/* ------------- Worldbookï¼ˆä¸–ç•Œä¹¦ï¼‰ ------------- */
function openWorldbookModal(){ openModal('worldbookModal'); }
function saveWorldbookEntry(){
    const title = document.getElementById('worldbookTitle').value.trim();
    const content = document.getElementById('worldbookContent').value.trim();
    if(!title || !content) return alert('è¯·å¡«å†™åç§°å’Œå†…å®¹');
    state.worldbook.unshift({ id:'w-'+Date.now(), title, content });
    saveData(); renderWorldbookList(); closeModal('worldbookModal');
}
function renderWorldbookList(){
    const el = document.getElementById('worldbookList');
    el.innerHTML = '';
    if(state.worldbook.length===0){ el.innerHTML='<div style="color:#888;">æœªæ·»åŠ æ¡ç›®</div>'; return; }
    state.worldbook.forEach(w=>{
        const row = document.createElement('div'); row.style.padding='8px'; row.style.borderBottom='1px solid rgba(0,0,0,0.03)';
        row.innerHTML = `<div style="font-weight:600">${w.title}</div><div style="color:#666;font-size:13px">${w.content.slice(0,120)}</div>`;
        el.appendChild(row);
    });
}
function handleWorldbookImport(e){
    const f = e.target.files[0]; if(!f) return;
    const r = new FileReader();
    r.onload = function(evt){
        try{
            const obj = JSON.parse(evt.target.result);
            if(Array.isArray(obj)) obj.forEach(it=>{ if(it.title && it.content) state.worldbook.push({ id:'w-'+Date.now()+Math.random(), title:it.title, content:it.content }); });
            else if(obj.title && obj.content) state.worldbook.push({ id:'w-'+Date.now(), title:obj.title, content:obj.content });
            else if(obj.entries && Array.isArray(obj.entries)) obj.entries.forEach(it=> state.worldbook.push({ id:'w-'+Date.now()+Math.random(), title:it.title||'unt', content:it.content||''}));
            saveData(); renderWorldbookList(); alert('å¯¼å…¥æˆåŠŸ');
        }catch(err){ alert('å¯¼å…¥å¤±è´¥ï¼š'+err.message); }
    };
    r.readAsText(f);
}

/* ------------- Settings ä¿å­˜ ------------- */
function updateApiSettings(){
    const p = document.getElementById('apiProvider').value;
    if(p==='openai'){ document.getElementById('apiUrl').value='https://api.openai.com/v1/chat/completions'; document.getElementById('modelName').value='gpt-3.5-turbo'; }
    if(p==='claude'){ document.getElementById('apiUrl').value='https://api.anthropic.com/v1/messages'; document.getElementById('modelName').value='claude-3'; }
}
function updateSettingsUI(){
    document.getElementById('apiProvider').value = state.config.apiProvider || 'openai';
    document.getElementById('apiUrl').value = state.config.apiUrl || '';
    document.getElementById('apiKey').value = state.config.apiKey || '';
    document.getElementById('modelName').value = state.config.modelName || '';
    document.getElementById('cloudProvider').value = state.cloud.provider || '';
    document.getElementById('cloudToken').value = state.cloud.token || '';
    document.getElementById('autoBackupToggle').checked = !!state.cloud.auto;
}
function saveSettings(){
    state.config.apiProvider = document.getElementById('apiProvider').value;
    state.config.apiUrl = document.getElementById('apiUrl').value;
    state.config.apiKey = document.getElementById('apiKey').value;
    state.config.modelName = document.getElementById('modelName').value;
    state.cloud.provider = document.getElementById('cloudProvider').value;
    state.cloud.token = document.getElementById('cloudToken').value;
    state.cloud.auto = document.getElementById('autoBackupToggle').checked;
    saveData();
    alert('ä¿å­˜æˆåŠŸ');
}

/* ------------- å¯¼å…¥/å¯¼å‡º æ•°æ® ------------- */
function exportData(){
    const exportObj = { state, timestamp: Date.now(), version:'1.0' };
    const blob = new Blob([JSON.stringify(exportObj, null, 2)], { type:'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = `xphone_backup_${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    alert('å¯¼å‡ºæˆåŠŸ');
}
function importData(){
    document.getElementById('importFile').click();
}
function handleImportFile(e){
    const f = e.target.files[0]; if(!f) return;
    const r = new FileReader();
    r.onload = function(evt){
        try{
            const obj = JSON.parse(evt.target.result);
            if(!obj.state) return alert('æ ¼å¼ä¸ç¬¦åˆ');
            Object.assign(state, obj.state);
            saveData(); initApp(); alert('å¯¼å…¥æˆåŠŸ');
        }catch(err){ alert('å¯¼å…¥å¤±è´¥ï¼š'+err.message); }
    };
    r.readAsText(f);
}

/* ------------- å°å·¥å…·ï¼ˆæ¨¡æ€ / UI æ›´æ–°ï¼‰ ------------- */
function openModal(id){ document.getElementById(id).style.display='flex'; }
function closeModal(id){ document.getElementById(id).style.display='none'; }
function closeAllModals(){ document.querySelectorAll('.modal').forEach(m=>m.style.display='none'); }

/* ------------- Players / Game stubs ------------- */
function openGame(type){
    alert('è¿›å…¥æ¸¸æˆ: ' + type + 'ï¼ˆè¿™é‡Œæ˜¯å ä½ç•Œé¢ï¼Œåç»­å¯ä»¥æ‰©å±•å…·ä½“ç©æ³•ï¼‰');
}

/* ------------- æ¸²æŸ“è¾…åŠ© ------------- */
function updateProfileUI(){
    document.getElementById('meName').textContent = state.profile.name || 'æˆ‘';
    document.getElementById('mePrompt').textContent = state.profile.prompt || (state.profile.bio || 'ä¸ªäºº prompt æœªè®¾ç½®');
    const av = document.getElementById('meAvatar');
    av.textContent = state.profile.avatar && !state.profile.avatar.startsWith('data:image') ? state.profile.avatar : 'ğŸ˜Š';
}

/* ------------- è¾…åŠ©å‡½æ•° ------------- */
function escapeHtml(str){ return String(str).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]); }); }

/* ------------- UI äº‹ä»¶ï¼šç‚¹å‡»ç©ºç™½å¤„å…³é—­æ¨¡æ€ ------------- */
document.addEventListener('click', function(e){
    if(e.target.classList.contains('modal')) e.target.style.display='none';
});

/* åˆå§‹åŒ–ä¸€æ¬¡æ€§ render */
renderHomeGrid();
renderDockIcons();
renderContactsList();
renderChatList();
renderMoments();

</script>
</body>
</html>