<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">

    <!-- PWAç›¸å…³metaæ ‡ç­¾ -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ç‹¸ç‹¸èŠå¤©å™¨">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="ç‹¸ç‹¸èŠå¤©å™¨">

    <!-- ä¸»é¢˜é¢œè‰² -->
    <meta name="theme-color" content="#ffffff">
    <meta name="msapplication-navbutton-color" content="#ffffff">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- é˜²æ­¢ç¼“å­˜ -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <title>ç‹¸ç‹¸èŠå¤©å™¨</title>
    <link rel="apple-touch-icon" href="https://img.remit.ee/api/file/BQACAgUAAyEGAAS-HRsPbAALeQGiurXWalX9xKJAFjN2D5-leZgIXAAJsHwACj8BxVUCgv_URGrTRNgQ.jpeg" />
    <style>
        * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
        html {
            height:100%; height:100vh; height:100dvh;
            overflow:hidden; margin:0; padding:0;
            /* iOS26é£æ ¼: ç™½åº• */
            background: var(--bg-image, #ffffff);
            background-size:cover;
            background-position:center;
            background-repeat:no-repeat;
            background-attachment: fixed;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            height:100%; height:100vh; height:100dvh;
            margin:0; padding:0; width:100vw; overflow:hidden;
            background: inherit; background-attachment:fixed;
            /* éšè—æ»šåŠ¨æ¡ */
            -ms-overflow-style: none; scrollbar-width: none;
            color: #000; /* é»˜è®¤é»‘è‰²å­—ä½“ */
        }
        body::-webkit-scrollbar { display:none; }
        /* AndroidçŠ¶æ€æ  (ä»…å®‰å“æ˜¾ç¤º) */
        .android-statusbar {
            display:none; /* é»˜è®¤éšè— */
            position: absolute; top:0; left:0; right:0; height:24px;
            background: #000; color: #fff; font-size:14px;
            display:flex; justify-content:space-between; align-items:center;
            padding:0 5px; z-index:999;
        }
        /* PWAå…¨å±é€‚é… */
        @media all and (display-mode: standalone) {
            html, body, .app-container { height:100vh !important; height:100dvh !important; min-height:100vh !important; min-height:100dvh !important; margin:0 !important; padding:0 !important; padding-bottom: env(safe-area-inset-bottom) !important; }
            html { padding-bottom: env(safe-area-inset-bottom) !important; }
            .home-screen { height:100% !important; padding-bottom: calc(150px + env(safe-area-inset-bottom)) !important; padding-top: calc(40px + env(safe-area-inset-top)) !important; box-sizing:border-box !important; }
            .theme-screen, .settings-screen, .chat-app, .chat-screen, .game-screen { height:100% !important; padding-bottom:0 !important; }
            .theme-header, .settings-header, .chat-header, .subpage-header, .chat-nav { padding-top: env(safe-area-inset-top) !important; box-sizing:border-box !important; }
            .chat-input-area { padding-bottom: env(safe-area-inset-bottom) !important; box-sizing:border-box !important; }
            .theme-content, .settings-content, .chat-list, .contacts-list, .moments-list, .profile-content, .chat-messages {
                height: calc(100% - var(--header-height, 60px) - var(--footer-height, 0px)) !important;
            }
            .dock { bottom: calc(20px + env(safe-area-inset-bottom)) !important; }
        }
        @media not all and (display-mode: standalone) {
            @supports (-webkit-touch-callout:none) {
                html { height: -webkit-fill-available; min-height: -webkit-fill-available; }
                body { height: -webkit-fill-available; min-height: -webkit-fill-available; }
                .app-container { height: -webkit-fill-available; min-height: -webkit-fill-available; }
            }
        }
        /* Dock æ  */
        .dock { position: fixed; bottom:20px; left:50%; transform:translateX(-50%); display:flex; align-items:center; justify-content:center; }
        .app-icon {
            width:50px; height:50px; margin:0 10px;
            background:rgba(255,255,255,0.8); border-radius:12px;
            font-size:24px; display:flex; align-items:center; justify-content:center;
            cursor:pointer; transition:all 0.2s ease;
        }
        .app-icon:active { transform:scale(0.9); }
        /* èŠå¤©åº•éƒ¨å¯¼èˆª */
        .chat-footer { position: fixed; bottom:20px; left:50%; transform:translateX(-50%); display:flex; align-items:center; justify-content:center; }
        .pill-nav { background:rgba(0,0,0,0.05); border-radius:30px; display:flex; padding:5px 10px; }
        .pill-item { margin:0 10px; font-size:24px; cursor:pointer; color:rgba(0,0,0,0.6); }
        .pill-item.active { color:#007AFF; }
        .floating-btn {
            position:absolute; bottom:30px; width:60px; height:60px;
            background:#007AFF; border:none; border-radius:50%;
            color:#fff; font-size:20px; cursor:pointer;
            display:flex; align-items:center; justify-content:center;
        }
        /* å­é¡µé¢å¤´éƒ¨ */
        .subpage-header {
            display:flex; align-items:center; height:var(--header-height,60px);
            padding:0 15px; font-size:18px; background:rgba(255,255,255,0.9);
            backdrop-filter: blur(10px); border-bottom:1px solid #ddd;
        }
        .subpage-header .back-btn { font-size:24px; background:none; border:none; margin-right:10px; cursor:pointer; }
        .subpage-header div { flex:1; text-align:center; font-weight:bold; }
        .subpage-header .add-contact-btn {
            font-size:24px; width:30px; height:30px; line-height:30px;
            background:#007AFF; color:#fff; border:none; border-radius:50%; cursor:pointer;
        }
        /* è”ç³»äººåˆ—è¡¨ */
        .contacts-list { padding:10px; }
        .contact-item { display:flex; align-items:center; margin:10px 0; }
        .contact-info { margin-left:10px; }
        .contact-name { font-size:16px; color:#333; }
        .contact-status { font-size:12px; color:gray; }
        /* èŠå¤©æ¶ˆæ¯åˆ—è¡¨ */
        .chat-list { padding:10px; overflow:auto; }
        .chat-item { display:flex; padding:10px; border-bottom:1px solid #eee; cursor:pointer; }
        .chat-avatar { width:40px; height:40px; border-radius:20px; background:#007AFF; color:#fff; font-size:20px; display:flex; align-items:center; justify-content:center; }
        .chat-info { margin-left:10px; }
        .chat-name { font-size:16px; color:#333; }
        .chat-preview { font-size:14px; color:gray; margin-top:2px; }
        /* æœ‹å‹åœˆåˆ—è¡¨ */
        .moments-list { padding:10px; overflow:auto; }
        .moment-item { background:#fff; padding:10px; border-radius:10px; margin-bottom:10px; box-shadow:0 1px 3px rgba(0,0,0,0.1); }
        .moment-header { display:flex; align-items:center; }
        .moment-content { margin:10px 0; color:#333; }
        .moment-actions { display:flex; font-size:14px; color:gray; }
        .moment-actions span { margin-right:15px; cursor:pointer; }
        .moment-comments { margin-top:10px; border-top:1px solid #eee; padding-top:5px; }
        .comment-item { font-size:13px; color:#333; margin:3px 0; }
        .comment-author { font-weight:bold; margin-right:5px; }
        /* èŠå¤©ç•Œé¢ */
        .chat-screen { display:none; height:100%; flex-direction:column; }
        .chat-header { display:flex; align-items:center; height:var(--header-height,60px); padding:0 15px; font-size:18px; background:rgba(255,255,255,0.9); backdrop-filter: blur(10px); }
        .chat-header .back-btn { font-size:24px; background:none; border:none; margin-right:10px; cursor:pointer; }
        .chat-title { flex:1; text-align:center; font-weight:bold; }
        .chat-messages { flex:1; padding:10px; overflow:auto; background:#f5f5f5; }
        .message { margin:5px 0; display:flex; }
        .message.user { justify-content:flex-end; }
        .message.ai { justify-content:flex-start; }
        .message-bubble { max-width:70%; padding:10px; border-radius:10px; background:#007AFF; color:#fff; }
        .message.user .message-bubble { background:#007AFF; color:#fff; }
        .message.ai .message-bubble { background:#e5e5ea; color:#000; }
        .chat-input-area { padding:10px; border-top:1px solid #ddd; background:#fff; display:flex; }
        .chat-tools { margin-right:10px; display:flex; align-items:center; }
        .tool-btn { font-size:24px; margin-right:5px; background:none; border:none; cursor:pointer; }
        .chat-input { flex:1; display:flex; }
        #messageInput { flex:1; border:1px solid #ddd; border-radius:20px; padding:8px 12px; font-size:16px; }
        .send-btn { width:40px; background:#007AFF; color:#fff; border:none; border-radius:20px; margin-left:5px; cursor:pointer; }
        .send-btn .loading { width:20px; height:20px; border:2px solid #fff; border-top-color:transparent; border-radius:50%; animation:spin 1s linear infinite; }
        @keyframes spin { to { transform:rotate(360deg); } }
        /* ä¸ªäººèµ„æ–™ */
        .profile-screen .profile-content { padding:20px; text-align:center; }
        .avatar-upload { position:relative; width:100px; height:100px; margin:0 auto 10px; }
        .profile-avatar { width:100%; height:100%; border-radius:50%; background:#007AFF; color:#fff; font-size:50px; display:flex; align-items:center; justify-content:center; cursor:pointer; }
        .profile-avatar input[type=file] { position:absolute; top:0; left:0; width:100%; height:100%; opacity:0; cursor:pointer; }
        .profile-name { font-size:20px; margin:10px 0; }
        .profile-bio { font-size:14px; color:gray; margin-bottom:20px; }
        .profile-btn { width:100%; padding:10px; background:#007AFF; color:#fff; border:none; border-radius:8px; font-size:16px; cursor:pointer; }
        .data-actions { margin-top:10px; display:flex; justify-content:space-between; }
        .data-btn { flex:1; margin:0 5px; padding:10px; background:#ccc; color:#000; border:none; border-radius:8px; font-size:14px; cursor:pointer; }
        /* æ¨¡æ€æ¡† */
        .modal { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; }
        .modal-content { background:#fff; border-radius:12px; width:80%; max-width:300px; }
        .modal-header { padding:10px; font-weight:bold; border-bottom:1px solid #eee; }
        .modal-body { padding:10px; }
        .modal-footer { padding:10px; text-align:right; }
        .modal-input { width:100%; padding:8px; margin:5px 0; border:1px solid #ddd; border-radius:4px; }
        .modal-textarea { width:100%; height:60px; padding:8px; margin:5px 0; border:1px solid #ddd; border-radius:4px; }
        .modal-buttons { display:flex; justify-content:flex-end; padding:10px; }
        .modal-btn { padding:8px 12px; margin-left:10px; border:none; border-radius:4px; cursor:pointer; }
        .modal-btn.cancel { background:#ccc; color:#000; }
        .modal-btn.confirm { background:#007AFF; color:#fff; }
        /* ä¸»é¢˜é¡µ */
        .theme-screen, .settings-screen, .home-screen, .game-screen { display:none; }
        .theme-header, .settings-header { display:flex; align-items:center; height:var(--header-height,60px); padding:0 15px; font-size:18px; background:rgba(255,255,255,0.9); backdrop-filter: blur(10px); }
        .theme-header .back-btn, .settings-header .back-btn { font-size:24px; background:none; border:none; margin-right:10px; cursor:pointer; }
        .theme-header div, .settings-header div { flex:1; text-align:center; font-weight:bold; }
        .theme-content, .settings-content { padding:15px; overflow:auto; }
        .theme-section, .settings-section { margin-bottom:20px; }
        .theme-section-title, .settings-section-title { font-size:16px; margin-bottom:10px; font-weight:bold; }
        .file-input-wrapper { margin:10px 0; }
        /* æ¸¸æˆé¡µ */
        .game-screen { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); display:none; flex-direction:column; }
        .game-screen .subpage-header { background:rgba(255,255,255,0.9); }
        .game-content { padding:15px; overflow:auto; }
        .game-section { margin-bottom:20px; }
        .game-card { width:100%; height:150px; border-radius:15px; background:#ccc; background-size:cover; background-position:center; margin-bottom:10px; }
        .gacha-button { margin-top:10px; width:100%; padding:10px; background:#FF9500; color:#fff; border:none; border-radius:8px; font-size:16px; cursor:pointer; }
    </style>
</head>
<body>
    <!-- å®‰å“çŠ¶æ€æ ï¼ˆä»…Androidæ˜¾ç¤ºï¼‰ -->
    <div class="android-statusbar" id="androidStatusBar">
        <div class="android-time" id="androidTime"></div>
        <div>
            <span id="androidSignal">ğŸ“¶</span>
            <span id="androidBattery">ğŸ”‹</span>
        </div>
    </div>

    <div class="app-container" id="appContainer">
        <!-- ä¸»å± Home -->
        <div class="home-screen" id="homeScreen" style="display:flex; flex-direction:column; align-items:center; justify-content:center;">
            <div class="time-widget">
                <div class="time" id="currentTime" style="font-size:48px; color:#000;"></div>
                <div class="date" id="currentDate" style="font-size:16px; color:gray;"></div>
            </div>
            <div class="app-grid" style="display:flex; flex-wrap:wrap; justify-content:center; margin-top:50px;">
                <!-- æ­¤å¤„å¯æ‰©å±•å…¶ä»–åº”ç”¨å›¾æ ‡ -->
            </div>
            <div class="dock">
                <div class="app-icon" id="chat-app-icon" onclick="openChatApp()">ğŸ’¬</div>
                <div class="app-icon" id="game-app-icon" onclick="openGame()">ğŸ®</div>
                <div class="app-icon" id="settings-app-icon" onclick="openSettings()">âš™ï¸</div>
                <div class="app-icon" id="theme-app-icon" onclick="openTheme()">ğŸ¨</div>
            </div>
        </div>

        <!-- èŠå¤©App -->
        <div class="chat-app" id="chatApp" style="display:none;">
            <!-- æ¶ˆæ¯é¡µ -->
            <div id="messagesPage" class="subpage" style="display:block;">
                <div class="subpage-header">
                    <button class="back-btn" onclick="goHome()">â†</button>
                    <div>æ¶ˆæ¯</div>
                </div>
                <div class="chat-list" id="chatList">
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ’¬</div>
                        <div>è¿˜æ²¡æœ‰è”ç³»äºº</div>
                        <div>ç‚¹å‡»å³ä¸‹è§’"+"æ·»åŠ AIæœ‹å‹å§</div>
                    </div>
                </div>
            </div>
            <!-- è”ç³»äººé¡µ -->
            <div id="contactsPage" class="subpage" style="display:none;">
                <div class="subpage-header">
                    <button class="back-btn" onclick="goHome()">â†</button>
                    <div>è”ç³»äºº</div>
                    <button class="add-contact-btn" onclick="openAddContactModal()">+</button>
                </div>
                <div class="contacts-list" id="contactsList">
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“‡</div>
                        <div>è¿˜æ²¡æœ‰è”ç³»äºº</div>
                        <div>ç‚¹å‡»å³ä¸Šè§’"+"æ·»åŠ AIæœ‹å‹å§</div>
                    </div>
                </div>
            </div>
            <!-- æœ‹å‹åœˆé¡µ -->
            <div id="momentsPage" class="subpage" style="display:none;">
                <div class="subpage-header">
                    <button class="back-btn" onclick="goHome()">â†</button>
                    <div>æœ‹å‹åœˆ</div>
                </div>
                <div class="moments-list" id="momentsList">
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸŒŸ</div>
                        <div>æœ‹å‹åœˆè¿˜å¾ˆå®‰é™</div>
                        <div>æ·»åŠ AIæœ‹å‹å¼€å§‹äº’åŠ¨å§</div>
                    </div>
                </div>
            </div>
            <!-- æˆ‘é¡µ -->
            <div id="profileScreen" class="subpage profile-screen" style="display:none;">
                <div class="subpage-header">
                    <button class="back-btn" onclick="goHome()">â†</button>
                    <div>æˆ‘</div>
                </div>
                <div class="profile-content">
                    <div class="avatar-upload">
                        <div class="profile-avatar" id="profileAvatar">ğŸ˜Š</div>
                        <input type="file" accept="image/*" onchange="updateProfileAvatar(event)">
                    </div>
                    <div class="profile-name" id="profileName">æˆ‘</div>
                    <div class="profile-bio" id="profileBio">è¿™ä¸ªäººå¾ˆæ‡’ï¼Œä»€ä¹ˆéƒ½æ²¡æœ‰ç•™ä¸‹...</div>
                    <div class="profile-actions">
                        <button class="profile-btn" onclick="openEditProfileModal()">ç¼–è¾‘ä¸ªäººèµ„æ–™</button>
                        <div class="data-actions">
                            <button class="data-btn" onclick="exportData()">å¯¼å‡ºæ•°æ®</button>
                            <button class="data-btn" onclick="importData()">å¯¼å…¥æ•°æ®</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- åº•éƒ¨å¯¼èˆª -->
            <div class="chat-footer">
                <div class="pill-nav">
                    <div class="pill-item nav-item active" onclick="switchTab('chats')">ğŸ’¬</div>
                    <div class="pill-item nav-item" onclick="switchTab('contacts')">ğŸ‘¥</div>
                    <div class="pill-item nav-item" onclick="switchTab('moments')">ğŸŒŸ</div>
                </div>
                <button class="floating-btn" onclick="switchTab('me')">æˆ‘</button>
            </div>
        </div>

        <!-- èŠå¤©çª—å£ -->
        <div class="chat-screen" id="chatScreen">
            <div class="chat-header">
                <button class="back-btn" onclick="backToChatApp()">â†</button>
                <div class="chat-title" id="chatTitle">AIåŠ©æ‰‹</div>
            </div>
            <div class="chat-messages" id="chatMessages"></div>
            <div class="chat-input-area">
                <div class="chat-tools">
                    <button class="tool-btn" onclick="openImageModal()">ğŸ–¼ï¸</button>
                    <button class="tool-btn" onclick="openVoiceModal()">ğŸ¤</button>
                    <button class="tool-btn" onclick="openLinkModal()">ğŸ”—</button>
                    <button class="tool-btn" onclick="openMoneyModal()">ğŸ’°</button>
                </div>
                <div class="chat-input">
                    <input type="text" id="messageInput" placeholder="è¾“å…¥æ¶ˆæ¯..." onkeypress="handleKeyPress(event)">
                    <button class="send-btn" onclick="sendMessage()">
                        <span id="sendIcon">â¤</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- è®¾ç½®é¡µ -->
        <div class="settings-screen" id="settingsScreen">
            <div class="settings-header">
                <button class="back-btn" onclick="goHome()">â†</button>
                <div>è®¾ç½®</div>
            </div>
            <div class="settings-content">
                <!-- API é…ç½® -->
                <div class="settings-section">
                    <div class="settings-section-title">API è®¾ç½®</div>
                    <div class="setting-item">
                        <label class="setting-label">API æœåŠ¡å•†</label>
                        <select id="apiProvider" onchange="updateApiSettings()">
                            <option value="openai">OpenAI</option>
                            <option value="claude">Claude</option>
                            <option value="custom">è‡ªå®šä¹‰</option>
                        </select>
                    </div>
                    <div class="setting-item">
                        <label class="setting-label">API åœ°å€</label>
                        <input type="text" id="apiUrl" placeholder="https://api.openai.com/v1/chat/completions">
                    </div>
                    <div class="setting-item">
                        <label class="setting-label">API å¯†é’¥</label>
                        <input type="password" id="apiKey" placeholder="è¾“å…¥ä½ çš„APIå¯†é’¥">
                    </div>
                    <div class="setting-item">
                        <label class="setting-label">é»˜è®¤æ¨¡å‹</label>
                        <input type="text" id="modelName" placeholder="gpt-3.5-turbo">
                    </div>
                    <div class="setting-item">
                        <label class="setting-label">NPC è¯„è®º</label>
                        <input type="checkbox" id="npcComments" onchange="toggleNpcComments()" checked>
                    </div>
                    <div class="setting-item">
                        <button onclick="saveSettings()" style="width:100%; padding:12px; background:#007AFF; color:#fff; border:none; border-radius:8px; cursor:pointer;">ä¿å­˜è®¾ç½®</button>
                    </div>
                </div>
                <!-- ä¸–ç•Œä¹¦ -->
                <div class="settings-section">
                    <div class="settings-section-title">ä¸–ç•Œä¹¦</div>
                    <div class="setting-item">
                        <input type="text" id="worldBookName" placeholder="Prompt åç§°" style="width:100%; padding:8px; margin:5px 0;">
                        <textarea id="worldBookPrompt" placeholder="Prompt å†…å®¹..." style="width:100%; padding:8px; margin:5px 0;"></textarea>
                        <button onclick="addWorldBookEntry()" style="padding:10px 20px; background:#34C759; color:#fff; border:none; border-radius:8px; cursor:pointer;">æ·»åŠ  Prompt</button>
                    </div>
                    <div id="worldBookList"></div>
                    <div class="setting-item">
                        <input type="file" id="worldBookFile" accept=".json" style="display:none;" onchange="importWorldBook(event)">
                        <button onclick="document.getElementById('worldBookFile').click()" class="modal-btn">å¯¼å…¥ WorldBook (JSON)</button>
                    </div>
                </div>
                <!-- è‡ªåŠ¨å¤‡ä»½ -->
                <div class="settings-section">
                    <div class="settings-section-title">è‡ªåŠ¨å¤‡ä»½</div>
                    <div class="setting-item">
                        <label class="setting-label">é˜¿é‡Œäº‘ç›˜ API</label>
                        <input type="text" id="aliyunApi" placeholder="å¡«å†™é˜¿é‡Œäº‘ç›˜ API ä¿¡æ¯">
                    </div>
                    <div class="setting-item">
                        <label class="setting-label">OneDrive API</label>
                        <input type="text" id="oneDriveApi" placeholder="å¡«å†™ OneDrive API ä¿¡æ¯">
                    </div>
                    <div class="setting-item">
                        <label class="setting-label">WebDAV åœ°å€</label>
                        <input type="text" id="webdavApi" placeholder="å¡«å†™ WebDAV API ä¿¡æ¯">
                    </div>
                </div>
            </div>
        </div>

        <!-- ä¸»é¢˜é¡µ -->
        <div class="theme-screen" id="themeScreen">
            <div class="theme-header">
                <button class="back-btn" onclick="goHome()">â†</button>
                <div>ä¸»é¢˜</div>
            </div>
            <div class="theme-content">
                <div class="theme-section">
                    <div class="theme-section-title">å£çº¸</div>
                    <div class="file-input-wrapper">
                        <input type="file" id="wallpaperFile" accept="image/*" onchange="uploadWallpaper(event)" style="display:none;">
                        <button onclick="document.getElementById('wallpaperFile').click()" style="padding:10px 20px; background:#007AFF; color:#fff; border:none; border-radius:8px; cursor:pointer;">ä¸Šä¼ è‡ªå®šä¹‰å£çº¸</button>
                    </div>
                    <p style="margin-top:15px; color:gray;">é€‰æ‹©ä¸€å¼ å›¾ç‰‡ä½œä¸ºXPhoneçš„å£çº¸</p>
                </div>
                <div class="theme-section">
                    <div class="theme-section-title">åº”ç”¨å›¾æ ‡</div>
                    <label class="setting-label">é€‰æ‹©åº”ç”¨</label>
                    <select class="modal-input" id="iconAppSelect">
                        <option value="chat">XChat</option>
                        <option value="game">æ¸¸æˆ</option>
                        <option value="settings">è®¾ç½®</option>
                        <option value="theme">ä¸»é¢˜</option>
                    </select>
                    <label class="setting-label">ä¸Šä¼ å›¾æ ‡</label>
                    <div class="file-input-wrapper">
                        <input type="file" id="iconImageFile" accept="image/*" onchange="updateAppIcon(event)" style="display:none;">
                        <button onclick="document.getElementById('iconImageFile').click()" style="padding:10px 20px; background:#007AFF; color:#fff; border:none; border-radius:8px; cursor:pointer;">é€‰æ‹©å›¾ç‰‡</button>
                    </div>
                    <button onclick="saveCustomIcon()" style="width:100%; padding:12px; background:#007AFF; color:white; border:none; border-radius:8px; margin-top:10px; cursor:pointer;">ä¿å­˜å›¾æ ‡</button>
                </div>
                <div class="theme-section">
                    <div class="theme-section-title">å­—ä½“</div>
                    <label class="setting-label">è‡ªå®šä¹‰å­—ä½“ (URL)</label>
                    <input type="text" id="fontUrl" placeholder="http://.../font.ttf" style="width:100%; padding:8px; margin:5px 0;">
                    <button onclick="applyFont()" style="padding:10px 20px; background:#007AFF; color:#fff; border:none; border-radius:8px; cursor:pointer;">åº”ç”¨å­—ä½“</button>
                </div>
            </div>
        </div>

        <!-- æ·»åŠ è”ç³»äººæ¨¡æ€æ¡† -->
        <div class="modal" id="addContactModal">
            <div class="modal-content">
                <div class="modal-header">æ·»åŠ AIè”ç³»äºº</div>
                <div class="modal-body">
                    <input type="text" class="modal-input" id="contactName" placeholder="è”ç³»äººå§“å">
                    <div class="avatar-upload" style="margin:15px auto;">
                        <div id="newContactAvatar" style="width:60px; height:60px; border-radius:30px; background:linear-gradient(135deg, #007AFF, #5AC8FA); display:flex; align-items:center; justify-content:center; font-size:24px; cursor:pointer; background-size:cover;">ğŸ¤–</div>
                        <input type="file" accept="image/*" onchange="updateContactAvatar(event)" style="position:absolute; opacity:0; width:60px; height:60px; cursor:pointer;">
                    </div>
                    <textarea class="modal-textarea" id="contactPrompt" placeholder="ä¸ªæ€§åŒ–promptï¼Œæè¿°è¿™ä¸ªAIçš„ç‰¹ç‚¹å’Œå›ç­”é£æ ¼..."></textarea>
                </div>
                <div class="modal-buttons">
                    <button class="modal-btn cancel" onclick="closeModal()">å–æ¶ˆ</button>
                    <button class="modal-btn confirm" onclick="addContact()">æ·»åŠ </button>
                </div>
            </div>
        </div>

        <!-- ç¼–è¾‘èµ„æ–™æ¨¡æ€æ¡† -->
        <div class="modal" id="editProfileModal">
            <div class="modal-content">
                <div class="modal-header">ç¼–è¾‘ä¸ªäººèµ„æ–™</div>
                <div class="modal-body">
                    <input type="text" class="modal-input" id="editProfileName" placeholder="æ‚¨çš„æ˜µç§°">
                    <textarea class="modal-textarea" id="editProfileBio" placeholder="ä¸ªäººç®€ä»‹..."></textarea>
                </div>
                <div class="modal-buttons">
                    <button class="modal-btn cancel" onclick="closeModal()">å–æ¶ˆ</button>
                    <button class="modal-btn confirm" onclick="saveProfile()">ä¿å­˜</button>
                </div>
            </div>
        </div>

        <!-- è¯„è®ºæ¨¡æ€æ¡† -->
        <div class="modal" id="commentModal">
            <div class="modal-content">
                <div class="modal-header">å‘è¡¨è¯„è®º</div>
                <div class="modal-body">
                    <textarea class="modal-textarea" id="commentInput" placeholder="å†™ä¸‹ä½ çš„è¯„è®º..."></textarea>
                </div>
                <div class="modal-buttons">
                    <button class="modal-btn cancel" onclick="closeModal()">å–æ¶ˆ</button>
                    <button class="modal-btn confirm" onclick="postComment()">å‘è¡¨</button>
                </div>
            </div>
        </div>

        <!-- å›¾ç‰‡æ¨¡æ€æ¡† -->
        <div class="modal" id="imageModal">
            <div class="modal-content">
                <div class="modal-header">ğŸ“¸ å‘é€å›¾ç‰‡</div>
                <div class="modal-body">
                    <input type="text" class="modal-input" id="imageTitle" placeholder="å›¾ç‰‡æ ‡é¢˜">
                    <textarea class="modal-textarea" id="imageDesc" placeholder="è¯·æè¿°è¿™å¼ å›¾ç‰‡çš„å†…å®¹..."></textarea>
                </div>
                <div class="modal-buttons">
                    <button class="modal-btn cancel" onclick="closeModal()">å–æ¶ˆ</button>
                    <button class="modal-btn confirm" onclick="sendImage()">å‘é€</button>
                </div>
            </div>
        </div>

        <!-- è¯­éŸ³æ¨¡æ€æ¡† -->
        <div class="modal" id="voiceModal">
            <div class="modal-content">
                <div class="modal-header">ğŸ¤ å‘é€è¯­éŸ³</div>
                <div class="modal-body">
                    <input type="text" class="modal-input" id="voiceDuration" placeholder="è¯­éŸ³æ—¶é•¿ï¼ˆç§’ï¼‰">
                    <textarea class="modal-textarea" id="voiceContent" placeholder="è¯·è¾“å…¥è¦å‘é€çš„è¯­éŸ³å†…å®¹..."></textarea>
                </div>
                <div class="modal-buttons">
                    <button class="modal-btn cancel" onclick="closeModal()">å–æ¶ˆ</button>
                    <button class="modal-btn confirm" onclick="sendVoice()">å‘é€</button>
                </div>
            </div>
        </div>

        <!-- é“¾æ¥æ¨¡æ€æ¡† -->
        <div class="modal" id="linkModal">
            <div class="modal-content">
                <div class="modal-header">ğŸ”— åˆ†äº«é“¾æ¥</div>
                <div class="modal-body">
                    <input type="text" class="modal-input" id="linkTitle" placeholder="é“¾æ¥æ ‡é¢˜">
                    <input type="text" class="modal-input" id="linkUrl" placeholder="é“¾æ¥åœ°å€">
                    <textarea class="modal-textarea" id="linkDesc" placeholder="é“¾æ¥æè¿°..."></textarea>
                </div>
                <div class="modal-buttons">
                    <button class="modal-btn cancel" onclick="closeModal()">å–æ¶ˆ</button>
                    <button class="modal-btn confirm" onclick="sendLink()">å‘é€</button>
                </div>
            </div>
        </div>

        <!-- è½¬è´¦æ¨¡æ€æ¡† -->
        <div class="modal" id="moneyModal">
            <div class="modal-content">
                <div class="modal-header">ğŸ’° è½¬è´¦çº¢åŒ…</div>
                <div class="modal-body">
                    <input type="number" class="modal-input" id="moneyAmount" placeholder="è½¬è´¦é‡‘é¢">
                    <input type="text" class="modal-input" id="moneyNote" placeholder="è½¬è´¦å¤‡æ³¨">
                    <select class="modal-input" id="moneyType">
                        <option value="transfer">è½¬è´¦</option>
                        <option value="redpack">çº¢åŒ…</option>
                    </select>
                </div>
                <div class="modal-buttons">
                    <button class="modal-btn cancel" onclick="closeModal()">å–æ¶ˆ</button>
                    <button class="modal-btn confirm" onclick="sendMoney()">å‘é€</button>
                </div>
            </div>
        </div>

        <!-- å¯¼å…¥æ–‡ä»¶(æ•°æ®/WorldBook) -->
        <input type="file" id="importFile" accept=".json" style="display:none;" onchange="handleImportFile(event)">
    </div>

    <script>
        const state = {
            currentContact: null,
            currentTab: 'chats',
            currentMomentId: null,
            contacts: [],
            messages: {},
            moments: [],
            profile: { name:'æˆ‘', bio:'è¿™ä¸ªäººå¾ˆæ‡’ï¼Œä»€ä¹ˆéƒ½æ²¡æœ‰ç•™ä¸‹...', avatar:'ğŸ˜Š' },
            appIcons: { chat:'ğŸ’¬', game:'ğŸ®', settings:'âš™ï¸', theme:'ğŸ¨' },
            config: {
                apiProvider:'openai',
                apiUrl:'https://api.openai.com/v1/chat/completions',
                apiKey:'',
                modelName:'gpt-3.5-turbo',
                npcComments:true,
                aliyunApi:'',
                oneDriveApi:'',
                webdavApi:''
            },
            worldBook: []
        };

        // åˆå§‹åŒ–
        function initApp() {
            loadData();
            renderChatList();
            renderContactsList();
            renderMoments();
            updateClock();
            setInterval(updateClock, 1000);
            initPWA();
            // å®‰å“æ—¶é—´
            if(navigator.userAgent.toLowerCase().includes('android')) {
                document.getElementById('androidStatusBar').style.display = 'flex';
                updateAndroidTime();
                setInterval(updateAndroidTime, 1000);
            }
        }

        // PWAåˆå§‹åŒ–
        function initPWA() {
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone || document.referrer.includes('android-app://');
            if(isStandalone) {
                document.getElementById('pwaHint').style.display = 'none';
            } else {
                showPwaHint();
            }
            window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); console.log('PWAå¯ä»¥å®‰è£…'); });
        }
        function showPwaHint(){
            const hint=document.getElementById('pwaHint');
            hint.style.display='block';
            setTimeout(()=>{ if(hint.style.display!=='none'){ hint.classList.add('hidden'); setTimeout(()=>{ hint.style.display='none';},300);} },10000);
        }
        function closePwaHint(){
            const hint=document.getElementById('pwaHint');
            hint.classList.add('hidden');
            setTimeout(()=>{ hint.style.display='none'; },300);
        }

        // åŠ è½½æœ¬åœ°å­˜å‚¨
        function loadData(){
            try {
                const profile=localStorage.getItem('xphone_profile');
                const contacts=localStorage.getItem('xphone_contacts');
                const messages=localStorage.getItem('xphone_messages');
                const moments=localStorage.getItem('xphone_moments');
                const icons=localStorage.getItem('xphone_icons');
                const config=localStorage.getItem('xphone_config');
                const wallpaper=localStorage.getItem('xphone_wallpaper');
                const font=localStorage.getItem('xphone_font');
                const worldBook=localStorage.getItem('xphone_worldbook');

                if(profile) state.profile=JSON.parse(profile);
                if(contacts) state.contacts=JSON.parse(contacts);
                if(messages) state.messages=JSON.parse(messages);
                if(moments) state.moments=JSON.parse(moments);
                if(icons) state.appIcons={...state.appIcons,...JSON.parse(icons)};
                if(config) state.config={...state.config,...JSON.parse(config)};
                if(worldBook) state.worldBook=JSON.parse(worldBook);

                // å£çº¸
                if(wallpaper && wallpaper!=='null') {
                    setWallpaper(wallpaper);
                } else {
                    document.documentElement.style.setProperty('--bg-image', '#ffffff');
                }
                // å­—ä½“
                if(font) {
                    const style = document.createElement('style');
                    style.innerHTML = `@font-face { font-family: 'CustomFont'; src: url('${font}'); } body { font-family: 'CustomFont' !important; }`;
                    document.head.appendChild(style);
                }
                updateProfileDisplay();
                updateAppIconDisplay();
                updateSettingsUI();
            } catch(e){ console.warn('æ•°æ®åŠ è½½å¤±è´¥', e); }
        }

        // æ›´æ–°æ—¶é—´å’Œæ—¥æœŸ
        function updateClock(){
            const now = new Date();
            document.getElementById('currentTime').textContent = now.toTimeString().slice(0,5);
            const options={month:'long', day:'numeric', weekday:'long'};
            document.getElementById('currentDate').textContent = now.toLocaleDateString('zh-CN', options);
        }
        function updateAndroidTime(){
            const now = new Date();
            document.getElementById('androidTime').textContent = now.toTimeString().slice(0,5);
        }

        // æ¸²æŸ“è”ç³»äººåˆ—è¡¨
        function renderContactsList(){
            const contactsList=document.getElementById('contactsList');
            contactsList.innerHTML='';
            if(state.contacts.length===0){
                contactsList.innerHTML='<div class="empty-state"><div class="empty-state-icon">ğŸ“‡</div><div>æ²¡æœ‰è”ç³»äººï¼Œå¿«æ·»åŠ ä¸€ä¸ªå§ï¼</div></div>';
                return;
            }
            state.contacts.forEach(contact=>{
                const item=document.createElement('div');
                item.className='contact-item';
                const avatarStyle = contact.avatar && contact.avatar.startsWith('data:image') ? `background-image:url(${contact.avatar}); color:transparent;` : '';
                item.innerHTML = `
                    <div class="chat-avatar" style="${avatarStyle}">${contact.avatar && !contact.avatar.startsWith('data:image') ? contact.avatar : ''}</div>
                    <div class="contact-info">
                        <div class="contact-name">${contact.name}</div>
                        <div class="contact-status">${Math.random()<0.5?'åœ¨çº¿':'ç¦»çº¿'}</div>
                    </div>`;
                contactsList.appendChild(item);
            });
        }

        // æ¸²æŸ“èŠå¤©åˆ—è¡¨
        function renderChatList(){
            const chatList=document.getElementById('chatList');
            if(state.contacts.length===0){
                chatList.innerHTML='<div class="empty-state"><div class="empty-state-icon">ğŸ’¬</div><div>è¿˜æ²¡æœ‰è”ç³»äºº</div><div>ç‚¹å‡»å³ä¸‹è§’"+"æ·»åŠ AIæœ‹å‹å§</div></div>';
                return;
            }
            chatList.innerHTML='';
            state.contacts.forEach(contact=>{
                const messages = state.messages[contact.id]||[];
                const lastMsg = messages[messages.length-1];
                const chatItem=document.createElement('div');
                chatItem.className='chat-item';
                chatItem.onclick = ()=>openChat(contact);
                const avatarStyle = contact.avatar && contact.avatar.startsWith('data:image') ? `background-image:url(${contact.avatar}); color:transparent;` : '';
                chatItem.innerHTML = `
                    <div class="chat-avatar" style="${avatarStyle}">${contact.avatar && !contact.avatar.startsWith('data:image') ? contact.avatar : ''}</div>
                    <div class="chat-info">
                        <div class="chat-name">${contact.name}</div>
                        <div class="chat-preview">${lastMsg ? (lastMsg.text.length>20 ? lastMsg.text.substring(0,20)+'...' : lastMsg.text) : 'æš‚æ— æ¶ˆæ¯'}</div>
                    </div>`;
                chatList.appendChild(chatItem);
            });
        }

        // æœ‹å‹åœˆæ¸²æŸ“
        function renderMoments(){
            const momentsList = document.getElementById('momentsList');
            if(state.moments.length===0){
                momentsList.innerHTML='<div class="empty-state"><div class="empty-state-icon">ğŸŒŸ</div><div>æœ‹å‹åœˆè¿˜å¾ˆå®‰é™</div><div>æ·»åŠ AIæœ‹å‹å¼€å§‹äº’åŠ¨å§</div></div>';
                return;
            }
            momentsList.innerHTML='';
            state.moments.forEach(moment=>{
                const momentDiv=document.createElement('div');
                momentDiv.className='moment-item';
                const avatarStyle = moment.contactAvatar && moment.contactAvatar.startsWith('data:image') ? `background-image:url(${moment.contactAvatar}); color:transparent;` : '';
                const isLiked = moment.likes.includes('user');
                const timeStr = new Date(moment.timestamp).toLocaleString();
                momentDiv.innerHTML = `
                    <div class="moment-header">
                        <div class="chat-avatar" style="${avatarStyle}">${moment.contactAvatar && !moment.contactAvatar.startsWith('data:image') ? moment.contactAvatar : ''}</div>
                        <div class="chat-info"><div class="chat-name">${moment.contactName}</div></div>
                    </div>
                    <div class="moment-content">${moment.content}</div>
                    <div class="moment-actions">
                        <span class="moment-action ${isLiked?'liked':''}" onclick="toggleLike('${moment.id}')">
                            ${isLiked?'â¤ï¸':'ğŸ¤'} ${moment.likes.length}
                        </span>
                        <span class="moment-action" onclick="openCommentModal('${moment.id}')">ğŸ’¬ ${moment.comments.length}</span>
                    </div>
                    ${moment.comments.length>0?renderComments(moment.comments):''}
                    <div class="moment-time">${timeStr}</div>`;
                momentsList.appendChild(momentDiv);
            });
        }
        function renderComments(comments){
            return `<div class="moment-comments">` + comments.map(c=>
                `<div class="comment-item"><span class="comment-author">${c.author}:</span> ${c.content}</div>`).join('') + `</div>`;
        }
        function toggleLike(id){
            const m = state.moments.find(x=>x.id===id);
            if(!m) return;
            const idx = m.likes.indexOf('user');
            if(idx>-1) m.likes.splice(idx,1);
            else m.likes.push('user');
            saveData();
            renderMoments();
        }
        function openCommentModal(id){
            state.currentMomentId=id;
            document.getElementById('commentModal').style.display='flex';
        }
        function postComment(){
            const content=document.getElementById('commentInput').value.trim();
            if(!content) return;
            const moment = state.moments.find(m=>m.id===state.currentMomentId);
            if(!moment) return;
            moment.comments.push({ author: state.profile.name, content: content, timestamp:Date.now() });
            // NPCè‡ªåŠ¨è¯„è®º
            if(state.config.npcComments){
                setTimeout(()=>{
                    moment.comments.push({ author: 'å°ç‹¸', content: 'NPCè¯„è®ºï¼š' + content, timestamp:Date.now() });
                    saveData(); renderMoments();
                }, 1000);
            }
            saveData(); renderMoments(); closeModal();
        }

        // æ‰“å¼€èŠå¤©çª—å£
        function openChat(contact){
            state.currentContact = contact;
            hideAllScreens();
            document.getElementById('chatScreen').style.display='flex';
            document.getElementById('chatTitle').textContent = contact.name;
            loadChatMessages();
        }
        function loadChatMessages(){
            const msgs=document.getElementById('chatMessages');
            msgs.innerHTML='';
            const list = state.messages[state.currentContact.id]||[];
            list.forEach(msg=> addMessage(msg.text, msg.sender, msg.isHtml));
        }
        function sendMessage(){
            const input=document.getElementById('messageInput');
            const text=input.value.trim();
            if(!text||!state.currentContact) return;
            if(!state.config.apiKey){
                addMessage('è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½®APIå¯†é’¥ï¼','ai');
                return;
            }
            addMessage(text,'user');
            saveMessage(text,'user');
            input.value='';
            document.getElementById('sendIcon').innerHTML='<div class="loading"></div>';
            callAI(text).then(res=>{
                addMessage(res,'ai'); saveMessage(res,'ai');
            }).catch(err=>{
                addMessage('AIæœåŠ¡ä¸å¯ç”¨ï¼š'+err.message,'ai'); saveMessage(err.message,'ai');
            }).finally(()=>{
                document.getElementById('sendIcon').textContent='â¤';
            });
        }
        function addMessage(text,sender,isHtml=false){
            const container=document.getElementById('chatMessages');
            const msgDiv=document.createElement('div');
            msgDiv.className='message '+sender;
            const bubble=document.createElement('div');
            bubble.className='message-bubble';
            if(isHtml) bubble.innerHTML=text;
            else bubble.textContent=text;
            msgDiv.appendChild(bubble);
            container.appendChild(msgDiv);
            container.scrollTop = container.scrollHeight;
        }
        function saveMessage(text,sender,isHtml=false){
            if(!state.messages[state.currentContact.id]) state.messages[state.currentContact.id]=[];
            state.messages[state.currentContact.id].push({ text:text, sender:sender, isHtml:isHtml, timestamp:Date.now() });
            saveData();
            renderChatList();
        }
        async function callAI(message){
            const contact = state.currentContact;
            const body = { model: state.config.modelName, messages:[
                { role:'system', content: contact.prompt },
                { role:'user', content: message }
            ], max_tokens:1000, temperature:0.7 };
            if(state.config.apiProvider==='claude'){
                Object.assign(body, { max_tokens:1000, messages:[{ role:'user', content:message }], system: contact.prompt });
            }
            const res = await fetch(state.config.apiUrl, {
                method:'POST',
                headers: { 'Content-Type':'application/json', 'Authorization':`Bearer ${state.config.apiKey}`, ...(state.config.apiProvider==='claude'&&{'anthropic-version':'2023-06-01'}) },
                body: JSON.stringify(body)
            });
            if(!res.ok) throw new Error(res.status);
            const data = await res.json();
            return state.config.apiProvider==='claude'? data.content[0].text : data.choices[0].message.content;
        }

        // ç‰¹æ®Šæ¶ˆæ¯å¤„ç† (å›¾ç‰‡/è¯­éŸ³/é“¾æ¥/çº¢åŒ…)
        function sendImage(){
            const title=document.getElementById('imageTitle').value.trim();
            const desc=document.getElementById('imageDesc').value.trim();
            if(!desc){ alert('è¯·è¾“å…¥å›¾ç‰‡æè¿°'); return; }
            const msg = `<div class="special-message image"><div class="special-message-header">ğŸ“¸ ${title||'å›¾ç‰‡'}</div><div>${desc}</div></div>`;
            addMessage(msg,'user',true);
            saveMessage(msg,'user',true);
            closeModal();
            setTimeout(()=>{
                const resp='å¥½çš„ï¼Œæˆ‘æ”¶åˆ°äº†ä½ çš„å›¾ç‰‡ä¿¡æ¯ã€‚';
                addMessage(resp,'ai'); saveMessage(resp,'ai');
            },1000);
        }
        function sendVoice(){
            const dur=document.getElementById('voiceDuration').value.trim();
            const content=document.getElementById('voiceContent').value.trim();
            if(!content){ alert('è¯·è¾“å…¥è¯­éŸ³å†…å®¹'); return; }
            const msg = `<div class="special-message voice"><div class="special-message-header">ğŸ¤ è¯­éŸ³æ¶ˆæ¯</div><div>æ—¶é•¿:${dur||'æœªçŸ¥'}ç§’<br>å†…å®¹:${content}</div></div>`;
            addMessage(msg,'user',true); saveMessage(msg,'user',true); closeModal();
            setTimeout(()=>{
                const resp='æˆ‘æ”¶åˆ°äº†ä½ çš„è¯­éŸ³æ¶ˆæ¯ï¼š'+content;
                addMessage(resp,'ai'); saveMessage(resp,'ai');
            },1000);
        }
        function sendLink(){
            const title=document.getElementById('linkTitle').value.trim();
            const url=document.getElementById('linkUrl').value.trim();
            const desc=document.getElementById('linkDesc').value.trim();
            if(!title||!url){ alert('è¯·è¾“å…¥é“¾æ¥æ ‡é¢˜å’Œåœ°å€'); return; }
            const msg = `<div class="special-message link"><div class="special-message-header">ğŸ”— ${title}</div><div>é“¾æ¥: ${url}<br>${desc?'æè¿°: '+desc:''}</div></div>`;
            addMessage(msg,'user',true); saveMessage(msg,'user',true); closeModal();
            setTimeout(()=>{
                const resp='æ„Ÿè°¢åˆ†äº«é“¾æ¥ï¼š'+title+'ï¼Œæˆ‘å·²ç»è®°å½•äº†è¿™ä¸ªä¿¡æ¯ã€‚';
                addMessage(resp,'ai'); saveMessage(resp,'ai');
            },1000);
        }
        function sendMoney(){
            const amt=document.getElementById('moneyAmount').value.trim();
            const note=document.getElementById('moneyNote').value.trim();
            const type=document.getElementById('moneyType').value;
            if(!amt){ alert('è¯·è¾“å…¥è½¬è´¦é‡‘é¢'); return; }
            const typeText = type==='redpack'?'çº¢åŒ…':'è½¬è´¦';
            const msg = `<div class="special-message money"><div class="special-message-header">ğŸ’° ${typeText}</div><div>é‡‘é¢: Â¥${amt}<br>${note?'å¤‡æ³¨: '+note:''}</div></div>`;
            addMessage(msg,'user',true); saveMessage(msg,'user',true); closeModal();
            setTimeout(()=>{
                const resp=`æ”¶åˆ°ä½ çš„${typeText}ï¼šÂ¥${amt}ï¼Œè°¢è°¢ï¼${note?'å¤‡æ³¨ï¼š'+note:''}`;
                addMessage(resp,'ai'); saveMessage(resp,'ai');
            },1000);
        }

        // ä¸ªäººèµ„æ–™ç®¡ç†
        function openEditProfileModal(){
            document.getElementById('editProfileName').value = state.profile.name;
            document.getElementById('editProfileBio').value = state.profile.bio;
            document.getElementById('editProfileModal').style.display='flex';
        }
        function saveProfile(){
            state.profile.name = document.getElementById('editProfileName').value.trim()||'æˆ‘';
            state.profile.bio = document.getElementById('editProfileBio').value.trim()||'è¿™ä¸ªäººå¾ˆæ‡’ï¼Œä»€ä¹ˆéƒ½æ²¡æœ‰ç•™ä¸‹...';
            saveData(); updateProfileDisplay(); closeModal();
        }
        function updateProfileDisplay(){
            document.getElementById('profileName').textContent = state.profile.name;
            document.getElementById('profileBio').textContent = state.profile.bio;
            const avatarEl = document.getElementById('profileAvatar');
            avatarEl.textContent = '';
            if(state.profile.avatar.startsWith('data:image')){
                avatarEl.style.backgroundImage = `url(${state.profile.avatar})`;
            } else {
                avatarEl.style.backgroundImage = '';
                avatarEl.textContent = state.profile.avatar;
            }
        }
        function updateProfileAvatar(event){
            const file=event.target.files[0];
            if(file){
                const reader=new FileReader();
                reader.onload=e=>{
                    state.profile.avatar = e.target.result;
                    saveData(); updateProfileDisplay();
                };
                reader.readAsDataURL(file);
            }
        }

        // è®¾ç½®ç®¡ç†
        function updateSettingsUI(){
            const elProvider = document.getElementById('apiProvider');
            const elUrl = document.getElementById('apiUrl');
            const elKey = document.getElementById('apiKey');
            const elModel = document.getElementById('modelName');
            elProvider.value = state.config.apiProvider;
            elUrl.value = state.config.apiUrl;
            elKey.value = state.config.apiKey;
            elModel.value = state.config.modelName;
            document.getElementById('npcComments').checked = state.config.npcComments;
            if(state.config.aliyunApi) document.getElementById('aliyunApi').value=state.config.aliyunApi;
            if(state.config.oneDriveApi) document.getElementById('oneDriveApi').value=state.config.oneDriveApi;
            if(state.config.webdavApi) document.getElementById('webdavApi').value=state.config.webdavApi;
        }
        function updateApiSettings(){
            const provider=document.getElementById('apiProvider').value;
            const urlInput=document.getElementById('apiUrl');
            const modelInput=document.getElementById('modelName');
            if(provider==='openai'){
                urlInput.value='https://api.openai.com/v1/chat/completions';
                modelInput.value='gpt-3.5-turbo';
            } else if(provider==='claude'){
                urlInput.value='https://api.anthropic.com/v1/messages';
                modelInput.value='claude-3-sonnet-20240229';
            }
        }
        function saveSettings(){
            state.config.apiProvider = document.getElementById('apiProvider').value;
            state.config.apiUrl = document.getElementById('apiUrl').value;
            state.config.apiKey = document.getElementById('apiKey').value;
            state.config.modelName = document.getElementById('modelName').value;
            state.config.npcComments = document.getElementById('npcComments').checked;
            state.config.aliyunApi = document.getElementById('aliyunApi').value;
            state.config.oneDriveApi = document.getElementById('oneDriveApi').value;
            state.config.webdavApi = document.getElementById('webdavApi').value;
            saveData();
            // æç¤ºä¿å­˜æˆåŠŸ
            alert('è®¾ç½®å·²ä¿å­˜');
        }
        function toggleNpcComments(){
            state.config.npcComments = document.getElementById('npcComments').checked;
            saveData();
        }

        // ä¸»é¢˜ç®¡ç† (å£çº¸/å›¾æ ‡/å­—ä½“)
        function uploadWallpaper(event){
            const file=event.target.files[0];
            if(file){
                const reader=new FileReader();
                reader.onload=e=>{
                    setWallpaper(`url(${e.target.result})`);
                };
                reader.readAsDataURL(file);
            }
        }
        function setWallpaper(wallpaper){
            document.documentElement.style.setProperty('--bg-image', wallpaper);
            try { localStorage.setItem('xphone_wallpaper', wallpaper); } catch(e){ console.warn('ä¿å­˜å£çº¸å¤±è´¥'); }
        }
        function updateAppIcon(event){
            const file = event.target.files[0];
            if(file){
                const reader=new FileReader();
                reader.onload=e=>{
                    const app=document.getElementById('iconAppSelect').value;
                    state.appIcons[app] = { image: e.target.result };
                };
                reader.readAsDataURL(file);
            }
        }
        function saveCustomIcon(){
            saveData();
            updateAppIconDisplay();
            goHome();
        }
        function updateAppIconDisplay(){
            const defaultEmojis = { chat:'ğŸ’¬', game:'ğŸ®', settings:'âš™ï¸', theme:'ğŸ¨' };
            Object.keys(defaultEmojis).forEach(app=>{
                const iconEl=document.getElementById(app+'-app-icon');
                if(iconEl){
                    if(state.appIcons[app] && state.appIcons[app].image){
                        iconEl.style.backgroundImage = `url(${state.appIcons[app].image})`;
                        iconEl.textContent = '';
                    } else {
                        iconEl.style.backgroundImage = '';
                        iconEl.textContent = defaultEmojis[app];
                    }
                }
            });
        }
        function applyFont(){
            const url=document.getElementById('fontUrl').value.trim();
            if(!url) return;
            const style = document.createElement('style');
            style.innerHTML = `@font-face { font-family:'CustomFont'; src:url('${url}'); } body { font-family:'CustomFont' !important; }`;
            document.head.appendChild(style);
            try { localStorage.setItem('xphone_font', url); } catch(e){ console.warn('ä¿å­˜å­—ä½“å¤±è´¥'); }
        }

        // å¯¼å‡º/å¯¼å…¥æ•°æ®
        function saveData(){
            try{
                localStorage.setItem('xphone_profile', JSON.stringify(state.profile));
                localStorage.setItem('xphone_contacts', JSON.stringify(state.contacts));
                localStorage.setItem('xphone_messages', JSON.stringify(state.messages));
                localStorage.setItem('xphone_moments', JSON.stringify(state.moments));
                localStorage.setItem('xphone_icons', JSON.stringify(state.appIcons));
                localStorage.setItem('xphone_config', JSON.stringify(state.config));
                localStorage.setItem('xphone_worldbook', JSON.stringify(state.worldBook));
            }catch(e){ console.warn('ä¿å­˜æ•°æ®å¤±è´¥', e); }
        }
        function exportData(){
            const exportObj = {
                version:'1.0',
                timestamp:Date.now(),
                contacts: state.contacts,
                messages: state.messages,
                moments: state.moments,
                profile: state.profile,
                appIcons: state.appIcons,
                config: state.config,
                worldBook: state.worldBook,
                wallpaper: localStorage.getItem('xphone_wallpaper'),
                font: localStorage.getItem('xphone_font')
            };
            const dataStr=JSON.stringify(exportObj,null,2);
            const blob=new Blob([dataStr],{type:'application/json'});
            const url=URL.createObjectURL(blob);
            const a=document.createElement('a');
            a.href=url;
            a.download=`xphone_backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a); a.click(); a.remove();
            URL.revokeObjectURL(url);
            alert('æ•°æ®å¯¼å‡ºæˆåŠŸï¼');
        }
        function importData(){
            document.getElementById('importFile').click();
        }
        function handleImportFile(event){
            const file = event.target.files[0];
            if(!file) return;
            const reader=new FileReader();
            reader.onload=e=>{
                try{
                    const data=JSON.parse(e.target.result);
                    if(!data.version) throw new Error('æ ¼å¼é”™è¯¯');
                    if(!confirm('å¯¼å…¥æ•°æ®å°†è¦†ç›–å½“å‰æ‰€æœ‰æ•°æ®ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ')) return;
                    // å¯¼å…¥æ•°æ®
                    if(data.profile) state.profile=data.profile;
                    if(data.contacts) state.contacts=data.contacts;
                    if(data.messages) state.messages=data.messages;
                    if(data.moments) state.moments=data.moments;
                    if(data.appIcons) state.appIcons=data.appIcons;
                    if(data.config) state.config=data.config;
                    if(data.worldBook) state.worldBook=data.worldBook;
                    if(data.wallpaper) localStorage.setItem('xphone_wallpaper', data.wallpaper);
                    if(data.font) localStorage.setItem('xphone_font', data.font);
                    saveData();
                    initApp();
                    alert('æ•°æ®å¯¼å…¥æˆåŠŸï¼');
                } catch(err){
                    alert('å¯¼å…¥å¤±è´¥ï¼š'+err.message);
                }
            };
            reader.readAsText(file);
        }

        // åˆ‡æ¢é¡µé¢
        function goHome(){
            hideAllScreens();
            document.getElementById('homeScreen').style.display='flex';
        }
        function openChatApp(){
            hideAllScreens();
            document.getElementById('chatApp').style.display='block';
            switchTab('chats');
        }
        function openSettings(){
            hideAllScreens();
            document.getElementById('settingsScreen').style.display='block';
        }
        function openTheme(){
            hideAllScreens();
            document.getElementById('themeScreen').style.display='block';
        }
        function openGame(){
            hideAllScreens();
            document.getElementById('gameScreen').style.display='flex';
        }
        function backToChatApp(){
            hideAllScreens();
            document.getElementById('chatApp').style.display='block';
        }
        function hideAllScreens(){
            const screens=['homeScreen','chatApp','chatScreen','settingsScreen','themeScreen','gameScreen'];
            screens.forEach(id=> document.getElementById(id).style.display='none');
        }
        function switchTab(tab){
            state.currentTab=tab;
            document.querySelectorAll('.pill-item, .floating-btn').forEach(it=>it.classList.remove('active'));
            if(tab==='chats'){
                document.querySelectorAll('.pill-item')[0].classList.add('active');
            } else if(tab==='contacts'){
                document.querySelectorAll('.pill-item')[1].classList.add('active');
            } else if(tab==='moments'){
                document.querySelectorAll('.pill-item')[2].classList.add('active');
            } else if(tab==='me'){
                document.querySelector('.floating-btn').classList.add('active');
            }
            document.getElementById('messagesPage').style.display = (tab==='chats')?'block':'none';
            document.getElementById('contactsPage').style.display = (tab==='contacts')?'block':'none';
            document.getElementById('momentsPage').style.display  = (tab==='moments')?'block':'none';
            document.getElementById('profileScreen').style.display  = (tab==='me')?'block':'none';
        }

        // æ·»åŠ è”ç³»äºº
        function openAddContactModal(){
            document.getElementById('newContactAvatar').textContent='ğŸ¤–';
            document.getElementById('newContactAvatar').style.backgroundImage='';
            document.getElementById('addContactModal').style.display='flex';
        }
        function updateContactAvatar(event){
            const file=event.target.files[0];
            if(file){
                const reader=new FileReader();
                reader.onload=e=>{
                    const avatar=document.getElementById('newContactAvatar');
                    avatar.style.backgroundImage=`url(${e.target.result})`;
                    avatar.textContent='';
                    avatar.dataset.avatarData=e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }
        function addContact(){
            const name=document.getElementById('contactName').value.trim();
            const prompt=document.getElementById('contactPrompt').value.trim();
            const avatarEl=document.getElementById('newContactAvatar');
            if(!name||!prompt){ alert('è¯·å¡«å†™è”ç³»äººå§“åå’Œä¸ªæ€§åŒ–prompt'); return; }
            const avatar = avatarEl.dataset.avatarData || 'ğŸ¤–';
            const contact={ id:'contact-'+Date.now(), name:name, avatar:avatar, prompt:prompt };
            state.contacts.push(contact);
            state.messages[contact.id]=[];
            saveData();
            generateWelcomeMoment(contact);
            renderChatList(); renderContactsList(); renderMoments();
            closeModal();
        }

        // ç”Ÿæˆæ¬¢è¿åŠ¨æ€
        function generateWelcomeMoment(contact){
            const texts=['å¾ˆé«˜å…´åŠ å…¥è¿™ä¸ªå¤§å®¶åº­ï¼æœŸå¾…ä¸å¤§å®¶çš„äº¤æµ ğŸ˜Š','æ–°äººæŠ¥åˆ°ï¼è¯·å¤šå¤šå…³ç…§ âœ¨','Hello everyone! æˆ‘æ˜¯æ–°æ¥çš„AIåŠ©æ‰‹ ğŸ‘‹','åˆšåˆšåŠ å…¥ï¼Œå¸Œæœ›èƒ½å’Œå¤§å®¶æˆä¸ºå¥½æœ‹å‹ ğŸ‰','ç¬¬ä¸€æ¬¡å‘æœ‹å‹åœˆï¼Œæœ‰ç‚¹ç´§å¼ å‘¢ ğŸ˜…'];
            const content = texts[Math.floor(Math.random()*texts.length)];
            const moment={ id:'moment-'+Date.now(), contactId:contact.id, contactName:contact.name, contactAvatar:contact.avatar, content:content, timestamp:Date.now(), likes:[], comments:[] };
            state.moments.unshift(moment); saveData();
        }

        // æ¸¸æˆåŠŸèƒ½
        function setMeowCard(){
            const url = document.getElementById('meowUrlInput').value.trim();
            if(url) document.getElementById('cardMeow').style.backgroundImage = `url(${url})`;
        }
        function setGachaCard(){
            const url = document.getElementById('gachaUrlInput').value.trim();
            if(url) document.getElementById('cardGacha').style.backgroundImage = `url(${url})`;
        }
        function drawGacha(){
            const emojis=['ğŸ‰','ğŸ','ğŸ”®','ğŸ€','ğŸ˜‚','ğŸ˜','ğŸ‘','ğŸ˜º'];
            const res=emojis[Math.floor(Math.random()*emojis.length)];
            document.getElementById('gachaResult').textContent = res;
        }

        // æ¨¡æ€æ¡†æ§åˆ¶
        function closeModal(){
            document.querySelectorAll('.modal').forEach(m=>m.style.display='none');
            document.querySelectorAll('.modal-input, .modal-textarea').forEach(inp=>inp.value='');
        }
        document.addEventListener('click', e=>{
            if(e.target.classList.contains('modal')) closeModal();
        });
        document.addEventListener('touchmove', e=>{
            if(document.querySelector('.modal[style*="flex"]')){
                e.preventDefault();
            }
        }, {passive:false});
        function handleKeyPress(event){
            if(event.key==='Enter'){ sendMessage(); }
        }

        // åˆå§‹åŒ–åº”ç”¨
        window.addEventListener('load', initApp);
    </script>
</body>
</html>