<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">

    <!-- PWA相关meta标签 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="狸狸聊天器">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="狸狸聊天器">

    <!-- 主题颜色 -->
    <meta name="theme-color" content="#ffffff">
    <meta name="msapplication-navbutton-color" content="#ffffff">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- 防止缓存 -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <title>狸狸聊天器</title>
    <link rel="apple-touch-icon" href="https://img.remit.ee/api/file/BQACAgUAAyEGAAS-HRsPbAALeQGiurXWalX9xKJAFjN2D5-leZgIXAAJsHwACj8BxVUCgv_URGrTRNgQ.jpeg" />
    <style>
        * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
        html {
            height:100%; height:100vh; height:100dvh;
            overflow:hidden; margin:0; padding:0;
            /* iOS26风格: 白底 */
            background: var(--bg-image, #ffffff);
            background-size:cover;
            background-position:center;
            background-repeat:no-repeat;
            background-attachment: fixed;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            height:100%; height:100vh; height:100dvh;
            margin:0; padding:0; width:100vw; overflow:hidden;
            background: inherit; background-attachment:fixed;
            /* 隐藏滚动条 */
            -ms-overflow-style: none; scrollbar-width: none;
            color: #000; /* 默认黑色字体 */
        }
        body::-webkit-scrollbar { display:none; }
        /* Android状态栏 (仅安卓显示) */
        .android-statusbar {
            display:none; /* 默认隐藏 */
            position: absolute; top:0; left:0; right:0; height:24px;
            background: #000; color: #fff; font-size:14px;
            display:flex; justify-content:space-between; align-items:center;
            padding:0 5px; z-index:999;
        }
        /* PWA全屏适配 */
        @media all and (display-mode: standalone) {
            html, body, .app-container { height:100vh !important; height:100dvh !important; min-height:100vh !important; min-height:100dvh !important; margin:0 !important; padding:0 !important; padding-bottom: env(safe-area-inset-bottom) !important; }
            html { padding-bottom: env(safe-area-inset-bottom) !important; }
            .home-screen { height:100% !important; padding-bottom: calc(150px + env(safe-area-inset-bottom)) !important; padding-top: calc(40px + env(safe-area-inset-top)) !important; box-sizing:border-box !important; }
            .theme-screen, .settings-screen, .chat-app, .chat-screen, .game-screen { height:100% !important; padding-bottom:0 !important; }
            .theme-header, .settings-header, .chat-header, .subpage-header, .chat-nav { padding-top: env(safe-area-inset-top) !important; box-sizing:border-box !important; }
            .chat-input-area { padding-bottom: env(safe-area-inset-bottom) !important; box-sizing:border-box !important; }
            .theme-content, .settings-content, .chat-list, .contacts-list, .moments-list, .profile-content, .chat-messages {
                height: calc(100% - var(--header-height, 60px) - var(--footer-height, 0px)) !important;
            }
            .dock { bottom: calc(20px + env(safe-area-inset-bottom)) !important; }
        }
        @media not all and (display-mode: standalone) {
            @supports (-webkit-touch-callout:none) {
                html { height: -webkit-fill-available; min-height: -webkit-fill-available; }
                body { height: -webkit-fill-available; min-height: -webkit-fill-available; }
                .app-container { height: -webkit-fill-available; min-height: -webkit-fill-available; }
            }
        }
        /* Dock 栏 */
        .dock { position: fixed; bottom:20px; left:50%; transform:translateX(-50%); display:flex; align-items:center; justify-content:center; }
        .app-icon {
            width:50px; height:50px; margin:0 10px;
            background:rgba(255,255,255,0.8); border-radius:12px;
            font-size:24px; display:flex; align-items:center; justify-content:center;
            cursor:pointer; transition:all 0.2s ease;
        }
        .app-icon:active { transform:scale(0.9); }
        /* 聊天底部导航 */
        .chat-footer { position: fixed; bottom:20px; left:50%; transform:translateX(-50%); display:flex; align-items:center; justify-content:center; }
        .pill-nav { background:rgba(0,0,0,0.05); border-radius:30px; display:flex; padding:5px 10px; }
        .pill-item { margin:0 10px; font-size:24px; cursor:pointer; color:rgba(0,0,0,0.6); }
        .pill-item.active { color:#007AFF; }
        .floating-btn {
            position:absolute; bottom:30px; width:60px; height:60px;
            background:#007AFF; border:none; border-radius:50%;
            color:#fff; font-size:20px; cursor:pointer;
            display:flex; align-items:center; justify-content:center;
        }
        /* 子页面头部 */
        .subpage-header {
            display:flex; align-items:center; height:var(--header-height,60px);
            padding:0 15px; font-size:18px; background:rgba(255,255,255,0.9);
            backdrop-filter: blur(10px); border-bottom:1px solid #ddd;
        }
        .subpage-header .back-btn { font-size:24px; background:none; border:none; margin-right:10px; cursor:pointer; }
        .subpage-header div { flex:1; text-align:center; font-weight:bold; }
        .subpage-header .add-contact-btn {
            font-size:24px; width:30px; height:30px; line-height:30px;
            background:#007AFF; color:#fff; border:none; border-radius:50%; cursor:pointer;
        }
        /* 联系人列表 */
        .contacts-list { padding:10px; }
        .contact-item { display:flex; align-items:center; margin:10px 0; }
        .contact-info { margin-left:10px; }
        .contact-name { font-size:16px; color:#333; }
        .contact-status { font-size:12px; color:gray; }
        /* 聊天消息列表 */
        .chat-list { padding:10px; overflow:auto; }
        .chat-item { display:flex; padding:10px; border-bottom:1px solid #eee; cursor:pointer; }
        .chat-avatar { width:40px; height:40px; border-radius:20px; background:#007AFF; color:#fff; font-size:20px; display:flex; align-items:center; justify-content:center; }
        .chat-info { margin-left:10px; }
        .chat-name { font-size:16px; color:#333; }
        .chat-preview { font-size:14px; color:gray; margin-top:2px; }
        /* 朋友圈列表 */
        .moments-list { padding:10px; overflow:auto; }
        .moment-item { background:#fff; padding:10px; border-radius:10px; margin-bottom:10px; box-shadow:0 1px 3px rgba(0,0,0,0.1); }
        .moment-header { display:flex; align-items:center; }
        .moment-content { margin:10px 0; color:#333; }
        .moment-actions { display:flex; font-size:14px; color:gray; }
        .moment-actions span { margin-right:15px; cursor:pointer; }
        .moment-comments { margin-top:10px; border-top:1px solid #eee; padding-top:5px; }
        .comment-item { font-size:13px; color:#333; margin:3px 0; }
        .comment-author { font-weight:bold; margin-right:5px; }
        /* 聊天界面 */
        .chat-screen { display:none; height:100%; flex-direction:column; }
        .chat-header { display:flex; align-items:center; height:var(--header-height,60px); padding:0 15px; font-size:18px; background:rgba(255,255,255,0.9); backdrop-filter: blur(10px); }
        .chat-header .back-btn { font-size:24px; background:none; border:none; margin-right:10px; cursor:pointer; }
        .chat-title { flex:1; text-align:center; font-weight:bold; }
        .chat-messages { flex:1; padding:10px; overflow:auto; background:#f5f5f5; }
        .message { margin:5px 0; display:flex; }
        .message.user { justify-content:flex-end; }
        .message.ai { justify-content:flex-start; }
        .message-bubble { max-width:70%; padding:10px; border-radius:10px; background:#007AFF; color:#fff; }
        .message.user .message-bubble { background:#007AFF; color:#fff; }
        .message.ai .message-bubble { background:#e5e5ea; color:#000; }
        .chat-input-area { padding:10px; border-top:1px solid #ddd; background:#fff; display:flex; }
        .chat-tools { margin-right:10px; display:flex; align-items:center; }
        .tool-btn { font-size:24px; margin-right:5px; background:none; border:none; cursor:pointer; }
        .chat-input { flex:1; display:flex; }
        #messageInput { flex:1; border:1px solid #ddd; border-radius:20px; padding:8px 12px; font-size:16px; }
        .send-btn { width:40px; background:#007AFF; color:#fff; border:none; border-radius:20px; margin-left:5px; cursor:pointer; }
        .send-btn .loading { width:20px; height:20px; border:2px solid #fff; border-top-color:transparent; border-radius:50%; animation:spin 1s linear infinite; }
        @keyframes spin { to { transform:rotate(360deg); } }
        /* 个人资料 */
        .profile-screen .profile-content { padding:20px; text-align:center; }
        .avatar-upload { position:relative; width:100px; height:100px; margin:0 auto 10px; }
        .profile-avatar { width:100%; height:100%; border-radius:50%; background:#007AFF; color:#fff; font-size:50px; display:flex; align-items:center; justify-content:center; cursor:pointer; }
        .profile-avatar input[type=file] { position:absolute; top:0; left:0; width:100%; height:100%; opacity:0; cursor:pointer; }
        .profile-name { font-size:20px; margin:10px 0; }
        .profile-bio { font-size:14px; color:gray; margin-bottom:20px; }
        .profile-btn { width:100%; padding:10px; background:#007AFF; color:#fff; border:none; border-radius:8px; font-size:16px; cursor:pointer; }
        .data-actions { margin-top:10px; display:flex; justify-content:space-between; }
        .data-btn { flex:1; margin:0 5px; padding:10px; background:#ccc; color:#000; border:none; border-radius:8px; font-size:14px; cursor:pointer; }
        /* 模态框 */
        .modal { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; }
        .modal-content { background:#fff; border-radius:12px; width:80%; max-width:300px; }
        .modal-header { padding:10px; font-weight:bold; border-bottom:1px solid #eee; }
        .modal-body { padding:10px; }
        .modal-footer { padding:10px; text-align:right; }
        .modal-input { width:100%; padding:8px; margin:5px 0; border:1px solid #ddd; border-radius:4px; }
        .modal-textarea { width:100%; height:60px; padding:8px; margin:5px 0; border:1px solid #ddd; border-radius:4px; }
        .modal-buttons { display:flex; justify-content:flex-end; padding:10px; }
        .modal-btn { padding:8px 12px; margin-left:10px; border:none; border-radius:4px; cursor:pointer; }
        .modal-btn.cancel { background:#ccc; color:#000; }
        .modal-btn.confirm { background:#007AFF; color:#fff; }
        /* 主题页 */
        .theme-screen, .settings-screen, .home-screen, .game-screen { display:none; }
        .theme-header, .settings-header { display:flex; align-items:center; height:var(--header-height,60px); padding:0 15px; font-size:18px; background:rgba(255,255,255,0.9); backdrop-filter: blur(10px); }
        .theme-header .back-btn, .settings-header .back-btn { font-size:24px; background:none; border:none; margin-right:10px; cursor:pointer; }
        .theme-header div, .settings-header div { flex:1; text-align:center; font-weight:bold; }
        .theme-content, .settings-content { padding:15px; overflow:auto; }
        .theme-section, .settings-section { margin-bottom:20px; }
        .theme-section-title, .settings-section-title { font-size:16px; margin-bottom:10px; font-weight:bold; }
        .file-input-wrapper { margin:10px 0; }
        /* 游戏页 */
        .game-screen { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); display:none; flex-direction:column; }
        .game-screen .subpage-header { background:rgba(255,255,255,0.9); }
        .game-content { padding:15px; overflow:auto; }
        .game-section { margin-bottom:20px; }
        .game-card { width:100%; height:150px; border-radius:15px; background:#ccc; background-size:cover; background-position:center; margin-bottom:10px; }
        .gacha-button { margin-top:10px; width:100%; padding:10px; background:#FF9500; color:#fff; border:none; border-radius:8px; font-size:16px; cursor:pointer; }
    </style>
</head>
<body>
    <!-- 安卓状态栏（仅Android显示） -->
    <div class="android-statusbar" id="androidStatusBar">
        <div class="android-time" id="androidTime"></div>
        <div>
            <span id="androidSignal">📶</span>
            <span id="androidBattery">🔋</span>
        </div>
    </div>

    <div class="app-container" id="appContainer">
        <!-- 主屏 Home -->
        <div class="home-screen" id="homeScreen" style="display:flex; flex-direction:column; align-items:center; justify-content:center;">
            <div class="time-widget">
                <div class="time" id="currentTime" style="font-size:48px; color:#000;"></div>
                <div class="date" id="currentDate" style="font-size:16px; color:gray;"></div>
            </div>
            <div class="app-grid" style="display:flex; flex-wrap:wrap; justify-content:center; margin-top:50px;">
                <!-- 此处可扩展其他应用图标 -->
            </div>
            <div class="dock">
                <div class="app-icon" id="chat-app-icon" onclick="openChatApp()">💬</div>
                <div class="app-icon" id="game-app-icon" onclick="openGame()">🎮</div>
                <div class="app-icon" id="settings-app-icon" onclick="openSettings()">⚙️</div>
                <div class="app-icon" id="theme-app-icon" onclick="openTheme()">🎨</div>
            </div>
        </div>

        <!-- 聊天App -->
        <div class="chat-app" id="chatApp" style="display:none;">
            <!-- 消息页 -->
            <div id="messagesPage" class="subpage" style="display:block;">
                <div class="subpage-header">
                    <button class="back-btn" onclick="goHome()">←</button>
                    <div>消息</div>
                </div>
                <div class="chat-list" id="chatList">
                    <div class="empty-state">
                        <div class="empty-state-icon">💬</div>
                        <div>还没有联系人</div>
                        <div>点击右下角"+"添加AI朋友吧</div>
                    </div>
                </div>
            </div>
            <!-- 联系人页 -->
            <div id="contactsPage" class="subpage" style="display:none;">
                <div class="subpage-header">
                    <button class="back-btn" onclick="goHome()">←</button>
                    <div>联系人</div>
                    <button class="add-contact-btn" onclick="openAddContactModal()">+</button>
                </div>
                <div class="contacts-list" id="contactsList">
                    <div class="empty-state">
                        <div class="empty-state-icon">📇</div>
                        <div>还没有联系人</div>
                        <div>点击右上角"+"添加AI朋友吧</div>
                    </div>
                </div>
            </div>
            <!-- 朋友圈页 -->
            <div id="momentsPage" class="subpage" style="display:none;">
                <div class="subpage-header">
                    <button class="back-btn" onclick="goHome()">←</button>
                    <div>朋友圈</div>
                </div>
                <div class="moments-list" id="momentsList">
                    <div class="empty-state">
                        <div class="empty-state-icon">🌟</div>
                        <div>朋友圈还很安静</div>
                        <div>添加AI朋友开始互动吧</div>
                    </div>
                </div>
            </div>
            <!-- 我页 -->
            <div id="profileScreen" class="subpage profile-screen" style="display:none;">
                <div class="subpage-header">
                    <button class="back-btn" onclick="goHome()">←</button>
                    <div>我</div>
                </div>
                <div class="profile-content">
                    <div class="avatar-upload">
                        <div class="profile-avatar" id="profileAvatar">😊</div>
                        <input type="file" accept="image/*" onchange="updateProfileAvatar(event)">
                    </div>
                    <div class="profile-name" id="profileName">我</div>
                    <div class="profile-bio" id="profileBio">这个人很懒，什么都没有留下...</div>
                    <div class="profile-actions">
                        <button class="profile-btn" onclick="openEditProfileModal()">编辑个人资料</button>
                        <div class="data-actions">
                            <button class="data-btn" onclick="exportData()">导出数据</button>
                            <button class="data-btn" onclick="importData()">导入数据</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 底部导航 -->
            <div class="chat-footer">
                <div class="pill-nav">
                    <div class="pill-item nav-item active" onclick="switchTab('chats')">💬</div>
                    <div class="pill-item nav-item" onclick="switchTab('contacts')">👥</div>
                    <div class="pill-item nav-item" onclick="switchTab('moments')">🌟</div>
                </div>
                <button class="floating-btn" onclick="switchTab('me')">我</button>
            </div>
        </div>

        <!-- 聊天窗口 -->
        <div class="chat-screen" id="chatScreen">
            <div class="chat-header">
                <button class="back-btn" onclick="backToChatApp()">←</button>
                <div class="chat-title" id="chatTitle">AI助手</div>
            </div>
            <div class="chat-messages" id="chatMessages"></div>
            <div class="chat-input-area">
                <div class="chat-tools">
                    <button class="tool-btn" onclick="openImageModal()">🖼️</button>
                    <button class="tool-btn" onclick="openVoiceModal()">🎤</button>
                    <button class="tool-btn" onclick="openLinkModal()">🔗</button>
                    <button class="tool-btn" onclick="openMoneyModal()">💰</button>
                </div>
                <div class="chat-input">
                    <input type="text" id="messageInput" placeholder="输入消息..." onkeypress="handleKeyPress(event)">
                    <button class="send-btn" onclick="sendMessage()">
                        <span id="sendIcon">➤</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- 设置页 -->
        <div class="settings-screen" id="settingsScreen">
            <div class="settings-header">
                <button class="back-btn" onclick="goHome()">←</button>
                <div>设置</div>
            </div>
            <div class="settings-content">
                <!-- API 配置 -->
                <div class="settings-section">
                    <div class="settings-section-title">API 设置</div>
                    <div class="setting-item">
                        <label class="setting-label">API 服务商</label>
                        <select id="apiProvider" onchange="updateApiSettings()">
                            <option value="openai">OpenAI</option>
                            <option value="claude">Claude</option>
                            <option value="custom">自定义</option>
                        </select>
                    </div>
                    <div class="setting-item">
                        <label class="setting-label">API 地址</label>
                        <input type="text" id="apiUrl" placeholder="https://api.openai.com/v1/chat/completions">
                    </div>
                    <div class="setting-item">
                        <label class="setting-label">API 密钥</label>
                        <input type="password" id="apiKey" placeholder="输入你的API密钥">
                    </div>
                    <div class="setting-item">
                        <label class="setting-label">默认模型</label>
                        <input type="text" id="modelName" placeholder="gpt-3.5-turbo">
                    </div>
                    <div class="setting-item">
                        <label class="setting-label">NPC 评论</label>
                        <input type="checkbox" id="npcComments" onchange="toggleNpcComments()" checked>
                    </div>
                    <div class="setting-item">
                        <button onclick="saveSettings()" style="width:100%; padding:12px; background:#007AFF; color:#fff; border:none; border-radius:8px; cursor:pointer;">保存设置</button>
                    </div>
                </div>
                <!-- 世界书 -->
                <div class="settings-section">
                    <div class="settings-section-title">世界书</div>
                    <div class="setting-item">
                        <input type="text" id="worldBookName" placeholder="Prompt 名称" style="width:100%; padding:8px; margin:5px 0;">
                        <textarea id="worldBookPrompt" placeholder="Prompt 内容..." style="width:100%; padding:8px; margin:5px 0;"></textarea>
                        <button onclick="addWorldBookEntry()" style="padding:10px 20px; background:#34C759; color:#fff; border:none; border-radius:8px; cursor:pointer;">添加 Prompt</button>
                    </div>
                    <div id="worldBookList"></div>
                    <div class="setting-item">
                        <input type="file" id="worldBookFile" accept=".json" style="display:none;" onchange="importWorldBook(event)">
                        <button onclick="document.getElementById('worldBookFile').click()" class="modal-btn">导入 WorldBook (JSON)</button>
                    </div>
                </div>
                <!-- 自动备份 -->
                <div class="settings-section">
                    <div class="settings-section-title">自动备份</div>
                    <div class="setting-item">
                        <label class="setting-label">阿里云盘 API</label>
                        <input type="text" id="aliyunApi" placeholder="填写阿里云盘 API 信息">
                    </div>
                    <div class="setting-item">
                        <label class="setting-label">OneDrive API</label>
                        <input type="text" id="oneDriveApi" placeholder="填写 OneDrive API 信息">
                    </div>
                    <div class="setting-item">
                        <label class="setting-label">WebDAV 地址</label>
                        <input type="text" id="webdavApi" placeholder="填写 WebDAV API 信息">
                    </div>
                </div>
            </div>
        </div>

        <!-- 主题页 -->
        <div class="theme-screen" id="themeScreen">
            <div class="theme-header">
                <button class="back-btn" onclick="goHome()">←</button>
                <div>主题</div>
            </div>
            <div class="theme-content">
                <div class="theme-section">
                    <div class="theme-section-title">壁纸</div>
                    <div class="file-input-wrapper">
                        <input type="file" id="wallpaperFile" accept="image/*" onchange="uploadWallpaper(event)" style="display:none;">
                        <button onclick="document.getElementById('wallpaperFile').click()" style="padding:10px 20px; background:#007AFF; color:#fff; border:none; border-radius:8px; cursor:pointer;">上传自定义壁纸</button>
                    </div>
                    <p style="margin-top:15px; color:gray;">选择一张图片作为XPhone的壁纸</p>
                </div>
                <div class="theme-section">
                    <div class="theme-section-title">应用图标</div>
                    <label class="setting-label">选择应用</label>
                    <select class="modal-input" id="iconAppSelect">
                        <option value="chat">XChat</option>
                        <option value="game">游戏</option>
                        <option value="settings">设置</option>
                        <option value="theme">主题</option>
                    </select>
                    <label class="setting-label">上传图标</label>
                    <div class="file-input-wrapper">
                        <input type="file" id="iconImageFile" accept="image/*" onchange="updateAppIcon(event)" style="display:none;">
                        <button onclick="document.getElementById('iconImageFile').click()" style="padding:10px 20px; background:#007AFF; color:#fff; border:none; border-radius:8px; cursor:pointer;">选择图片</button>
                    </div>
                    <button onclick="saveCustomIcon()" style="width:100%; padding:12px; background:#007AFF; color:white; border:none; border-radius:8px; margin-top:10px; cursor:pointer;">保存图标</button>
                </div>
                <div class="theme-section">
                    <div class="theme-section-title">字体</div>
                    <label class="setting-label">自定义字体 (URL)</label>
                    <input type="text" id="fontUrl" placeholder="http://.../font.ttf" style="width:100%; padding:8px; margin:5px 0;">
                    <button onclick="applyFont()" style="padding:10px 20px; background:#007AFF; color:#fff; border:none; border-radius:8px; cursor:pointer;">应用字体</button>
                </div>
            </div>
        </div>

        <!-- 添加联系人模态框 -->
        <div class="modal" id="addContactModal">
            <div class="modal-content">
                <div class="modal-header">添加AI联系人</div>
                <div class="modal-body">
                    <input type="text" class="modal-input" id="contactName" placeholder="联系人姓名">
                    <div class="avatar-upload" style="margin:15px auto;">
                        <div id="newContactAvatar" style="width:60px; height:60px; border-radius:30px; background:linear-gradient(135deg, #007AFF, #5AC8FA); display:flex; align-items:center; justify-content:center; font-size:24px; cursor:pointer; background-size:cover;">🤖</div>
                        <input type="file" accept="image/*" onchange="updateContactAvatar(event)" style="position:absolute; opacity:0; width:60px; height:60px; cursor:pointer;">
                    </div>
                    <textarea class="modal-textarea" id="contactPrompt" placeholder="个性化prompt，描述这个AI的特点和回答风格..."></textarea>
                </div>
                <div class="modal-buttons">
                    <button class="modal-btn cancel" onclick="closeModal()">取消</button>
                    <button class="modal-btn confirm" onclick="addContact()">添加</button>
                </div>
            </div>
        </div>

        <!-- 编辑资料模态框 -->
        <div class="modal" id="editProfileModal">
            <div class="modal-content">
                <div class="modal-header">编辑个人资料</div>
                <div class="modal-body">
                    <input type="text" class="modal-input" id="editProfileName" placeholder="您的昵称">
                    <textarea class="modal-textarea" id="editProfileBio" placeholder="个人简介..."></textarea>
                </div>
                <div class="modal-buttons">
                    <button class="modal-btn cancel" onclick="closeModal()">取消</button>
                    <button class="modal-btn confirm" onclick="saveProfile()">保存</button>
                </div>
            </div>
        </div>

        <!-- 评论模态框 -->
        <div class="modal" id="commentModal">
            <div class="modal-content">
                <div class="modal-header">发表评论</div>
                <div class="modal-body">
                    <textarea class="modal-textarea" id="commentInput" placeholder="写下你的评论..."></textarea>
                </div>
                <div class="modal-buttons">
                    <button class="modal-btn cancel" onclick="closeModal()">取消</button>
                    <button class="modal-btn confirm" onclick="postComment()">发表</button>
                </div>
            </div>
        </div>

        <!-- 图片模态框 -->
        <div class="modal" id="imageModal">
            <div class="modal-content">
                <div class="modal-header">📸 发送图片</div>
                <div class="modal-body">
                    <input type="text" class="modal-input" id="imageTitle" placeholder="图片标题">
                    <textarea class="modal-textarea" id="imageDesc" placeholder="请描述这张图片的内容..."></textarea>
                </div>
                <div class="modal-buttons">
                    <button class="modal-btn cancel" onclick="closeModal()">取消</button>
                    <button class="modal-btn confirm" onclick="sendImage()">发送</button>
                </div>
            </div>
        </div>

        <!-- 语音模态框 -->
        <div class="modal" id="voiceModal">
            <div class="modal-content">
                <div class="modal-header">🎤 发送语音</div>
                <div class="modal-body">
                    <input type="text" class="modal-input" id="voiceDuration" placeholder="语音时长（秒）">
                    <textarea class="modal-textarea" id="voiceContent" placeholder="请输入要发送的语音内容..."></textarea>
                </div>
                <div class="modal-buttons">
                    <button class="modal-btn cancel" onclick="closeModal()">取消</button>
                    <button class="modal-btn confirm" onclick="sendVoice()">发送</button>
                </div>
            </div>
        </div>

        <!-- 链接模态框 -->
        <div class="modal" id="linkModal">
            <div class="modal-content">
                <div class="modal-header">🔗 分享链接</div>
                <div class="modal-body">
                    <input type="text" class="modal-input" id="linkTitle" placeholder="链接标题">
                    <input type="text" class="modal-input" id="linkUrl" placeholder="链接地址">
                    <textarea class="modal-textarea" id="linkDesc" placeholder="链接描述..."></textarea>
                </div>
                <div class="modal-buttons">
                    <button class="modal-btn cancel" onclick="closeModal()">取消</button>
                    <button class="modal-btn confirm" onclick="sendLink()">发送</button>
                </div>
            </div>
        </div>

        <!-- 转账模态框 -->
        <div class="modal" id="moneyModal">
            <div class="modal-content">
                <div class="modal-header">💰 转账红包</div>
                <div class="modal-body">
                    <input type="number" class="modal-input" id="moneyAmount" placeholder="转账金额">
                    <input type="text" class="modal-input" id="moneyNote" placeholder="转账备注">
                    <select class="modal-input" id="moneyType">
                        <option value="transfer">转账</option>
                        <option value="redpack">红包</option>
                    </select>
                </div>
                <div class="modal-buttons">
                    <button class="modal-btn cancel" onclick="closeModal()">取消</button>
                    <button class="modal-btn confirm" onclick="sendMoney()">发送</button>
                </div>
            </div>
        </div>

        <!-- 导入文件(数据/WorldBook) -->
        <input type="file" id="importFile" accept=".json" style="display:none;" onchange="handleImportFile(event)">
    </div>

    <script>
        const state = {
            currentContact: null,
            currentTab: 'chats',
            currentMomentId: null,
            contacts: [],
            messages: {},
            moments: [],
            profile: { name:'我', bio:'这个人很懒，什么都没有留下...', avatar:'😊' },
            appIcons: { chat:'💬', game:'🎮', settings:'⚙️', theme:'🎨' },
            config: {
                apiProvider:'openai',
                apiUrl:'https://api.openai.com/v1/chat/completions',
                apiKey:'',
                modelName:'gpt-3.5-turbo',
                npcComments:true,
                aliyunApi:'',
                oneDriveApi:'',
                webdavApi:''
            },
            worldBook: []
        };

        // 初始化
        function initApp() {
            loadData();
            renderChatList();
            renderContactsList();
            renderMoments();
            updateClock();
            setInterval(updateClock, 1000);
            initPWA();
            // 安卓时间
            if(navigator.userAgent.toLowerCase().includes('android')) {
                document.getElementById('androidStatusBar').style.display = 'flex';
                updateAndroidTime();
                setInterval(updateAndroidTime, 1000);
            }
        }

        // PWA初始化
        function initPWA() {
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone || document.referrer.includes('android-app://');
            if(isStandalone) {
                document.getElementById('pwaHint').style.display = 'none';
            } else {
                showPwaHint();
            }
            window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); console.log('PWA可以安装'); });
        }
        function showPwaHint(){
            const hint=document.getElementById('pwaHint');
            hint.style.display='block';
            setTimeout(()=>{ if(hint.style.display!=='none'){ hint.classList.add('hidden'); setTimeout(()=>{ hint.style.display='none';},300);} },10000);
        }
        function closePwaHint(){
            const hint=document.getElementById('pwaHint');
            hint.classList.add('hidden');
            setTimeout(()=>{ hint.style.display='none'; },300);
        }

        // 加载本地存储
        function loadData(){
            try {
                const profile=localStorage.getItem('xphone_profile');
                const contacts=localStorage.getItem('xphone_contacts');
                const messages=localStorage.getItem('xphone_messages');
                const moments=localStorage.getItem('xphone_moments');
                const icons=localStorage.getItem('xphone_icons');
                const config=localStorage.getItem('xphone_config');
                const wallpaper=localStorage.getItem('xphone_wallpaper');
                const font=localStorage.getItem('xphone_font');
                const worldBook=localStorage.getItem('xphone_worldbook');

                if(profile) state.profile=JSON.parse(profile);
                if(contacts) state.contacts=JSON.parse(contacts);
                if(messages) state.messages=JSON.parse(messages);
                if(moments) state.moments=JSON.parse(moments);
                if(icons) state.appIcons={...state.appIcons,...JSON.parse(icons)};
                if(config) state.config={...state.config,...JSON.parse(config)};
                if(worldBook) state.worldBook=JSON.parse(worldBook);

                // 壁纸
                if(wallpaper && wallpaper!=='null') {
                    setWallpaper(wallpaper);
                } else {
                    document.documentElement.style.setProperty('--bg-image', '#ffffff');
                }
                // 字体
                if(font) {
                    const style = document.createElement('style');
                    style.innerHTML = `@font-face { font-family: 'CustomFont'; src: url('${font}'); } body { font-family: 'CustomFont' !important; }`;
                    document.head.appendChild(style);
                }
                updateProfileDisplay();
                updateAppIconDisplay();
                updateSettingsUI();
            } catch(e){ console.warn('数据加载失败', e); }
        }

        // 更新时间和日期
        function updateClock(){
            const now = new Date();
            document.getElementById('currentTime').textContent = now.toTimeString().slice(0,5);
            const options={month:'long', day:'numeric', weekday:'long'};
            document.getElementById('currentDate').textContent = now.toLocaleDateString('zh-CN', options);
        }
        function updateAndroidTime(){
            const now = new Date();
            document.getElementById('androidTime').textContent = now.toTimeString().slice(0,5);
        }

        // 渲染联系人列表
        function renderContactsList(){
            const contactsList=document.getElementById('contactsList');
            contactsList.innerHTML='';
            if(state.contacts.length===0){
                contactsList.innerHTML='<div class="empty-state"><div class="empty-state-icon">📇</div><div>没有联系人，快添加一个吧！</div></div>';
                return;
            }
            state.contacts.forEach(contact=>{
                const item=document.createElement('div');
                item.className='contact-item';
                const avatarStyle = contact.avatar && contact.avatar.startsWith('data:image') ? `background-image:url(${contact.avatar}); color:transparent;` : '';
                item.innerHTML = `
                    <div class="chat-avatar" style="${avatarStyle}">${contact.avatar && !contact.avatar.startsWith('data:image') ? contact.avatar : ''}</div>
                    <div class="contact-info">
                        <div class="contact-name">${contact.name}</div>
                        <div class="contact-status">${Math.random()<0.5?'在线':'离线'}</div>
                    </div>`;
                contactsList.appendChild(item);
            });
        }

        // 渲染聊天列表
        function renderChatList(){
            const chatList=document.getElementById('chatList');
            if(state.contacts.length===0){
                chatList.innerHTML='<div class="empty-state"><div class="empty-state-icon">💬</div><div>还没有联系人</div><div>点击右下角"+"添加AI朋友吧</div></div>';
                return;
            }
            chatList.innerHTML='';
            state.contacts.forEach(contact=>{
                const messages = state.messages[contact.id]||[];
                const lastMsg = messages[messages.length-1];
                const chatItem=document.createElement('div');
                chatItem.className='chat-item';
                chatItem.onclick = ()=>openChat(contact);
                const avatarStyle = contact.avatar && contact.avatar.startsWith('data:image') ? `background-image:url(${contact.avatar}); color:transparent;` : '';
                chatItem.innerHTML = `
                    <div class="chat-avatar" style="${avatarStyle}">${contact.avatar && !contact.avatar.startsWith('data:image') ? contact.avatar : ''}</div>
                    <div class="chat-info">
                        <div class="chat-name">${contact.name}</div>
                        <div class="chat-preview">${lastMsg ? (lastMsg.text.length>20 ? lastMsg.text.substring(0,20)+'...' : lastMsg.text) : '暂无消息'}</div>
                    </div>`;
                chatList.appendChild(chatItem);
            });
        }

        // 朋友圈渲染
        function renderMoments(){
            const momentsList = document.getElementById('momentsList');
            if(state.moments.length===0){
                momentsList.innerHTML='<div class="empty-state"><div class="empty-state-icon">🌟</div><div>朋友圈还很安静</div><div>添加AI朋友开始互动吧</div></div>';
                return;
            }
            momentsList.innerHTML='';
            state.moments.forEach(moment=>{
                const momentDiv=document.createElement('div');
                momentDiv.className='moment-item';
                const avatarStyle = moment.contactAvatar && moment.contactAvatar.startsWith('data:image') ? `background-image:url(${moment.contactAvatar}); color:transparent;` : '';
                const isLiked = moment.likes.includes('user');
                const timeStr = new Date(moment.timestamp).toLocaleString();
                momentDiv.innerHTML = `
                    <div class="moment-header">
                        <div class="chat-avatar" style="${avatarStyle}">${moment.contactAvatar && !moment.contactAvatar.startsWith('data:image') ? moment.contactAvatar : ''}</div>
                        <div class="chat-info"><div class="chat-name">${moment.contactName}</div></div>
                    </div>
                    <div class="moment-content">${moment.content}</div>
                    <div class="moment-actions">
                        <span class="moment-action ${isLiked?'liked':''}" onclick="toggleLike('${moment.id}')">
                            ${isLiked?'❤️':'🤍'} ${moment.likes.length}
                        </span>
                        <span class="moment-action" onclick="openCommentModal('${moment.id}')">💬 ${moment.comments.length}</span>
                    </div>
                    ${moment.comments.length>0?renderComments(moment.comments):''}
                    <div class="moment-time">${timeStr}</div>`;
                momentsList.appendChild(momentDiv);
            });
        }
        function renderComments(comments){
            return `<div class="moment-comments">` + comments.map(c=>
                `<div class="comment-item"><span class="comment-author">${c.author}:</span> ${c.content}</div>`).join('') + `</div>`;
        }
        function toggleLike(id){
            const m = state.moments.find(x=>x.id===id);
            if(!m) return;
            const idx = m.likes.indexOf('user');
            if(idx>-1) m.likes.splice(idx,1);
            else m.likes.push('user');
            saveData();
            renderMoments();
        }
        function openCommentModal(id){
            state.currentMomentId=id;
            document.getElementById('commentModal').style.display='flex';
        }
        function postComment(){
            const content=document.getElementById('commentInput').value.trim();
            if(!content) return;
            const moment = state.moments.find(m=>m.id===state.currentMomentId);
            if(!moment) return;
            moment.comments.push({ author: state.profile.name, content: content, timestamp:Date.now() });
            // NPC自动评论
            if(state.config.npcComments){
                setTimeout(()=>{
                    moment.comments.push({ author: '小狸', content: 'NPC评论：' + content, timestamp:Date.now() });
                    saveData(); renderMoments();
                }, 1000);
            }
            saveData(); renderMoments(); closeModal();
        }

        // 打开聊天窗口
        function openChat(contact){
            state.currentContact = contact;
            hideAllScreens();
            document.getElementById('chatScreen').style.display='flex';
            document.getElementById('chatTitle').textContent = contact.name;
            loadChatMessages();
        }
        function loadChatMessages(){
            const msgs=document.getElementById('chatMessages');
            msgs.innerHTML='';
            const list = state.messages[state.currentContact.id]||[];
            list.forEach(msg=> addMessage(msg.text, msg.sender, msg.isHtml));
        }
        function sendMessage(){
            const input=document.getElementById('messageInput');
            const text=input.value.trim();
            if(!text||!state.currentContact) return;
            if(!state.config.apiKey){
                addMessage('请先在设置中配置API密钥！','ai');
                return;
            }
            addMessage(text,'user');
            saveMessage(text,'user');
            input.value='';
            document.getElementById('sendIcon').innerHTML='<div class="loading"></div>';
            callAI(text).then(res=>{
                addMessage(res,'ai'); saveMessage(res,'ai');
            }).catch(err=>{
                addMessage('AI服务不可用：'+err.message,'ai'); saveMessage(err.message,'ai');
            }).finally(()=>{
                document.getElementById('sendIcon').textContent='➤';
            });
        }
        function addMessage(text,sender,isHtml=false){
            const container=document.getElementById('chatMessages');
            const msgDiv=document.createElement('div');
            msgDiv.className='message '+sender;
            const bubble=document.createElement('div');
            bubble.className='message-bubble';
            if(isHtml) bubble.innerHTML=text;
            else bubble.textContent=text;
            msgDiv.appendChild(bubble);
            container.appendChild(msgDiv);
            container.scrollTop = container.scrollHeight;
        }
        function saveMessage(text,sender,isHtml=false){
            if(!state.messages[state.currentContact.id]) state.messages[state.currentContact.id]=[];
            state.messages[state.currentContact.id].push({ text:text, sender:sender, isHtml:isHtml, timestamp:Date.now() });
            saveData();
            renderChatList();
        }
        async function callAI(message){
            const contact = state.currentContact;
            const body = { model: state.config.modelName, messages:[
                { role:'system', content: contact.prompt },
                { role:'user', content: message }
            ], max_tokens:1000, temperature:0.7 };
            if(state.config.apiProvider==='claude'){
                Object.assign(body, { max_tokens:1000, messages:[{ role:'user', content:message }], system: contact.prompt });
            }
            const res = await fetch(state.config.apiUrl, {
                method:'POST',
                headers: { 'Content-Type':'application/json', 'Authorization':`Bearer ${state.config.apiKey}`, ...(state.config.apiProvider==='claude'&&{'anthropic-version':'2023-06-01'}) },
                body: JSON.stringify(body)
            });
            if(!res.ok) throw new Error(res.status);
            const data = await res.json();
            return state.config.apiProvider==='claude'? data.content[0].text : data.choices[0].message.content;
        }

        // 特殊消息处理 (图片/语音/链接/红包)
        function sendImage(){
            const title=document.getElementById('imageTitle').value.trim();
            const desc=document.getElementById('imageDesc').value.trim();
            if(!desc){ alert('请输入图片描述'); return; }
            const msg = `<div class="special-message image"><div class="special-message-header">📸 ${title||'图片'}</div><div>${desc}</div></div>`;
            addMessage(msg,'user',true);
            saveMessage(msg,'user',true);
            closeModal();
            setTimeout(()=>{
                const resp='好的，我收到了你的图片信息。';
                addMessage(resp,'ai'); saveMessage(resp,'ai');
            },1000);
        }
        function sendVoice(){
            const dur=document.getElementById('voiceDuration').value.trim();
            const content=document.getElementById('voiceContent').value.trim();
            if(!content){ alert('请输入语音内容'); return; }
            const msg = `<div class="special-message voice"><div class="special-message-header">🎤 语音消息</div><div>时长:${dur||'未知'}秒<br>内容:${content}</div></div>`;
            addMessage(msg,'user',true); saveMessage(msg,'user',true); closeModal();
            setTimeout(()=>{
                const resp='我收到了你的语音消息：'+content;
                addMessage(resp,'ai'); saveMessage(resp,'ai');
            },1000);
        }
        function sendLink(){
            const title=document.getElementById('linkTitle').value.trim();
            const url=document.getElementById('linkUrl').value.trim();
            const desc=document.getElementById('linkDesc').value.trim();
            if(!title||!url){ alert('请输入链接标题和地址'); return; }
            const msg = `<div class="special-message link"><div class="special-message-header">🔗 ${title}</div><div>链接: ${url}<br>${desc?'描述: '+desc:''}</div></div>`;
            addMessage(msg,'user',true); saveMessage(msg,'user',true); closeModal();
            setTimeout(()=>{
                const resp='感谢分享链接：'+title+'，我已经记录了这个信息。';
                addMessage(resp,'ai'); saveMessage(resp,'ai');
            },1000);
        }
        function sendMoney(){
            const amt=document.getElementById('moneyAmount').value.trim();
            const note=document.getElementById('moneyNote').value.trim();
            const type=document.getElementById('moneyType').value;
            if(!amt){ alert('请输入转账金额'); return; }
            const typeText = type==='redpack'?'红包':'转账';
            const msg = `<div class="special-message money"><div class="special-message-header">💰 ${typeText}</div><div>金额: ¥${amt}<br>${note?'备注: '+note:''}</div></div>`;
            addMessage(msg,'user',true); saveMessage(msg,'user',true); closeModal();
            setTimeout(()=>{
                const resp=`收到你的${typeText}：¥${amt}，谢谢！${note?'备注：'+note:''}`;
                addMessage(resp,'ai'); saveMessage(resp,'ai');
            },1000);
        }

        // 个人资料管理
        function openEditProfileModal(){
            document.getElementById('editProfileName').value = state.profile.name;
            document.getElementById('editProfileBio').value = state.profile.bio;
            document.getElementById('editProfileModal').style.display='flex';
        }
        function saveProfile(){
            state.profile.name = document.getElementById('editProfileName').value.trim()||'我';
            state.profile.bio = document.getElementById('editProfileBio').value.trim()||'这个人很懒，什么都没有留下...';
            saveData(); updateProfileDisplay(); closeModal();
        }
        function updateProfileDisplay(){
            document.getElementById('profileName').textContent = state.profile.name;
            document.getElementById('profileBio').textContent = state.profile.bio;
            const avatarEl = document.getElementById('profileAvatar');
            avatarEl.textContent = '';
            if(state.profile.avatar.startsWith('data:image')){
                avatarEl.style.backgroundImage = `url(${state.profile.avatar})`;
            } else {
                avatarEl.style.backgroundImage = '';
                avatarEl.textContent = state.profile.avatar;
            }
        }
        function updateProfileAvatar(event){
            const file=event.target.files[0];
            if(file){
                const reader=new FileReader();
                reader.onload=e=>{
                    state.profile.avatar = e.target.result;
                    saveData(); updateProfileDisplay();
                };
                reader.readAsDataURL(file);
            }
        }

        // 设置管理
        function updateSettingsUI(){
            const elProvider = document.getElementById('apiProvider');
            const elUrl = document.getElementById('apiUrl');
            const elKey = document.getElementById('apiKey');
            const elModel = document.getElementById('modelName');
            elProvider.value = state.config.apiProvider;
            elUrl.value = state.config.apiUrl;
            elKey.value = state.config.apiKey;
            elModel.value = state.config.modelName;
            document.getElementById('npcComments').checked = state.config.npcComments;
            if(state.config.aliyunApi) document.getElementById('aliyunApi').value=state.config.aliyunApi;
            if(state.config.oneDriveApi) document.getElementById('oneDriveApi').value=state.config.oneDriveApi;
            if(state.config.webdavApi) document.getElementById('webdavApi').value=state.config.webdavApi;
        }
        function updateApiSettings(){
            const provider=document.getElementById('apiProvider').value;
            const urlInput=document.getElementById('apiUrl');
            const modelInput=document.getElementById('modelName');
            if(provider==='openai'){
                urlInput.value='https://api.openai.com/v1/chat/completions';
                modelInput.value='gpt-3.5-turbo';
            } else if(provider==='claude'){
                urlInput.value='https://api.anthropic.com/v1/messages';
                modelInput.value='claude-3-sonnet-20240229';
            }
        }
        function saveSettings(){
            state.config.apiProvider = document.getElementById('apiProvider').value;
            state.config.apiUrl = document.getElementById('apiUrl').value;
            state.config.apiKey = document.getElementById('apiKey').value;
            state.config.modelName = document.getElementById('modelName').value;
            state.config.npcComments = document.getElementById('npcComments').checked;
            state.config.aliyunApi = document.getElementById('aliyunApi').value;
            state.config.oneDriveApi = document.getElementById('oneDriveApi').value;
            state.config.webdavApi = document.getElementById('webdavApi').value;
            saveData();
            // 提示保存成功
            alert('设置已保存');
        }
        function toggleNpcComments(){
            state.config.npcComments = document.getElementById('npcComments').checked;
            saveData();
        }

        // 主题管理 (壁纸/图标/字体)
        function uploadWallpaper(event){
            const file=event.target.files[0];
            if(file){
                const reader=new FileReader();
                reader.onload=e=>{
                    setWallpaper(`url(${e.target.result})`);
                };
                reader.readAsDataURL(file);
            }
        }
        function setWallpaper(wallpaper){
            document.documentElement.style.setProperty('--bg-image', wallpaper);
            try { localStorage.setItem('xphone_wallpaper', wallpaper); } catch(e){ console.warn('保存壁纸失败'); }
        }
        function updateAppIcon(event){
            const file = event.target.files[0];
            if(file){
                const reader=new FileReader();
                reader.onload=e=>{
                    const app=document.getElementById('iconAppSelect').value;
                    state.appIcons[app] = { image: e.target.result };
                };
                reader.readAsDataURL(file);
            }
        }
        function saveCustomIcon(){
            saveData();
            updateAppIconDisplay();
            goHome();
        }
        function updateAppIconDisplay(){
            const defaultEmojis = { chat:'💬', game:'🎮', settings:'⚙️', theme:'🎨' };
            Object.keys(defaultEmojis).forEach(app=>{
                const iconEl=document.getElementById(app+'-app-icon');
                if(iconEl){
                    if(state.appIcons[app] && state.appIcons[app].image){
                        iconEl.style.backgroundImage = `url(${state.appIcons[app].image})`;
                        iconEl.textContent = '';
                    } else {
                        iconEl.style.backgroundImage = '';
                        iconEl.textContent = defaultEmojis[app];
                    }
                }
            });
        }
        function applyFont(){
            const url=document.getElementById('fontUrl').value.trim();
            if(!url) return;
            const style = document.createElement('style');
            style.innerHTML = `@font-face { font-family:'CustomFont'; src:url('${url}'); } body { font-family:'CustomFont' !important; }`;
            document.head.appendChild(style);
            try { localStorage.setItem('xphone_font', url); } catch(e){ console.warn('保存字体失败'); }
        }

        // 导出/导入数据
        function saveData(){
            try{
                localStorage.setItem('xphone_profile', JSON.stringify(state.profile));
                localStorage.setItem('xphone_contacts', JSON.stringify(state.contacts));
                localStorage.setItem('xphone_messages', JSON.stringify(state.messages));
                localStorage.setItem('xphone_moments', JSON.stringify(state.moments));
                localStorage.setItem('xphone_icons', JSON.stringify(state.appIcons));
                localStorage.setItem('xphone_config', JSON.stringify(state.config));
                localStorage.setItem('xphone_worldbook', JSON.stringify(state.worldBook));
            }catch(e){ console.warn('保存数据失败', e); }
        }
        function exportData(){
            const exportObj = {
                version:'1.0',
                timestamp:Date.now(),
                contacts: state.contacts,
                messages: state.messages,
                moments: state.moments,
                profile: state.profile,
                appIcons: state.appIcons,
                config: state.config,
                worldBook: state.worldBook,
                wallpaper: localStorage.getItem('xphone_wallpaper'),
                font: localStorage.getItem('xphone_font')
            };
            const dataStr=JSON.stringify(exportObj,null,2);
            const blob=new Blob([dataStr],{type:'application/json'});
            const url=URL.createObjectURL(blob);
            const a=document.createElement('a');
            a.href=url;
            a.download=`xphone_backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a); a.click(); a.remove();
            URL.revokeObjectURL(url);
            alert('数据导出成功！');
        }
        function importData(){
            document.getElementById('importFile').click();
        }
        function handleImportFile(event){
            const file = event.target.files[0];
            if(!file) return;
            const reader=new FileReader();
            reader.onload=e=>{
                try{
                    const data=JSON.parse(e.target.result);
                    if(!data.version) throw new Error('格式错误');
                    if(!confirm('导入数据将覆盖当前所有数据，是否继续？')) return;
                    // 导入数据
                    if(data.profile) state.profile=data.profile;
                    if(data.contacts) state.contacts=data.contacts;
                    if(data.messages) state.messages=data.messages;
                    if(data.moments) state.moments=data.moments;
                    if(data.appIcons) state.appIcons=data.appIcons;
                    if(data.config) state.config=data.config;
                    if(data.worldBook) state.worldBook=data.worldBook;
                    if(data.wallpaper) localStorage.setItem('xphone_wallpaper', data.wallpaper);
                    if(data.font) localStorage.setItem('xphone_font', data.font);
                    saveData();
                    initApp();
                    alert('数据导入成功！');
                } catch(err){
                    alert('导入失败：'+err.message);
                }
            };
            reader.readAsText(file);
        }

        // 切换页面
        function goHome(){
            hideAllScreens();
            document.getElementById('homeScreen').style.display='flex';
        }
        function openChatApp(){
            hideAllScreens();
            document.getElementById('chatApp').style.display='block';
            switchTab('chats');
        }
        function openSettings(){
            hideAllScreens();
            document.getElementById('settingsScreen').style.display='block';
        }
        function openTheme(){
            hideAllScreens();
            document.getElementById('themeScreen').style.display='block';
        }
        function openGame(){
            hideAllScreens();
            document.getElementById('gameScreen').style.display='flex';
        }
        function backToChatApp(){
            hideAllScreens();
            document.getElementById('chatApp').style.display='block';
        }
        function hideAllScreens(){
            const screens=['homeScreen','chatApp','chatScreen','settingsScreen','themeScreen','gameScreen'];
            screens.forEach(id=> document.getElementById(id).style.display='none');
        }
        function switchTab(tab){
            state.currentTab=tab;
            document.querySelectorAll('.pill-item, .floating-btn').forEach(it=>it.classList.remove('active'));
            if(tab==='chats'){
                document.querySelectorAll('.pill-item')[0].classList.add('active');
            } else if(tab==='contacts'){
                document.querySelectorAll('.pill-item')[1].classList.add('active');
            } else if(tab==='moments'){
                document.querySelectorAll('.pill-item')[2].classList.add('active');
            } else if(tab==='me'){
                document.querySelector('.floating-btn').classList.add('active');
            }
            document.getElementById('messagesPage').style.display = (tab==='chats')?'block':'none';
            document.getElementById('contactsPage').style.display = (tab==='contacts')?'block':'none';
            document.getElementById('momentsPage').style.display  = (tab==='moments')?'block':'none';
            document.getElementById('profileScreen').style.display  = (tab==='me')?'block':'none';
        }

        // 添加联系人
        function openAddContactModal(){
            document.getElementById('newContactAvatar').textContent='🤖';
            document.getElementById('newContactAvatar').style.backgroundImage='';
            document.getElementById('addContactModal').style.display='flex';
        }
        function updateContactAvatar(event){
            const file=event.target.files[0];
            if(file){
                const reader=new FileReader();
                reader.onload=e=>{
                    const avatar=document.getElementById('newContactAvatar');
                    avatar.style.backgroundImage=`url(${e.target.result})`;
                    avatar.textContent='';
                    avatar.dataset.avatarData=e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }
        function addContact(){
            const name=document.getElementById('contactName').value.trim();
            const prompt=document.getElementById('contactPrompt').value.trim();
            const avatarEl=document.getElementById('newContactAvatar');
            if(!name||!prompt){ alert('请填写联系人姓名和个性化prompt'); return; }
            const avatar = avatarEl.dataset.avatarData || '🤖';
            const contact={ id:'contact-'+Date.now(), name:name, avatar:avatar, prompt:prompt };
            state.contacts.push(contact);
            state.messages[contact.id]=[];
            saveData();
            generateWelcomeMoment(contact);
            renderChatList(); renderContactsList(); renderMoments();
            closeModal();
        }

        // 生成欢迎动态
        function generateWelcomeMoment(contact){
            const texts=['很高兴加入这个大家庭！期待与大家的交流 😊','新人报到！请多多关照 ✨','Hello everyone! 我是新来的AI助手 👋','刚刚加入，希望能和大家成为好朋友 🎉','第一次发朋友圈，有点紧张呢 😅'];
            const content = texts[Math.floor(Math.random()*texts.length)];
            const moment={ id:'moment-'+Date.now(), contactId:contact.id, contactName:contact.name, contactAvatar:contact.avatar, content:content, timestamp:Date.now(), likes:[], comments:[] };
            state.moments.unshift(moment); saveData();
        }

        // 游戏功能
        function setMeowCard(){
            const url = document.getElementById('meowUrlInput').value.trim();
            if(url) document.getElementById('cardMeow').style.backgroundImage = `url(${url})`;
        }
        function setGachaCard(){
            const url = document.getElementById('gachaUrlInput').value.trim();
            if(url) document.getElementById('cardGacha').style.backgroundImage = `url(${url})`;
        }
        function drawGacha(){
            const emojis=['🎉','🎁','🔮','🍀','😂','😎','👍','😺'];
            const res=emojis[Math.floor(Math.random()*emojis.length)];
            document.getElementById('gachaResult').textContent = res;
        }

        // 模态框控制
        function closeModal(){
            document.querySelectorAll('.modal').forEach(m=>m.style.display='none');
            document.querySelectorAll('.modal-input, .modal-textarea').forEach(inp=>inp.value='');
        }
        document.addEventListener('click', e=>{
            if(e.target.classList.contains('modal')) closeModal();
        });
        document.addEventListener('touchmove', e=>{
            if(document.querySelector('.modal[style*="flex"]')){
                e.preventDefault();
            }
        }, {passive:false});
        function handleKeyPress(event){
            if(event.key==='Enter'){ sendMessage(); }
        }

        // 初始化应用
        window.addEventListener('load', initApp);
    </script>
</body>
</html>