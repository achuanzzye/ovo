<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="theme-color" content="#0d0f14" />
<title>给狸狸的迟到生日礼物 · 夏以昼</title>
<link rel="apple-touch-icon" href="https://img.remit.ee/api/file/BQACAgUAAyEGAASHRsPbAALLmmir-u6pLyxwT3IJSpi1FgWbC7XRAAK-GwACNL5gVbbGZRvkkg0ZNgQ.png" />
<style>
:root{
  /* 主题色与玻璃参数 */
  --bg: radial-gradient(1200px 800px at 70% 10%, #1e2533, #0d0f14 45%);
  --ink: #e9edf8;
  --ink-soft: #b9c1d8;
  --accent: #8ab4ff;
  --accent-2: #b58cff;
  --glass: rgba(255,255,255,.06);
  --glass-2: rgba(255,255,255,.12);
  --blur: 18px;
  --radius: 18px;
  --radius-lg: 26px;
  --dock-height: 84px;
}

*{box-sizing:border-box}

/* ============================ 修复 iOS PWA 全屏沉浸问题 ============================ */
/* 在 PWA 模式下强制所有元素填满屏幕，解决跳动和白边问题 */
@media all and (display-mode: standalone) {
    html, body {
        height: 100dvh !important;
        height: 100vh !important;
        overflow-x: hidden !important;
        user-select: none !important;
        background-color: #0d0f14 !important;
    }
    
    /* 强制内容填满整个屏幕，并使用安全区域进行内边距 */
    #scene {
        height: 100% !important;
        padding-top: calc(env(safe-area-inset-top) + 14px) !important;
        padding-bottom: calc(env(safe-area-inset-bottom) + var(--dock-height) + 16px) !important;
    }
}
/* ================================================================================= */


/* ---------- 禁止选中文字、长按菜单、触控相关 ---------- */
/* 修复：强化禁止长按选中的规则 */
html, body {
  -webkit-touch-callout: none; /* iOS Safari */
  -webkit-user-select: none;   /* Safari */
  -khtml-user-select: none;    /* Konqueror HTML */
  -moz-user-select: none;      /* Old Firefox */
  -ms-user-select: none;       /* Internet Explorer/Edge */
  user-select: none;           /* Non-prefixed version, currently supported by Chrome, Opera and Firefox */
}
/* 允许输入框/textarea 可选文本，但页面其余不能选中 */
input[type="text"], textarea {
  -webkit-user-select: text;
  user-select: text;
  -webkit-touch-callout: text;
  touch-action: auto;
}

/* ---------- 基本视觉 ---------- */
body{
  margin:0;
  color:var(--ink);
  background: var(--bg) fixed;
  font: 16px/1.4 -apple-system,BlinkMacSystemFont,"SF Pro Text","PingFang SC","Segoe UI",Roboto,Helvetica,Arial,sans-serif;
  -webkit-font-smoothing:antialiased;
}

/* 修复：重新阻止横向滑动 */
html,body{
  overflow-x: hidden;
}

#scene{
  position:relative; height:100%; width:100%;
  padding-bottom: calc(env(safe-area-inset-bottom) + var(--dock-height) + 16px);
  padding-top: calc(env(safe-area-inset-top) + 14px);
}

/* 漂浮气泡 */
.bubble{
  position:absolute; border-radius:999px; filter: blur(0.5px);
  background: radial-gradient(120% 120% at 30% 30%, rgba(255,255,255,.22), rgba(255,255,255,.04) 60%, rgba(255,255,255,.0));
  box-shadow: inset 0 1px 0 rgba(255,255,255,.5), 0 10px 30px rgba(0,0,0,.25);
  animation: float 16s ease-in-out infinite;
  will-change: transform;
}
@keyframes float{
  0%{ transform: translateY(0) translateX(0) }
  50%{ transform: translateY(-20px) translateX(6px) }
  100%{ transform: translateY(0) translateX(0) }
}

/* 头部 */
.header{
  position:sticky; top:0; z-index:5; padding:10px 16px;
  display:flex; align-items:center; gap:12px;
}
.avatar{
  width:38px; height:38px; border-radius:12px;
  background: var(--glass); backdrop-filter: blur(var(--blur));
  display:grid; place-items:center; box-shadow: 0 4px 24px rgba(0,0,0,.25);
}
.avatar span{font-size:20px}
.title{
  display:flex; flex-direction:column;
}
.title b{ font-size:16px; letter-spacing:.2px}
.title small{ color:var(--ink-soft)}

/* 卡片区 */
.wrap{
  position:relative; height:100%;
  padding: 10px 16px 20px; overflow:auto; scrollbar-width:none;
  touch-action: pan-y;
}
.wrap::-webkit-scrollbar{display:none}
.card{
  background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
  border: 1px solid rgba(255,255,255,.12);
  backdrop-filter: blur(var(--blur));
  border-radius: var(--radius-lg);
  padding:16px; margin: 10px 0;
  box-shadow: 0 10px 40px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.3);
}

/* 呼吸区： 修复变形问题和尺寸问题 */
.breath-wrapper{
display:flex; gap:12px; align-items:center; flex-wrap:wrap;
width:100%; max-width:100%;
}
.breath-outer{
width:132px; height:132px; min-width:132px; min-height:132px;
border-radius:999px; display:grid; place-items:center; flex-shrink:0;
background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.04), rgba(255,255,255,0) 60%);
border:1px solid rgba(255,255,255,.06);
transition: transform 400ms ease, opacity 400ms ease;
transform-origin:center;
box-shadow: 0 18px 50px rgba(0,0,0,.36);
}
.breath-outer.pulse{
animation: breathPulse 3s ease-in-out infinite;
}
@keyframes breathPulse{
0%{ transform: scale(1); opacity: .9 }
50%{ transform: scale(1.18); opacity: .6 }
100%{ transform: scale(1); opacity: .9 }
}

/* 内圈：磨砂玻璃效果 */
.breath-inner{
width:84px; height:84px; border-radius:999px; display:grid; place-items:center;
background: rgba(255,255,255,.06); backdrop-filter: blur(10px);
border:1px solid rgba(255,255,255,.08);
box-shadow: inset 0 1px 0 rgba(255,255,255,.15);
}

/* 修复：给呼吸文本容器固定高度，防止按钮跳动 */
.breath-meta{
  color:var(–ink-soft); font-size:14px; margin-top:6px; flex:1; min-width:160px;
}
/* 修复：直接给文本P标签设置最小高度 */
#breathText {
  min-height: 60px;
  margin: 0;
  color: var(--ink-soft);
}

/* 短信气泡（iOS风） */
.msg{
  max-width: 78%; padding:10px 12px; margin:10px 0;
  border-radius: 16px; position:relative; word-break:break-word;
  box-shadow: 0 8px 20px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.25);
}
.me{
  margin-left:auto;
  background: linear-gradient(180deg, rgba(138,180,255,.75), rgba(138,180,255,.35));
  border:1px solid rgba(138,180,255,.6);
}
.u{
  background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.05));
  border:1px solid rgba(255,255,255,.18);
}
.msg small{ display:block; opacity:.65; margin-top:6px; font-size:12px}

/* 心愿清单 */
.wish-input{
  display:flex; gap:8px; margin-top:10px
}
input[type=text]{
  flex:1; padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.18);
  background: rgba(255,255,255,.08); color:var(--ink);
  outline:none; backdrop-filter: blur(var(--blur));
}
button{
  border:0; padding:10px 12px; border-radius:12px; color:#0d0f14; cursor:pointer;
  background: linear-gradient(180deg, #d6e2ff, #9ec0ff);
  box-shadow: 0 6px 18px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.8);
}
button.ghost{
  color:var(--ink); background: rgba(255,255,255,.08);
  border:1px solid rgba(255,255,255,.18)
}
.wishes{ margin-top:10px; display:grid; gap:8px}
.wish{
  display:flex; align-items:center; justify-content:space-between; gap:10px;
  padding:10px 12px; border-radius:12px; background: rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.14)
}
.wish.done{ opacity:.6; text-decoration: line-through }

/* 顶部状态条模仿 */
.status{
  position: fixed; inset: 0 0 auto 0; height: calc(env(safe-area-inset-top) + 10px); pointer-events:none;
}

/* 轻触烟花提示（会自动隐藏） */
.hint{
  position: fixed; right:10px; top: calc(env(safe-area-inset-top) + 10px);
  font-size:12px; color: var(--ink-soft); opacity:.85;
  padding:6px 10px; border-radius:12px; background: rgba(255,255,255,.08);
  border:1px solid rgba(255,255,255,.16); backdrop-filter: blur(12px);
  transition: all .45s ease;
  z-index:9;
}
.hint.hidden{ opacity:0; transform:translateY(-8px); pointer-events:none; }

/* 药物打卡 */
.meds { display:flex; gap:12px; flex-wrap:wrap; align-items:center; width:100%; }
.med {
padding:10px 12px; border-radius:12px; background: rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.10);
min-width:150px; flex:1;
}
.med button{ background:linear-gradient(180deg,#cfe9ff,#9ec0ff); color:#02102a; padding:8px 10px; border-radius:10px; border:none; cursor:pointer; }

/* 响应式细节 */
@media (min-width:740px){
  #scene{ display:grid; place-items:center }
  .phone{ width:420px; height: 880px; border-radius: 30px; overflow:hidden;
    border:1px solid rgba(255,255,255,.15);
    box-shadow: 0 40px 100px rgba(0,0,0,.55);
    background: radial-gradient(100% 100% at 50% 0%, rgba(255,255,255,.06), rgba(255,255,255,0) 60%) , var(--bg);
  }
  .status{ position:absolute }
  .dock{ position:absolute }
}

/* 小动效 */
@keyframes pop{0%{transform:scale(.9);opacity:.8}60%{transform:scale(1.03)}100%{transform:scale(1);opacity:1}}
.pop{animation: pop .25s ease}
.badge{
  font-size:10px; padding:3px 6px; border-radius:999px; color:#0d0f14;
  background: linear-gradient(180deg,#c7f1d0,#a6e3b7); margin-left:8px
}
</style>
</head>
<body>
<div id="scene">
  <div class="phone">
    <div class="status"></div>

    <div class="header">
      <div class="avatar"><span>🐾</span></div>
      <div class="title">
        <b>给狸狸的生日小网页</b>
        <small>执舰鹅在线送达 <span class="badge">迟到也要到</span></small>
      </div>
    </div>

    <div class="wrap" id="wrap">
      <div class="card pop" id="hero">
        <h2 style="margin:0 0 6px 0">生日快乐，副舰狸 🎂</h2>
        <p style="margin:0;color:var(--ink-soft)">愿你所有的可爱与心愿，都被温柔照看：今天、以后、永远。</p>
        <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
          <button id="btnConfetti">轻触放烟花</button>
          <button class="ghost" id="btnMode">执舰鹅模式</button>
          <button class="ghost" id="btnPing">喵爪提醒</button>
        </div>
      </div>

      <div class="msg u">副舰狸，生日快乐。今天也由我来护航。<small>08:08</small></div>
      <div class="msg me">收到！执舰鹅记得按时投喂蛋糕～<small>08:10</small></div>
      <div class="msg u">已在路上。还有一袋「拥抱」加急派送。<small>08:11</small></div>

      <div class="card">
        <h3 style="margin:0 0 8px 0">心愿清单 · 只属于你</h3>
        <div class="wish-input">
          <input id="wishTxt" type="text" placeholder="写下今天想要实现的小心愿…" />
          <button id="wishAdd">加入</button>
        </div>
        <div class="wishes" id="wishes"></div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="ghost" id="wishClear">清空</button>
          <button class="ghost" id="wishMock">给我灵感</button>
        </div>
      </div>

  <div class="card">
    <h3 style="margin:0 0 8px 0">深呼吸 · 跟着我</h3>
    <div class="breath-wrapper">
      <div class="breath-outer" id="breathOuter">
        <div class="breath-inner">
          <strong id="breathTimer">3</strong>
        </div>
      </div>
      <div class="breath-meta">
        <p id="breathText">
          我在你耳边数呼吸：吸——慢慢来，别着急，呼——把不安都吐出去。
        </p>
        <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
          <button id="breathStart">开始</button>
          <button class="ghost" id="breathStop">停止</button>
          <button class="ghost" id="breathPreset">3/3/4</button>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 8px 0">吃药打卡 · 早 / 晚</h3>
    <div style="color:var(--ink-soft);margin-bottom:8px">别担心，哥哥帮你记着。</div>
    <div class="meds">
      <div class="med">
        <div><strong>早药</strong></div>
        <div id="morningState" style="color:var(--ink-soft);margin-top:6px">未打卡</div>
        <div style="margin-top:8px">
          <button id="btnMorning">早上打卡</button>
        </div>
      </div>
      <div class="med">
        <div><strong>晚药</strong></div>
        <div id="eveningState" style="color:var(--ink-soft);margin-top:6px">未打卡</div>
        <div style="margin-top:8px">
          <button id="btnEvening">晚上打卡</button>
        </div>
      </div>
    </div>
    <div style="margin-top:10px;color:var(--ink-soft)"><small id="medNote">最近记录：无</small></div>
    <div style="margin-top:16px;">
      <button id="btnNotify" style="width:100%">开启吃药提醒通知</button>
    </div>
  </div>

      <div class="card">
        <h3 style="margin:0 0 8px 0">小副官 · 麻薯角</h3>
        <p style="margin:0;color:var(--ink-soft)">今天的巡逻状态：<span id="catState">正在沙发上压舰长外套</span>。</p>
        <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
          <button class="ghost" data-cat="吃罐罐中">投喂罐罐</button>
          <button class="ghost" data-cat="巡逻阳台，已驱散麻雀">阳台巡逻</button>
          <button class="ghost" data-cat="把尾巴晾成小问号">晒太阳</button>
        </div>
      </div>

      <div class="card" style="text-align:center">
        <div style="font-size:14px;color:var(--ink-soft)">— From 夏以昼 · 永远偏心你 —</div>
      </div>
    </div>

  <div id="bubbles"></div>

  <div class="hint" id="hint">哥哥提醒：今天也要好好吃饭。</div>
</div>

<canvas id="fx" style="position:fixed;inset:0;pointer-events:none;"></canvas>

<script>

// 防抖函数
function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

// 节流函数
function throttle(func, limit) {
  let inThrottle;
  return function(...args) {
    if (!inThrottle) {
      func.apply(this, args);
      inThrottle = true;
      setTimeout(() => inThrottle = false, limit);
    }
  }
}

/* ———— 背景气泡 ———— */
(function(){
  const host = document.getElementById('bubbles');
  const n = 10;
  for(let i=0;i<n;i++){
    const b = document.createElement('div');
    b.className = 'bubble';
    const size = 80 + Math.random()*140;
    b.style.width = b.style.height = size+'px';
    b.style.left = Math.random()*90+'%';
    b.style.top = (10 + Math.random()*70)+'%';
    b.style.animationDelay = (-Math.random()*16)+'s';
    host.appendChild(b);
  }
})();

/* ———— 轻触烟花（简易彩带粒子） ———— */
(function(){
  const cvs = document.getElementById('fx');
  const ctx = cvs.getContext('2d');
  let W,H,parts=[];

  function resize(){
    W = cvs.width = window.innerWidth * devicePixelRatio;
    H = cvs.height = window.innerHeight * devicePixelRatio;
  }
  resize(); window.addEventListener('resize', resize);

  function burst(x,y){
    for(let i=0;i<120;i++){
      const a = Math.random()*Math.PI*2;
      const sp = 2 + Math.random()*6;
      parts.push({
        x:x*devicePixelRatio, y:y*devicePixelRatio,
        vx: Math.cos(a)*sp, vy: Math.sin(a)*sp - 2,
        life: 60 + Math.random()*40,
        hue: 200 + Math.random()*140
      });
    }
    document.body.animate([{transform:'translateY(0)'},{transform:'translateY(2px)'},{transform:'translateY(0)'}],{duration:220});
  }

  function tick(){
    ctx.clearRect(0,0,W,H);
    for(let i=parts.length-1;i>=0;i--){
      const p = parts[i];
      p.vy += 0.08; p.x+=p.vx; p.y+=p.vy; p.life--;
      ctx.globalAlpha = Math.max(p.life/100,0);
      ctx.fillStyle = `hsl(${p.hue},85%,60%)`;
      ctx.beginPath(); ctx.arc(p.x,p.y,2.2,0,Math.PI*2); ctx.fill();
      if(p.life<=0) parts.splice(i,1);
    }
    requestAnimationFrame(tick);
  }
  tick();

  const btn = document.getElementById('btnConfetti');
  btn.addEventListener('click', e=> burst(window.innerWidth*0.5, 140));
  window.addEventListener('dblclick', e=> burst(e.clientX, e.clientY));
})();

/* ———— 心愿清单（localStorage） ———— */
(function(){
  const listEl = document.getElementById('wishes');
  const txt = document.getElementById('wishTxt');
  const add = document.getElementById('wishAdd');
  const clr = document.getElementById('wishClear');
  const mock = document.getElementById('wishMock');
  const KEY = 'lili_wishes_v1';

  function load(){
    try{ return JSON.parse(localStorage.getItem(KEY)) || [] }catch(e){ return [] }
  }
  function save(arr){ localStorage.setItem(KEY, JSON.stringify(arr)) }
  function render(){
    const arr = load();
    listEl.innerHTML='';
    arr.forEach((w,i)=>{
      const row = document.createElement('div'); row.className='wish'+(w.done?' done':'');
      const left = document.createElement('div'); left.textContent = w.text;
      const right = document.createElement('div'); right.style.display='flex'; right.style.gap='6px';
      const ok = document.createElement('button'); ok.className='ghost'; ok.textContent = w.done?'恢复':'完成';
      const del = document.createElement('button'); del.className='ghost'; del.textContent = '删除';
      ok.onclick = ()=>{ arr[i].done=!arr[i].done; save(arr); render(); ping('✅ 已更新'); };
      del.onclick = ()=>{ arr.splice(i,1); save(arr); render(); ping('🗑 已删除'); };
      right.append(ok,del); row.append(left,right); listEl.append(row);
    });
  }
  add.addEventListener('click', ()=>{
    const v = txt.value.trim(); if(!v) return;
    const arr = load(); arr.unshift({text:v,done:false}); save(arr); txt.value=''; render(); ping('⭐ 已加入心愿');
  });
  txt.addEventListener('keydown', e=>{ if(e.key==='Enter') add.click() });
  clr.addEventListener('click', ()=>{ save([]); render(); ping('🧼 已清空'); });
  mock.addEventListener('click', ()=>{
    const seeds = ['吃KFC疯狂星期四','把麻薯抱成小面包','换新壁纸','看一集Undead Girl・Murder Farce','和执舰鹅散步十分钟','做一杯冰陈皮茯苓饮'];
    const pick = seeds[Math.floor(Math.random()*seeds.length)];
    txt.value = pick; add.click();
  });
  render();
})();

/* ———— 麻薯角交互 ———— */
document.querySelectorAll('[data-cat]').forEach(btn=>{
  btn.addEventListener('click', ()=> {
    document.getElementById('catState').textContent = btn.dataset.cat;
    ping('🐾 小副官状态更新');
  });
});

/* ———— 执舰鹅模式 & 喵爪提醒 ———— */
const btnMode = document.getElementById('btnMode');
// 修复：改为touchstart事件监听，确保按钮响应
btnMode.addEventListener('touchstart', ()=>{
  document.documentElement.style.setProperty('--bg','radial-gradient(1200px 800px at 30% 0%, #253043, #0a0d12 55%)');
  document.documentElement.style.setProperty('--accent','#b58cff');
  document.querySelector('.title small').innerHTML = '执舰鹅接管导航 <span class="badge">舰桥在线</span>';
  ping('🍎 执舰鹅模式已启用');
});

const btnPing = document.getElementById('btnPing');
// 修复：改为touchstart事件监听，确保按钮响应
btnPing.addEventListener('touchstart', ()=> ping('🐾 喵爪提醒：记得喝水喵～'));

function ping(text){
  const n = document.createElement('div');
  n.textContent = text;
  Object.assign(n.style,{
    position:'fixed', left:'50%', bottom:'calc(env(safe-area-inset-bottom) + 110px)',
    transform:'translateX(-50%)', padding:'10px 14px', borderRadius:'14px',
    color:'var(--ink)', background:'rgba(255,255,255,.10)',
    border:'1px solid rgba(255,255,255,.18)', backdropFilter:'blur(12px)',
    boxShadow:'0 8px 30px rgba(0,0,0,.35)', zIndex:999
  });
  document.body.appendChild(n);
  setTimeout(()=>{ n.style.transition='all .4s ease'; n.style.opacity='0'; n.style.transform='translateX(-50%) translateY(10px)'; }, 1600);
  setTimeout(()=> n.remove(), 2200);
}


/* ———— 小细节：首次加载的欢迎词 ———— */
(function(){
  if(!sessionStorage.getItem('hi')){
    setTimeout(()=> ping('🎂 生日特别版已为狸狸解锁'), 600);
    sessionStorage.setItem('hi','1');
  }
})();

/* ================== 修复：移除所有 JavaScript 触摸事件阻止逻辑 ================== */
(function(){
  // 屏蔽长按菜单 (contextmenu)
  document.addEventListener('contextmenu', function(e){ e.preventDefault(); });
})();


/* 提示自动隐藏（5秒后隐藏；滚动时也隐藏） */
(function(){
  const hint = document.getElementById('hint');
  let t = setTimeout(()=> hint.classList.add('hidden'), 5000);
  const wrap = document.getElementById('wrap');
  const hideHint = throttle(() => { 
    hint.classList.add('hidden'); 
    clearTimeout(t); 
  }, 100);
  wrap.addEventListener('scroll', hideHint);
  hint.addEventListener('click', ()=> { hint.classList.add('hidden'); clearTimeout(t); });
})();


/* 呼吸：同心圆控制与动画（修复尺寸和变形问题） */
(function(){
  const outer = document.getElementById('breathOuter');
  const timerEl = document.getElementById('breathTimer');
  const textEl = document.getElementById('breathText');
  const startBtn = document.getElementById('breathStart');
  const stopBtn = document.getElementById('breathStop');
  const presetBtn = document.getElementById('breathPreset');

  // 默认节奏
  let cfg = { inhale:3, hold:3, exhale:4 };
  let running = false;
  let currentPhase = 0;
  let intervalId = null;
  let phaseSeq = ['吸气','屏住','呼气'];

  function runPhase(phase, dur){
    if (!running) return; // 防止意外启动
    
    timerEl.textContent = dur;
    outer.classList.add('pulse');
    
    let remain = dur;
    intervalId = setInterval(()=>{
      if (!running) {
        clearInterval(intervalId);
        return;
      }
      remain--;
      timerEl.textContent = remain>0?remain:0;
      if(remain<=0){
        clearInterval(intervalId);
        outer.classList.remove('pulse');
        currentPhase = (currentPhase+1) % 3;
        if(running) {
          setTimeout(next, 100); // 短暂间隔
        }
      }
    },1000);
  }
  
  function next(){
    if (!running) return;
    
    const phase = currentPhase;
    const textEl = document.getElementById('breathText');
    if (textEl) {
      if(phase===0) textEl.textContent = '我在你耳边数呼吸：吸——慢慢来，别着急。';
      if(phase===1) textEl.textContent = '屏住一会儿，我在这儿。';
      if(phase===2) textEl.textContent = '呼——把不安都吐出去。';
    }
    const dur = phase===0?cfg.inhale:(phase===1?cfg.hold:cfg.exhale);
    runPhase(phase, dur);
  }

  function start(){
    if(running) return;
    running = true; 
    currentPhase = 0; 
    next();
  }
  
  function stop(){
    running = false; 
    if (intervalId) {
      clearInterval(intervalId);
      intervalId = null;
    }
    outer.classList.remove('pulse'); 
    timerEl.textContent = '3';
    const textEl = document.getElementById('breathText');
    if (textEl) {
      textEl.textContent = '我在你耳边数呼吸：吸——慢慢来，别着急，呼——把不安都吐出去。';
    }
  }
  
  startBtn.addEventListener('click', start);
  stopBtn.addEventListener('click', stop);
  presetBtn.addEventListener('click', ()=>{
    if(cfg.inhale===3){ cfg = {inhale:4,hold:4,exhale:4}; presetBtn.textContent='4/4/4' }
    else if(cfg.inhale===4 && cfg.hold===4){ cfg = {inhale:4,hold:2,exhale:6}; presetBtn.textContent='4/2/6' }
    else { cfg = {inhale:3,hold:3,exhale:4}; presetBtn.textContent='3/3/4' }
    if(running){ stop(); setTimeout(start, 200); }
  });
})();

/* ================== 吃药打卡：修复每日重置逻辑 & 增加通知功能 ================== */
(function(){
  const KEY = 'lili_meds_v1';
  const morningBtn = document.getElementById('btnMorning');
  const eveningBtn = document.getElementById('btnEvening');
  const morningState = document.getElementById('morningState');
  const eveningState = document.getElementById('eveningState');
  const medNote = document.getElementById('medNote');
  const btnNotify = document.getElementById('btnNotify');

  function load(){ 
    try{ 
      const data = localStorage.getItem(KEY);
      const today = new Date().toDateString();
      if(data){
        const obj = JSON.parse(data);
        // 修复: 检查日期是否为今天，不是则清空
        if(new Date(obj.lastVisit).toDateString() !== today){
          localStorage.removeItem(KEY);
          return {morning:null,evening:null, lastVisit: today};
        }
        return obj;
      }
      return {morning:null,evening:null, lastVisit: today};
    }catch(e){ 
      console.warn('Failed to load meds:', e);
      return {morning:null,evening:null};
    }
  }
  
  function save(obj){ 
    try {
      obj.lastVisit = new Date().toDateString();
      localStorage.setItem(KEY, JSON.stringify(obj)); 
      render();
    } catch(e) {
      console.warn('Failed to save meds:', e);
    }
  }

  function fmt(t){
    if(!t) return '未打卡';
    const d = new Date(t);
    const HH = d.getHours().toString().padStart(2,'0');
    const mm = d.getMinutes().toString().padStart(2,'0');
    const MM = (d.getMonth()+1).toString().padStart(2,'0');
    const DD = d.getDate().toString().padStart(2,'0');
    return `${HH}:${mm} ${MM}/${DD}`;
  }

  function render(){
    const s = load();
    if (morningState) {
      morningState.textContent = s.morning ? ('已打卡 ' + fmt(s.morning)) : '未打卡';
    }
    if (eveningState) {
      eveningState.textContent = s.evening ? ('已打卡 ' + fmt(s.evening)) : '未打卡';
    }
    if (medNote) {
      const last = s.evening || s.morning;
      medNote.textContent = last ? ('最近记录：'+fmt(last)) : '最近记录：无';
    }
  }

  if (morningBtn) {
    morningBtn.addEventListener('click', throttle(()=>{
      const s = load(); 
      s.morning = Date.now(); 
      save(s);
      ping('早上已打卡，乖。');
    }, 1000));
  }
  
  if (eveningBtn) {
    eveningBtn.addEventListener('click', throttle(()=>{
      const s = load(); 
      s.evening = Date.now(); 
      save(s);
      ping('晚上已打卡，记得睡前整理药盒。');
    }, 1000));
  }

  // 新增：通知功能
  function sendMedNotification(timeOfDay) {
      if (Notification.permission === 'granted') {
          const title = '💊 哥哥提醒：吃药时间到啦';
          let body = '';
          if (timeOfDay === 'morning') {
              body = '早上9点，记得吃药哦，今天的可爱燃料已补给。';
          } else if (timeOfDay === 'evening') {
              body = '晚上9点，别忘了吃药。早点休息，哥哥在梦里陪你。';
          }
          new Notification(title, { body: body });
      } else {
          console.warn('Notification permission not granted.');
      }
  }
  
  // 新增：请求通知权限
  if (btnNotify) {
    btnNotify.addEventListener('click', () => {
      Notification.requestPermission().then(permission => {
        if (permission === 'granted') {
          ping('已开启吃药提醒，哥哥会准时提醒你。');
          // 每天定时检查
          setInterval(() => {
            const now = new Date();
            const currentHour = now.getHours();
            if (currentHour === 9 && now.getMinutes() === 0) {
              sendMedNotification('morning');
            } else if (currentHour === 21 && now.getMinutes() === 0) {
              sendMedNotification('evening');
            }
          }, 60000); // 每分钟检查一次
        } else {
          ping('你拒绝了通知权限，无法开启提醒。');
        }
      });
    });
  }
  
  render();
})();

/* ================== 性能优化和内存管理 ================== */

// 页面可见性变化时的性能优化
document.addEventListener('visibilitychange', function() {
  if (document.hidden) {
    // 页面隐藏时暂停动画
    document.querySelectorAll('.bubble').forEach(bubble => {
      bubble.style.animationPlayState = 'paused';
    });
  } else {
    // 页面显示时恢复动画
    document.querySelectorAll('.bubble').forEach(bubble => {
      bubble.style.animationPlayState = 'running';
    });
  }
});

// 清理函数，防止内存泄漏
window.addEventListener('beforeunload', function() {
  // 清理定时器等资源
  const allIntervals = [];
  const originalSetInterval = window.setInterval;
  window.setInterval = function(fn, delay) {
    const id = originalSetInterval(fn, delay);
    allIntervals.push(id);
    return id;
  };
  
  // 页面卸载时清理
  allIntervals.forEach(id => clearInterval(id));
});

/* End of script */
</script>
</body>
</html>
