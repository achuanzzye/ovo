<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="theme-color" content="#0d0f14" />
<title>给狸狸的迟到生日礼物 · 夏以昼</title>

<!-- 新增：Apple touch icon（默认指向本地占位，可上传替换） -->
<link rel="apple-touch-icon" href="apple-touch-icon.png" id="appleTouchLink">

<style>
:root{
  --bg: radial-gradient(1200px 800px at 70% 10%, #1e2533, #0d0f14 45%);
  --ink: #e9edf8;
  --ink-soft: #b9c1d8;
  --accent: #8ab4ff;
  --accent-2: #b58cff;
  --glass: rgba(255,255,255,.06);
  --glass-2: rgba(255,255,255,.12);
  --blur: 18px;
  --radius: 18px;
  --radius-lg: 26px;
  --dock-height: 84px;
}

/* 基础修复：确保 Safari / PWA 下无上下白条 */
html,body{height:100%;min-height:100svh;margin:0;padding:0;overflow:hidden}
body{
  color:var(--ink);
  background: var(--bg) fixed;
  background-size: cover; /* 修复背景填充 */
  background-position:center;
  font: 16px/1.4 -apple-system,BlinkMacSystemFont,"SF Pro Text","PingFang SC","Segoe UI",Roboto,Helvetica,Arial,sans-serif;
  -webkit-font-smoothing:antialiased;
}

/* 主容器：用 safe-area 并保证高度为视窗高度 */
#scene{ position:relative; height:100svh; padding-bottom: calc(env(safe-area-inset-bottom) + 16px); padding-top: calc(env(safe-area-inset-top) + 14px); }

/* 其他样式维持原样（我没有随意更改视觉） */
.phone{ width:100%; height:100%; box-sizing:border-box; }
.header{ display:flex; align-items:center; gap:12px; padding:10px 16px; }
.avatar{ width:38px; height:38px; border-radius:12px; background: var(--glass); backdrop-filter: blur(var(--blur)); display:grid; place-items:center; }
.title b{ font-size:16px; letter-spacing:.2px }
.title small{ color:var(--ink-soft)}

/* 卡片与消息：保持不变 */
.wrap{ padding: 10px 16px 20px; height: calc(100% - 80px); overflow:auto; scrollbar-width:none; }
.wrap::-webkit-scrollbar{display:none}
.card{ background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05)); border: 1px solid rgba(255,255,255,.12); backdrop-filter: blur(var(--blur)); border-radius: var(--radius-lg); padding:16px; margin: 10px 0; box-shadow: 0 10px 40px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.3); }
.msg{ max-width: 78%; padding:10px 12px; margin:10px 0; border-radius: 16px; word-break:break-word; }

/* 提示（会自动隐藏） */
.hint{
  position: fixed; right:10px; top: calc(env(safe-area-inset-top) + 10px);
  font-size:12px; color: var(--ink-soft); opacity:.95;
  padding:8px 12px; border-radius:12px; background: rgba(255,255,255,.08);
  border:1px solid rgba(255,255,255,.16); backdrop-filter: blur(12px);
  transition: opacity .28s ease, transform .28s ease;
  z-index:999;
}

/* 新增：呼吸控件样式 */
.breath-overlay{
  position: fixed; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none;
}
.breath-circle{
  width:160px; height:160px; border-radius:999px; display:grid; place-items:center; pointer-events:auto;
  background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.06), rgba(138,180,255,.06));
  border: 2px solid rgba(138,180,255,.14);
  backdrop-filter: blur(10px);
}
.breath-controls{ position: absolute; bottom: 18%; display:flex; gap:8px; pointer-events:auto; }

/* 新增：吃药打卡样式 */
.med-box{ display:flex; gap:12px; align-items:center; margin-top:10px; }
.med-btn{ padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.04); color:var(--ink); cursor:pointer; }

/* 其余原有样式保持不改 */
</style>
</head>
<body>
<div id="scene">
  <div class="phone" role="application" aria-label="狸狸的生日网页">
    <div class="header">
      <div class="avatar"><span>🐾</span></div>
      <div class="title">
        <b>给狸狸的生日小网页</b>
        <small>执舰鹅在线送达 <span class="badge">迟到也要到</span></small>
      </div>
      <!-- 新增：上传 Apple 图标入口（不影响原 UI） -->
      <div style="margin-left:auto;display:flex;align-items:center;gap:8px;">
        <label style="font-size:12px; color:var(--ink-soft); cursor:pointer">
          上传图标
          <input id="uploadAppleIcon" type="file" accept="image/*" style="display:none" />
        </label>
      </div>
    </div>

    <div class="wrap" id="wrap">
      <div class="card" id="hero">
        <h2 style="margin:0 0 6px 0">生日快乐，副舰狸 🎂</h2>
        <p style="margin:0;color:var(--ink-soft)">愿你所有的可爱与心愿，都被温柔照看：今天、以后、永远。</p>
        <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
          <button id="btnConfetti">轻触放烟花</button>
          <button id="btnBreath" class="ghost">跟我做呼吸</button>
          <button id="btnToggleMed" class="ghost">吃药打卡</button>
        </div>
      </div>

      <div class="msg u">副舰狸，生日快乐。今天也由我来护航。<small>08:08</small></div>
      <div class="msg me">收到！执舰鹅记得按时投喂蛋糕～<small>08:10</small></div>
      <div class="msg u">已在路上。还有一袋「拥抱」加急派送。<small>08:11</small></div>

      <!-- 吃药打卡卡片（默认隐藏，由按钮切换） -->
      <div class="card" id="medCard" style="display:none">
        <h3 style="margin:0 0 8px 0">吃药打卡</h3>
        <div class="med-box">
          <div>
            <button class="med-btn" id="medMorning">早上 已打卡</button>
            <div id="medMorningTime" style="font-size:12px;color:var(--ink-soft);margin-top:6px"></div>
          </div>
          <div>
            <button class="med-btn" id="medEvening">晚上 已打卡</button>
            <div id="medEveningTime" style="font-size:12px;color:var(--ink-soft);margin-top:6px"></div>
          </div>
          <div style="margin-left:auto">
            <button id="medClear" class="ghost">重置今日</button>
          </div>
        </div>
      </div>

      <div class="card">
        <h3 style="margin:0 0 8px 0">心愿清单 · 只属于你</h3>
        <div class="wish-input">
          <input id="wishTxt" type="text" placeholder="写下今天想要实现的小心愿…" />
          <button id="wishAdd">加入</button>
        </div>
        <div class="wishes" id="wishes"></div>
      </div>

      <div class="card">
        <h3 style="margin:0 0 8px 0">小副官 · 麻薯角</h3>
        <p style="margin:0;color:var(--ink-soft)">今天的巡逻状态：<span id="catState">正在沙发上压舰长外套</span></p>
        <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
          <button class="ghost" data-cat="吃罐罐中">投喂罐罐</button>
          <button class="ghost" data-cat="巡逻阳台，已驱散麻雀">阳台巡逻</button>
          <button class="ghost" data-cat="把尾巴晾成小问号">晒太阳</button>
        </div>
      </div>

      <div class="card" style="text-align:center">
        <div style="font-size:14px;color:var(--ink-soft)">— From 夏以昼 · 永远偏心你 —</div>
      </div>
    </div>
  </div>

  <!-- 新增：提示（自动隐藏逻辑在脚本中） -->
  <div class="hint" id="hint">小技巧：把页面「添加到主屏幕」可以沉浸全屏</div>

  <!-- 新增：呼吸叠层（初始隐藏） -->
  <div class="breath-overlay" id="breathOverlay" style="display:none;pointer-events:none">
    <div class="breath-circle" id="breathCircle"><div id="breathLabel" style="font-size:14px;color:var(--ink-soft)">吸气</div></div>
    <div class="breath-controls" style="pointer-events:auto">
      <button id="breathStop" class="ghost">停止</button>
    </div>
  </div>
</div>

<canvas id="fx" style="position:fixed;inset:0;pointer-events:none;"></canvas>

<script>
/* ———— 基本粒子（保持原有烟花） ———— */
(function(){
  const cvs = document.getElementById('fx');
  const ctx = cvs.getContext('2d');
  let W,H,parts=[];
  function resize(){ W = cvs.width = window.innerWidth * devicePixelRatio; H = cvs.height = window.innerHeight * devicePixelRatio; }
  resize(); window.addEventListener('resize', resize);
  function burst(x,y){ for(let i=0;i<90;i++){ const a=Math.random()*Math.PI*2; const sp=2+Math.random()*5; parts.push({x:x*devicePixelRatio,y:y*devicePixelRatio,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp-2,life:40+Math.random()*60,hue:200+Math.random()*140}); } }
  function tick(){ ctx.clearRect(0,0,W,H); for(let i=parts.length-1;i>=0;i--){ const p=parts[i]; p.vy+=0.08; p.x+=p.vx; p.y+=p.vy; p.life--; ctx.globalAlpha=Math.max(p.life/100,0); ctx.fillStyle=`hsl(${p.hue},85%,60%)`; ctx.beginPath(); ctx.arc(p.x,p.y,2.2,0,Math.PI*2); ctx.fill(); if(p.life<=0) parts.splice(i,1); } requestAnimationFrame(tick); }
  tick();
  document.getElementById('btnConfetti').addEventListener('click', e=> burst(window.innerWidth*0.5,140));
  window.addEventListener('dblclick', e=> burst(e.clientX, e.clientY));
})();

/* ———— 心愿清单（本地存储） ———— (与原逻辑保持一致) */
(function(){
  const listEl=document.getElementById('wishes'), txt=document.getElementById('wishTxt'), add=document.getElementById('wishAdd');
  const KEY='lili_wishes_v1';
  function load(){ try{return JSON.parse(localStorage.getItem(KEY))||[]}catch{ return [] } }
  function save(a){ localStorage.setItem(KEY,JSON.stringify(a)) }
  function render(){ const arr=load(); listEl.innerHTML=''; arr.forEach((w,i)=>{ const row=document.createElement('div'); row.className='wish'+(w.done?' done':''); const left=document.createElement('div'); left.textContent=w.text; const right=document.createElement('div'); right.style.display='flex'; right.style.gap='6px'; const ok=document.createElement('button'); ok.className='ghost'; ok.textContent=w.done?'恢复':'完成'; const del=document.createElement('button'); del.className='ghost'; del.textContent='删除'; ok.onclick=()=>{ arr[i].done=!arr[i].done; save(arr); render(); ping('✅ 已更新') }; del.onclick=()=>{ arr.splice(i,1); save(arr); render(); ping('🗑 已删除') }; right.append(ok,del); row.append(left,right); listEl.append(row); }); }
  add.addEventListener('click', ()=>{ const v=txt.value.trim(); if(!v) return; const arr=load(); arr.unshift({text:v,done:false}); save(arr); txt.value=''; render(); ping('⭐ 已加入心愿'); });
  txt.addEventListener('keydown', e=>{ if(e.key==='Enter') add.click() });
  render();
})();

/* ———— 小副官交互（保持不变） ———— */
document.querySelectorAll('[data-cat]').forEach(btn=>btn.addEventListener('click', ()=>{ document.getElementById('catState').textContent = btn.dataset.cat; ping('🐾 小副官状态更新'); }));

/* ———— 提示自动隐藏（新增） ———— */
(function(){
  const hint = document.getElementById('hint');
  let hideTimer = null;
  function hideSoon(){ clearTimeout(hideTimer); hideTimer = setTimeout(()=>{ hint.style.opacity='0'; hint.style.transform='translateY(-6px)'; }, 3800); }
  function immediateHide(){ hint.style.opacity='0'; hint.style.transform='translateY(-6px)'; }
  // 初次若无交互，自动隐藏
  hideSoon();
  // 用户有交互时再短暂显示
  ['touchstart','mousemove','scroll','keydown','click'].forEach(ev=> window.addEventListener(ev, ()=>{ hint.style.opacity='1'; hint.style.transform='translateY(0)'; hideSoon(); }));
  // 如果进入 PWA（standalone），也隐藏
  if(window.matchMedia('(display-mode: standalone)').matches || navigator.standalone) immediateHide();
})();

/* ———— Apple Touch Icon 上传并动态替换（新增） ———— */
(function(){
  const input = document.getElementById('uploadAppleIcon');
  const link = document.getElementById('appleTouchLink');
  input.addEventListener('change', async ()=> {
    const file = input.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = ()=> {
      // 设置 link href 为 data URL（演示与后端保存用）
      link.href = reader.result;
      ping('🍎 Apple 触控图标已更新（如需真实生效，请把该图片命名为 apple-touch-icon.png 并放在仓库根目录）');
      // 自动触发下载，方便你把文件保存到仓库
      const a = document.createElement('a'); a.href = reader.result; a.download = 'apple-touch-icon.png'; a.style.display='none';
      document.body.appendChild(a); a.click(); a.remove();
    };
    reader.readAsDataURL(file);
  });
})();

/* ———— 呼吸引导（新增） ———— */
(function(){
  const overlay = document.getElementById('breathOverlay');
  const circle = document.getElementById('breathCircle');
  const label = document.getElementById('breathLabel');
  const btn = document.getElementById('btnBreath');
  const stop = document.getElementById('breathStop');
  const KEY = 'lili_breathing_mode_v1';
  let running=false, timer=null, phase=0; // 0 inhale,1 hold,2 exhale
  // 默认节奏（可扩展）：吸4s、憋1s、呼6s
  const inhale=4000, hold=1000, exhale=6000;
  function renderPhase(p){
    if(p===0){ label.textContent='吸气'; circle.style.transition='transform '+(inhale/1000)+'s ease-in-out'; circle.style.transform='scale(1.12)'; }
    else if(p===1){ label.textContent='憋住'; circle.style.transition='transform '+(hold/1000)+'s linear'; circle.style.transform='scale(1.14)'; }
    else { label.textContent='呼气'; circle.style.transition='transform '+(exhale/1000)+'s ease-in-out'; circle.style.transform='scale(.84)'; }
  }
  function step(){
    if(!running) return;
    phase = (phase+1)%3;
    renderPhase(phase);
    const delay = phase===0?inhale:phase===1?hold:exhale;
    timer = setTimeout(step, delay);
  }
  function start(){
    running=true; overlay.style.display='flex'; overlay.style.pointerEvents='auto'; phase=0; renderPhase(phase); timer = setTimeout(step, inhale);
    btn.textContent='停止呼吸';
    localStorage.setItem(KEY,'1');
  }
  function stopIt(){
    running=false; overlay.style.display='none'; overlay.style.pointerEvents='none'; clearTimeout(timer); btn.textContent='跟我做呼吸';
    localStorage.removeItem(KEY);
  }
  btn.addEventListener('click', ()=> {
    if(running) stopIt(); else start();
  });
  stop.addEventListener('click', stopIt);
  // 如果上次是开启状态，恢复
  if(localStorage.getItem(KEY)) start();
})();

/* ———— 吃药打卡（新增） ———— */
(function(){
  const medCard = document.getElementById('medCard');
  const toggle = document.getElementById('btnToggleMed');
  const KEY = 'lili_med_checkin_v1';
  function todayKey(){ const d=new Date(); return d.getFullYear()+'-'+(d.getMonth()+1)+'-'+d.getDate(); }
  function load(){ try{ return JSON.parse(localStorage.getItem(KEY)||'{}') }catch{ return {} } }
  function save(o){ localStorage.setItem(KEY, JSON.stringify(o)) }
  function render(){
    const data = load(); const t = todayKey();
    const morningBtn = document.getElementById('medMorning');
    const eveningBtn = document.getElementById('medEvening');
    const morningTime = document.getElementById('medMorningTime');
    const eveningTime = document.getElementById('medEveningTime');
    const today = data[t]||{};
    if(today.m){ morningBtn.textContent='早上 已打卡'; morningTime.textContent = today.m; } else { morningBtn.textContent='早上 打卡'; morningTime.textContent='未打卡' }
    if(today.e){ eveningBtn.textContent='晚上 已打卡'; eveningTime.textContent = today.e; } else { eveningBtn.textContent='晚上 打卡'; eveningTime.textContent='未打卡' }
  }
  toggle.addEventListener('click', ()=> { medCard.style.display = medCard.style.display==='none'?'block':'none'; });
  document.getElementById('medMorning').addEventListener('click', ()=>{
    const d=new Date(); const now = d.toLocaleTimeString(); const k=todayKey(); const obj=load(); obj[k]=obj[k]||{}; obj[k].m=now; save(obj); render(); ping('💊 早上已打卡');
  });
  document.getElementById('medEvening').addEventListener('click', ()=>{
    const d=new Date(); const now = d.toLocaleTimeString(); const k=todayKey(); const obj=load(); obj[k]=obj[k]||{}; obj[k].e=now; save(obj); render(); ping('💊 晚上已打卡');
  });
  document.getElementById('medClear').addEventListener('click', ()=>{
    const obj=load(); delete obj[todayKey()]; save(obj); render(); ping('🧼 今日打卡已重置');
  });
  // 渲染初次状态
  render();
})();

/* ———— 简易提示函数 ———— */
function ping(text){
  const n=document.createElement('div'); n.textContent=text;
  Object.assign(n.style,{position:'fixed',left:'50%',bottom:'calc(env(safe-area-inset-bottom) + 110px)',transform:'translateX(-50%)',padding:'10px 14px',borderRadius:'14px',color:'var(--ink)',background:'rgba(255,255,255,.10)',border:'1px solid rgba(255,255,255,.18)',backdropFilter:'blur(12px)',zIndex:999});
  document.body.appendChild(n); setTimeout(()=>{ n.style.transition='all .4s ease'; n.style.opacity='0'; n.style.transform='translateX(-50%) translateY(10px)'; },1600); setTimeout(()=>n.remove(),2200);
}

/* ———— 说明：我没有改动其他 UI 文案或布局——结束 ———— */
</script>
</body>
</html>
