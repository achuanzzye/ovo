<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="XPhone">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="XPhone">

    <meta name="apple-mobile-web-app-status-bar-style" content="black-opaque">
    <meta name="theme-color" content="#1e3c72">
    <meta name="msapplication-navbutton-color" content="#1e3c72">

    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <title>XPhone</title>
    <style>
        /* 全局重置 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        /* 确保HTML和BODY完全填充视口 */
        html, body {
            height: -webkit-fill-available;
            width: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        /* 背景容器 - 终极全屏方案 */
        .app-container {
            /* 将背景固定在视口上，并用 inset: 0 属性完全覆盖 */
            position: fixed;
            inset: 0;
            background: var(--bg-image, linear-gradient(135deg, #1e3c72 0%, #2a5298 100%));
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            overflow: hidden;
            z-index: 1; /* 确保背景在最底层，内容在上面 */
        }
    
        /* 页面容器 - 确保内容位于安全区域内 */
        .page {
            height: 100%;
            width: 100%;
            position: relative;
            /* 使用安全区域变量为内容添加内边距 */
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
            display: none; /* 默认隐藏所有页面 */
        }
    
        /* 页面头部 - 确保在状态栏下方显示 */
        .chat-header, .settings-header, .theme-header {
            /* 使用padding-top将内容推离安全区顶部 */
            padding-top: env(safe-area-inset-top);
            background: rgba(0,0,0,0.9);
            height: 60px; /* 您原来的高度 */
            display: flex;
            align-items: center;
            padding-left: 20px;
            padding-right: 20px;
            color: white;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
        }
    
        .home-screen {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 100%;
            padding: 40px 20px 150px 20px;
        }
    
        /* 聊天列表 - 调整高度以适应新的头部 */
        .chat-list {
            /* 减去头部和底部的总高度 */
            height: calc(100% - 60px); 
            overflow-y: auto;
            padding: 10px 0;
        }
    </style>
</head>
<body>
    <div class="pwa-hint" id="pwaHint">
        <button class="close-hint" onclick="closePwaHint()">×</button>
        <div class="pwa-hint-title">
            📱 获得完美全屏体验
        </div>
        <div class="pwa-hint-steps">
            点击下方分享按钮 📤 → 选择"添加到主屏幕" → 享受无边框体验！
        </div>
    </div>


    <div class="app-container" id="appContainer">
        <div class="home-screen" id="homeScreen">
            <div class="time-widget">
                <div class="time" id="currentTime"></div>
                <div class="date" id="currentDate"></div>
            </div>
            
            <div class="app-grid"></div>

            <div class="dock">
                <div class="app-icon" id="chat-app-icon" onclick="openChatApp()">💬</div>
                <div class="app-icon" id="settings-app-icon" onclick="openSettings()">⚙️</div>
                <div class="app-icon" id="theme-app-icon" onclick="openTheme()">🎨</div>
            </div>
        </div>

        <div class="chat-app" id="chatApp">
            <div class="chat-nav">
                <div class="nav-item active" onclick="switchTab('chats')">消息</div>
                <div class="nav-item" onclick="switchTab('contacts')">联系人</div>
                <div class="nav-item" onclick="switchTab('moments')">朋友圈</div>
                <div class="nav-item" onclick="switchTab('me')">我</div>
            </div>

            <div class="chat-list" id="chatList">
                <div class="empty-state">
                    <div class="empty-state-icon">💬</div>
                    <div>还没有联系人</div>
                    <div>点击右下角"+"添加AI朋友吧</div>
                </div>
            </div>

            <div class="moments-list" id="momentsList" style="display: none;">
                <div class="empty-state">
                    <div class="empty-state-icon">🌟</div>
                    <div>朋友圈还很安静</div>
                    <div>添加AI朋友开始互动吧</div>
                </div>
            </div>

            <div class="profile-screen" id="profileScreen" style="display: none;">
                <div class="profile-content">
                    <div class="avatar-upload">
                        <div class="profile-avatar" id="profileAvatar">😊</div>
                        <input type="file" accept="image/*" onchange="updateProfileAvatar(event)">
                    </div>
                    <div class="profile-name" id="profileName">我</div>
                    <div class="profile-bio" id="profileBio">这个人很懒，什么都没有留下...</div>
                    
                    <div class="profile-actions">
                        <button class="profile-btn" onclick="openEditProfileModal()">编辑个人资料</button>
                        <div class="data-actions">
                            <button class="data-btn" onclick="exportData()">导出数据</button>
                            <button class="data-btn" onclick="importData()">导入数据</button>
                        </div>
                    </div>
                </div>
            </div>

            <button class="add-contact-btn" onclick="openAddContactModal()" id="addContactBtn">+</button>
        </div>

        <div class="chat-screen" id="chatScreen">
            <div class="chat-header">
                <button class="back-btn" onclick="backToChatApp()">←</button>
                <div class="chat-title" id="chatTitle">AI助手</div>
            </div>
            <div class="chat-messages" id="chatMessages"></div>
            <div class="chat-input-area">
                <div class="chat-tools">
                    <button class="tool-btn" onclick="openImageModal()">🖼️</button>
                    <button class="tool-btn" onclick="openVoiceModal()">🎤</button>
                    <button class="tool-btn" onclick="openLinkModal()">🔗</button>
                    <button class="tool-btn" onclick="openMoneyModal()">💰</button>
                </div>
                <div class="chat-input">
                    <input type="text" id="messageInput" placeholder="输入消息..." onkeypress="handleKeyPress(event)">
                    <button class="send-btn" onclick="sendMessage()">
                        <span id="sendIcon">➤</span>
                    </button>
                </div>
            </div>
        </div>

        <div class="settings-screen" id="settingsScreen">
            <div class="settings-header">
                <button class="back-btn" onclick="goHome()">←</button>
                <div>API设置</div>
            </div>
            <div class="settings-content">
                <div class="setting-item">
                    <label class="setting-label">API服务商</label>
                    <select id="apiProvider" onchange="updateApiSettings()">
                        <option value="openai">OpenAI</option>
                        <option value="claude">Claude</option>
                        <option value="custom">自定义</option>
                    </select>
                </div>
                <div class="setting-item">
                    <label class="setting-label">API地址</label>
                    <input type="text" id="apiUrl" placeholder="https://api.openai.com/v1/chat/completions">
                </div>
                <div class="setting-item">
                    <label class="setting-label">API密钥</label>
                    <input type="password" id="apiKey" placeholder="输入你的API密钥">
                </div>
                <div class="setting-item">
                    <label class="setting-label">默认模型</label>
                    <input type="text" id="modelName" placeholder="gpt-3.5-turbo">
                </div>
                <div class="setting-item">
                    <button onclick="saveSettings()" style="width: 100%; padding: 12px; background: #007AFF; color: white; border: none; border-radius: 8px; cursor: pointer;">保存设置</button>
                </div>
            </div>
        </div>

        <div class="theme-screen" id="themeScreen">
            <div class="theme-header">
                <button class="back-btn" onclick="goHome()">←</button>
                <div>主题</div>
            </div>
            <div class="theme-content">
                <div class="theme-section">
                    <div class="theme-section-title">壁纸</div>
                    <div class="file-input-wrapper">
                        <input type="file" id="wallpaperFile" accept="image/*" onchange="uploadWallpaper(event)">
                        上传自定义壁纸
                    </div>
                    <p style="color: rgba(255,255,255,0.6); margin-top: 15px;">选择一张图片作为XPhone的壁纸</p>
                </div>
                <div class="theme-section">
                    <div class="theme-section-title">应用图标</div>
                    <label class="setting-label">选择应用</label>
                    <select class="modal-input" id="iconAppSelect">
                        <option value="chat">XChat</option>
                        <option value="settings">设置</option>
                        <option value="theme">主题</option>
                    </select>
                    <label class="setting-label">上传图标</label>
                    <div class="file-input-wrapper" style="width: 100%; margin: 0;">
                        <input type="file" id="iconImageFile" accept="image/*" onchange="updateAppIcon(event)">
                        选择图片
                    </div>
                    <button onclick="saveCustomIcon()" style="width: 100%; padding: 12px; background: #007AFF; color: white; border: none; border-radius: 8px; cursor: pointer; margin-top: 20px;">保存图标</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="addContactModal">
        <div class="modal-content">
            <div class="modal-header">添加AI联系人</div>
            <div class="modal-body">
                <input type="text" class="modal-input" id="contactName" placeholder="联系人姓名">
                <div class="avatar-upload" style="margin-bottom: 15px;">
                    <div style="width: 60px; height: 60px; border-radius: 30px; background: linear-gradient(135deg, #007AFF, #5AC8FA); margin: 0 auto; display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; background-size: cover; background-position: center;" id="newContactAvatar">🤖</div>
                    <input type="file" accept="image/*" onchange="updateContactAvatar(event)" style="position: absolute; opacity: 0; width: 100%; height: 100%; cursor: pointer;">
                </div>
                <textarea class="modal-textarea" id="contactPrompt" placeholder="个性化prompt，描述这个AI的特点和回答风格..."></textarea>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeModal()">取消</button>
                <button class="modal-btn confirm" onclick="addContact()">添加</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="editProfileModal">
        <div class="modal-content">
            <div class="modal-header">编辑个人资料</div>
            <div class="modal-body">
                <input type="text" class="modal-input" id="editProfileName" placeholder="您的昵称">
                <textarea class="modal-textarea" id="editProfileBio" placeholder="个人简介..."></textarea>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeModal()">取消</button>
                <button class="modal-btn confirm" onclick="saveProfile()">保存</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="commentModal">
        <div class="modal-content">
            <div class="modal-header">发表评论</div>
            <div class="modal-body">
                <textarea class="modal-textarea" id="commentInput" placeholder="写下你的评论..."></textarea>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeModal()">取消</button>
                <button class="modal-btn confirm" onclick="postComment()">发表</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="imageModal">
        <div class="modal-content">
            <div class="modal-header">📸 发送图片</div>
            <div class="modal-body">
                <input type="text" class="modal-input" id="imageTitle" placeholder="图片标题">
                <textarea class="modal-textarea" id="imageDesc" placeholder="请描述这张图片的内容..."></textarea>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeModal()">取消</button>
                <button class="modal-btn confirm" onclick="sendImage()">发送</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="voiceModal">
        <div class="modal-content">
            <div class="modal-header">🎤 发送语音</div>
            <div class="modal-body">
                <input type="text" class="modal-input" id="voiceDuration" placeholder="语音时长（秒）">
                <textarea class="modal-textarea" id="voiceContent" placeholder="请输入要发送的语音内容..."></textarea>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeModal()">取消</button>
                <button class="modal-btn confirm" onclick="sendVoice()">发送</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="linkModal">
        <div class="modal-content">
            <div class="modal-header">🔗 分享链接</div>
            <div class="modal-body">
                <input type="text" class="modal-input" id="linkTitle" placeholder="链接标题">
                <input type="text" class="modal-input" id="linkUrl" placeholder="链接地址">
                <textarea class="modal-textarea" id="linkDesc" placeholder="链接描述..."></textarea>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeModal()">取消</button>
                <button class="modal-btn confirm" onclick="sendLink()">发送</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="moneyModal">
        <div class="modal-content">
            <div class="modal-header">💰 转账红包</div>
            <div class="modal-body">
                <input type="number" class="modal-input" id="moneyAmount" placeholder="转账金额">
                <input type="text" class="modal-input" id="moneyNote" placeholder="转账备注">
                <select class="modal-input" id="moneyType">
                    <option value="transfer">转账</option>
                    <option value="redpack">红包</option>
                </select>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeModal()">取消</button>
                <button class="modal-btn confirm" onclick="sendMoney()">发送</button>
            </div>
        </div>
    </div>
    
    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="handleImportFile(event)">
    <script>
        // 精简全局状态管理
        const state = {
            currentContact: null,
            currentTab: 'chats',
            currentMomentId: null,
            contacts: [],
            messages: {},
            moments: [],
            profile: {
                name: '我',
                bio: '这个人很懒，什么都没有留下...',
                avatar: '😊'
            },
            appIcons: {
                chat: '💬',
                settings: '⚙️',
                theme: '🎨'
            },
            config: {
                apiProvider: 'openai',
                apiUrl: 'https://api.openai.com/v1/chat/completions',
                apiKey: '',
                modelName: 'gpt-3.5-turbo'
            }
        };

        // 初始化
        function initApp() {
            loadData();
            renderChatList();
            renderMoments();
            updateClock();
            setInterval(updateClock, 1000);
            initPWA();
        }

        // PWA功能初始化
        function initPWA() {
            // 检测是否已经在PWA模式下运行
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone || document.referrer.includes('android-app://');
            if (!isStandalone) {
                document.getElementById('pwaHint').style.display = 'block';
            }
        }

        function closePwaHint() {
            document.getElementById('pwaHint').classList.add('hidden');
        }

        // 更新时间
        function updateClock() {
            const now = new Date();
            const time = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', hour12: false });
            const date = now.toLocaleDateString('zh-CN', { month: 'long', day: 'numeric', weekday: 'long' });
            document.getElementById('currentTime').textContent = time;
            document.getElementById('currentDate').textContent = date;
        }

        // 导航控制
        function goHome() {
            document.getElementById('homeScreen').style.display = 'flex';
            document.getElementById('settingsScreen').style.display = 'none';
            document.getElementById('themeScreen').style.display = 'none';
        }

        function openChatApp() {
            document.getElementById('homeScreen').style.display = 'none';
            document.getElementById('chatApp').style.display = 'flex';
            document.getElementById('chatScreen').style.display = 'none';
            document.getElementById('addContactBtn').style.display = 'block';
        }

        function openSettings() {
            document.getElementById('homeScreen').style.display = 'none';
            document.getElementById('settingsScreen').style.display = 'flex';
        }

        function openTheme() {
            document.getElementById('homeScreen').style.display = 'none';
            document.getElementById('themeScreen').style.display = 'flex';
        }

        function openChat(contactId) {
            state.currentContact = state.contacts.find(c => c.id === contactId);
            document.getElementById('chatApp').style.display = 'none';
            document.getElementById('chatScreen').style.display = 'flex';
            document.getElementById('chatTitle').textContent = state.currentContact.name;
            document.getElementById('addContactBtn').style.display = 'none';
            renderMessages();
        }

        function backToChatApp() {
            document.getElementById('chatScreen').style.display = 'none';
            document.getElementById('chatApp').style.display = 'flex';
            document.getElementById('addContactBtn').style.display = 'block';
        }

        function switchTab(tabId) {
            state.currentTab = tabId;
            document.querySelectorAll('.chat-nav .nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.classList.add('active');

            document.getElementById('chatList').style.display = 'none';
            document.getElementById('momentsList').style.display = 'none';
            document.getElementById('profileScreen').style.display = 'none';

            if (tabId === 'chats') {
                document.getElementById('chatList').style.display = 'block';
                document.getElementById('addContactBtn').style.display = 'block';
            } else if (tabId === 'moments') {
                document.getElementById('momentsList').style.display = 'block';
                document.getElementById('addContactBtn').style.display = 'none';
            } else if (tabId === 'me') {
                document.getElementById('profileScreen').style.display = 'block';
                document.getElementById('addContactBtn').style.display = 'none';
            } else {
                // 联系人tab
                document.getElementById('chatList').style.display = 'block';
                document.getElementById('addContactBtn').style.display = 'block';
            }
        }

        // 聊天功能
        function renderMessages() {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';
            const messages = state.messages[state.currentContact.id] || [];
            messages.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${msg.sender === 'user' ? 'user' : 'ai'}`;
                
                const bubble = document.createElement('div');
                bubble.className = 'message-bubble';
                bubble.innerHTML = msg.content;
                
                messageDiv.appendChild(bubble);
                chatMessages.appendChild(messageDiv);
            });
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const messageText = input.value.trim();
            if (messageText === '') return;

            const userMessage = { sender: 'user', content: messageText };
            if (!state.messages[state.currentContact.id]) {
                state.messages[state.currentContact.id] = [];
            }
            state.messages[state.currentContact.id].push(userMessage);
            renderMessages();
            input.value = '';

            const aiMessage = { sender: 'ai', content: `<div class="loading"></div>` };
            state.messages[state.currentContact.id].push(aiMessage);
            renderMessages();
            
            try {
                // 模拟 API 调用
                const response = await fetch('https://api.example.com/ai_response', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: messageText, contact: state.currentContact.name })
                });
                const data = await response.json();
                state.messages[state.currentContact.id][state.messages[state.currentContact.id].length - 1].content = data.response;
            } catch (error) {
                state.messages[state.currentContact.id][state.messages[state.currentContact.id].length - 1].content = '网络错误，请稍后重试。';
            }
            
            renderMessages();
            saveData();
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }
        
        // 联系人/朋友圈功能
        function renderChatList() {
            const chatList = document.getElementById('chatList');
            chatList.innerHTML = '';
            state.contacts.forEach(contact => {
                const item = document.createElement('div');
                item.className = 'chat-item';
                item.onclick = () => openChat(contact.id);
                item.innerHTML = `
                    <div class="chat-avatar" style="background-image: url(${contact.avatar})">${contact.avatar.startsWith('data') ? '' : contact.avatar}</div>
                    <div class="chat-info">
                        <div class="chat-name">${contact.name}</div>
                        <div class="chat-preview">点击开始聊天...</div>
                    </div>
                `;
                chatList.appendChild(item);
            });
        }

        function renderMoments() {
            const momentsList = document.getElementById('momentsList');
            momentsList.innerHTML = '';
            state.moments.forEach(moment => {
                const item = document.createElement('div');
                item.className = 'moment-item';
                item.innerHTML = `
                    <div class="moment-header">
                        <div class="chat-avatar" style="background-image: url(${moment.author.avatar})">${moment.author.avatar.startsWith('data') ? '' : moment.author.avatar}</div>
                        <div class="chat-info">
                            <div class="chat-name">${moment.author.name}</div>
                            <div class="moment-time">${moment.time}</div>
                        </div>
                    </div>
                    <div class="moment-content">${moment.content}</div>
                    <div class="moment-actions">
                        <span class="moment-action" onclick="toggleLike('${moment.id}')">❤️ ${moment.likes.length}</span>
                        <span class="moment-action" onclick="openCommentModal('${moment.id}')">💬 ${moment.comments.length}</span>
                    </div>
                    ${moment.comments.length > 0 ? `<div class="moment-comments">
                        ${moment.comments.map(c => `<div class="comment-item"><span class="comment-author">${c.author}：</span>${c.text}</div>`).join('')}
                    </div>` : ''}
                `;
                momentsList.appendChild(item);
            });
        }

        function openAddContactModal() {
            document.getElementById('addContactModal').style.display = 'flex';
        }

        function addContact() {
            const name = document.getElementById('contactName').value;
            const prompt = document.getElementById('contactPrompt').value;
            const avatar = document.getElementById('newContactAvatar').style.backgroundImage.slice(5, -2) || '🤖';
            if (!name || !prompt) {
                alert('姓名和prompt不能为空！');
                return;
            }
            const newContact = {
                id: Date.now(),
                name,
                prompt,
                avatar,
            };
            state.contacts.push(newContact);
            saveData();
            renderChatList();
            closeModal();
        }

        // 个人资料
        function openEditProfileModal() {
            document.getElementById('editProfileName').value = state.profile.name;
            document.getElementById('editProfileBio').value = state.profile.bio;
            document.getElementById('editProfileModal').style.display = 'flex';
        }

        function saveProfile() {
            state.profile.name = document.getElementById('editProfileName').value;
            state.profile.bio = document.getElementById('editProfileBio').value;
            saveData();
            closeModal();
            updateProfile();
        }

        function updateProfile() {
            document.getElementById('profileName').textContent = state.profile.name;
            document.getElementById('profileBio').textContent = state.profile.bio;
            if (state.profile.avatar.startsWith('data')) {
                document.getElementById('profileAvatar').textContent = '';
                document.getElementById('profileAvatar').style.backgroundImage = `url(${state.profile.avatar})`;
            } else {
                document.getElementById('profileAvatar').textContent = state.profile.avatar;
            }
        }

        function updateProfileAvatar(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    state.profile.avatar = e.target.result;
                    saveData();
                    updateProfile();
                };
                reader.readAsDataURL(file);
            }
        }

        function updateContactAvatar(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const avatarDiv = document.getElementById('newContactAvatar');
                    avatarDiv.textContent = '';
                    avatarDiv.style.backgroundImage = `url(${e.target.result})`;
                };
                reader.readAsDataURL(file);
            }
        }

        // 数据持久化
        function saveData() {
            localStorage.setItem('xphone_state', JSON.stringify(state));
        }

        function loadData() {
            const savedState = localStorage.getItem('xphone_state');
            if (savedState) {
                const parsedState = JSON.parse(savedState);
                Object.assign(state, parsedState);
            }
            updateProfile();
            updateAppIcons();
        }

        // API设置
        function updateApiSettings() {
            const provider = document.getElementById('apiProvider').value;
            let url = '';
            let model = '';
            if (provider === 'openai') {
                url = 'https://api.openai.com/v1/chat/completions';
                model = 'gpt-3.5-turbo';
            } else if (provider === 'claude') {
                url = 'https://api.anthropic.com/v1/messages';
                model = 'claude-3-opus-20240229';
            }
            document.getElementById('apiUrl').value = url;
            document.getElementById('modelName').value = model;
        }

        function saveSettings() {
            state.config.apiProvider = document.getElementById('apiProvider').value;
            state.config.apiUrl = document.getElementById('apiUrl').value;
            state.config.apiKey = document.getElementById('apiKey').value;
            state.config.modelName = document.getElementById('modelName').value;
            saveData();
            alert('设置已保存！');
        }

        // 主题功能
        function uploadWallpaper(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.documentElement.style.setProperty('--bg-image', `url(${e.target.result})`);
                    state.wallpaper = e.target.result;
                    saveData();
                };
                reader.readAsDataURL(file);
            }
        }

        function updateAppIcon(event) {
            const file = event.target.files[0];
            const app = document.getElementById('iconAppSelect').value;
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    state.appIcons[app] = e.target.result;
                    saveData();
                    updateAppIcons();
                };
                reader.readAsDataURL(file);
            }
        }

        function updateAppIcons() {
            for (const app in state.appIcons) {
                const iconElement = document.getElementById(`${app}-app-icon`);
                if (iconElement) {
                    const icon = state.appIcons[app];
                    if (icon.startsWith('data')) {
                        iconElement.textContent = '';
                        iconElement.style.backgroundImage = `url(${icon})`;
                    } else {
                        iconElement.textContent = icon;
                    }
                }
            }
        }

        // 数据导入导出
        function exportData() {
            const dataStr = JSON.stringify(state, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'xphone_data.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function importData() {
            document.getElementById('importFile').click();
        }

        function handleImportFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedState = JSON.parse(e.target.result);
                    Object.assign(state, importedState);
                    saveData();
                    initApp();
                    alert('数据导入成功！');
                } catch (error) {
                    alert('导入失败：' + error.message);
                }
            };
            reader.readAsText(file);
        }

        // 模态框控制
        function openImageModal() { document.getElementById('imageModal').style.display = 'flex'; }
        function openVoiceModal() { document.getElementById('voiceModal').style.display = 'flex'; }
        function openLinkModal() { document.getElementById('linkModal').style.display = 'flex'; }
        function openMoneyModal() { document.getElementById('moneyModal').style.display = 'flex'; }
    
        function closeModal() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.style.display = 'none';
            });
            document.querySelectorAll('.modal-input, .modal-textarea').forEach(input => {
                input.value = '';
            });
        }
    
        // 点击模态框外部关闭
        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal')) {
                closeModal();
            }
        });
    
        // 阻止滚动穿透
        document.addEventListener('touchmove', function(event) {
            if (document.querySelector('.modal[style*="flex"]')) {
                event.preventDefault();
            }
        }, { passive: false });
    
        // 初始化应用
        window.addEventListener('load', function() {
            initApp();
        });
    </script>
</body>
</html>
