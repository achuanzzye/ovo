<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="XPhone">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="XPhone">

    <meta name="apple-mobile-web-app-status-bar-style" content="black-opaque">
    <meta name="theme-color" content="#1e3c72">
    <meta name="msapplication-navbutton-color" content="#1e3c72">

    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <title>XPhone</title>
    <style>
        /* å…¨å±€é‡ç½® */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        /* ç¡®ä¿HTMLå’ŒBODYå®Œå…¨å¡«å……è§†å£ */
        html, body {
            height: -webkit-fill-available;
            width: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        /* èƒŒæ™¯å®¹å™¨ - ç»ˆæå…¨å±æ–¹æ¡ˆ */
        .app-container {
            /* å°†èƒŒæ™¯å›ºå®šåœ¨è§†å£ä¸Šï¼Œå¹¶ç”¨ inset: 0 å±æ€§å®Œå…¨è¦†ç›– */
            position: fixed;
            inset: 0;
            background: var(--bg-image, linear-gradient(135deg, #1e3c72 0%, #2a5298 100%));
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            overflow: hidden;
            z-index: 1; /* ç¡®ä¿èƒŒæ™¯åœ¨æœ€åº•å±‚ï¼Œå†…å®¹åœ¨ä¸Šé¢ */
        }
    
        /* é¡µé¢å®¹å™¨ - ç¡®ä¿å†…å®¹ä½äºå®‰å…¨åŒºåŸŸå†… */
        .page {
            height: 100%;
            width: 100%;
            position: relative;
            /* ä½¿ç”¨å®‰å…¨åŒºåŸŸå˜é‡ä¸ºå†…å®¹æ·»åŠ å†…è¾¹è· */
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
            display: none; /* é»˜è®¤éšè—æ‰€æœ‰é¡µé¢ */
        }
    
        /* é¡µé¢å¤´éƒ¨ - ç¡®ä¿åœ¨çŠ¶æ€æ ä¸‹æ–¹æ˜¾ç¤º */
        .chat-header, .settings-header, .theme-header {
            /* ä½¿ç”¨padding-topå°†å†…å®¹æ¨ç¦»å®‰å…¨åŒºé¡¶éƒ¨ */
            padding-top: env(safe-area-inset-top);
            background: rgba(0,0,0,0.9);
            height: 60px; /* æ‚¨åŸæ¥çš„é«˜åº¦ */
            display: flex;
            align-items: center;
            padding-left: 20px;
            padding-right: 20px;
            color: white;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
        }
    
        .home-screen {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 100%;
            padding: 40px 20px 150px 20px;
        }
    
        /* èŠå¤©åˆ—è¡¨ - è°ƒæ•´é«˜åº¦ä»¥é€‚åº”æ–°çš„å¤´éƒ¨ */
        .chat-list {
            /* å‡å»å¤´éƒ¨å’Œåº•éƒ¨çš„æ€»é«˜åº¦ */
            height: calc(100% - 60px); 
            overflow-y: auto;
            padding: 10px 0;
        }
    </style>
</head>
<body>
    <div class="pwa-hint" id="pwaHint">
        <button class="close-hint" onclick="closePwaHint()">Ã—</button>
        <div class="pwa-hint-title">
            ğŸ“± è·å¾—å®Œç¾å…¨å±ä½“éªŒ
        </div>
        <div class="pwa-hint-steps">
            ç‚¹å‡»ä¸‹æ–¹åˆ†äº«æŒ‰é’® ğŸ“¤ â†’ é€‰æ‹©"æ·»åŠ åˆ°ä¸»å±å¹•" â†’ äº«å—æ— è¾¹æ¡†ä½“éªŒï¼
        </div>
    </div>


    <div class="app-container" id="appContainer">
        <div class="home-screen" id="homeScreen">
            <div class="time-widget">
                <div class="time" id="currentTime"></div>
                <div class="date" id="currentDate"></div>
            </div>
            
            <div class="app-grid"></div>

            <div class="dock">
                <div class="app-icon" id="chat-app-icon" onclick="openChatApp()">ğŸ’¬</div>
                <div class="app-icon" id="settings-app-icon" onclick="openSettings()">âš™ï¸</div>
                <div class="app-icon" id="theme-app-icon" onclick="openTheme()">ğŸ¨</div>
            </div>
        </div>

        <div class="chat-app" id="chatApp">
            <div class="chat-nav">
                <div class="nav-item active" onclick="switchTab('chats')">æ¶ˆæ¯</div>
                <div class="nav-item" onclick="switchTab('contacts')">è”ç³»äºº</div>
                <div class="nav-item" onclick="switchTab('moments')">æœ‹å‹åœˆ</div>
                <div class="nav-item" onclick="switchTab('me')">æˆ‘</div>
            </div>

            <div class="chat-list" id="chatList">
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ’¬</div>
                    <div>è¿˜æ²¡æœ‰è”ç³»äºº</div>
                    <div>ç‚¹å‡»å³ä¸‹è§’"+"æ·»åŠ AIæœ‹å‹å§</div>
                </div>
            </div>

            <div class="moments-list" id="momentsList" style="display: none;">
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸŒŸ</div>
                    <div>æœ‹å‹åœˆè¿˜å¾ˆå®‰é™</div>
                    <div>æ·»åŠ AIæœ‹å‹å¼€å§‹äº’åŠ¨å§</div>
                </div>
            </div>

            <div class="profile-screen" id="profileScreen" style="display: none;">
                <div class="profile-content">
                    <div class="avatar-upload">
                        <div class="profile-avatar" id="profileAvatar">ğŸ˜Š</div>
                        <input type="file" accept="image/*" onchange="updateProfileAvatar(event)">
                    </div>
                    <div class="profile-name" id="profileName">æˆ‘</div>
                    <div class="profile-bio" id="profileBio">è¿™ä¸ªäººå¾ˆæ‡’ï¼Œä»€ä¹ˆéƒ½æ²¡æœ‰ç•™ä¸‹...</div>
                    
                    <div class="profile-actions">
                        <button class="profile-btn" onclick="openEditProfileModal()">ç¼–è¾‘ä¸ªäººèµ„æ–™</button>
                        <div class="data-actions">
                            <button class="data-btn" onclick="exportData()">å¯¼å‡ºæ•°æ®</button>
                            <button class="data-btn" onclick="importData()">å¯¼å…¥æ•°æ®</button>
                        </div>
                    </div>
                </div>
            </div>

            <button class="add-contact-btn" onclick="openAddContactModal()" id="addContactBtn">+</button>
        </div>

        <div class="chat-screen" id="chatScreen">
            <div class="chat-header">
                <button class="back-btn" onclick="backToChatApp()">â†</button>
                <div class="chat-title" id="chatTitle">AIåŠ©æ‰‹</div>
            </div>
            <div class="chat-messages" id="chatMessages"></div>
            <div class="chat-input-area">
                <div class="chat-tools">
                    <button class="tool-btn" onclick="openImageModal()">ğŸ–¼ï¸</button>
                    <button class="tool-btn" onclick="openVoiceModal()">ğŸ¤</button>
                    <button class="tool-btn" onclick="openLinkModal()">ğŸ”—</button>
                    <button class="tool-btn" onclick="openMoneyModal()">ğŸ’°</button>
                </div>
                <div class="chat-input">
                    <input type="text" id="messageInput" placeholder="è¾“å…¥æ¶ˆæ¯..." onkeypress="handleKeyPress(event)">
                    <button class="send-btn" onclick="sendMessage()">
                        <span id="sendIcon">â¤</span>
                    </button>
                </div>
            </div>
        </div>

        <div class="settings-screen" id="settingsScreen">
            <div class="settings-header">
                <button class="back-btn" onclick="goHome()">â†</button>
                <div>APIè®¾ç½®</div>
            </div>
            <div class="settings-content">
                <div class="setting-item">
                    <label class="setting-label">APIæœåŠ¡å•†</label>
                    <select id="apiProvider" onchange="updateApiSettings()">
                        <option value="openai">OpenAI</option>
                        <option value="claude">Claude</option>
                        <option value="custom">è‡ªå®šä¹‰</option>
                    </select>
                </div>
                <div class="setting-item">
                    <label class="setting-label">APIåœ°å€</label>
                    <input type="text" id="apiUrl" placeholder="https://api.openai.com/v1/chat/completions">
                </div>
                <div class="setting-item">
                    <label class="setting-label">APIå¯†é’¥</label>
                    <input type="password" id="apiKey" placeholder="è¾“å…¥ä½ çš„APIå¯†é’¥">
                </div>
                <div class="setting-item">
                    <label class="setting-label">é»˜è®¤æ¨¡å‹</label>
                    <input type="text" id="modelName" placeholder="gpt-3.5-turbo">
                </div>
                <div class="setting-item">
                    <button onclick="saveSettings()" style="width: 100%; padding: 12px; background: #007AFF; color: white; border: none; border-radius: 8px; cursor: pointer;">ä¿å­˜è®¾ç½®</button>
                </div>
            </div>
        </div>

        <div class="theme-screen" id="themeScreen">
            <div class="theme-header">
                <button class="back-btn" onclick="goHome()">â†</button>
                <div>ä¸»é¢˜</div>
            </div>
            <div class="theme-content">
                <div class="theme-section">
                    <div class="theme-section-title">å£çº¸</div>
                    <div class="file-input-wrapper">
                        <input type="file" id="wallpaperFile" accept="image/*" onchange="uploadWallpaper(event)">
                        ä¸Šä¼ è‡ªå®šä¹‰å£çº¸
                    </div>
                    <p style="color: rgba(255,255,255,0.6); margin-top: 15px;">é€‰æ‹©ä¸€å¼ å›¾ç‰‡ä½œä¸ºXPhoneçš„å£çº¸</p>
                </div>
                <div class="theme-section">
                    <div class="theme-section-title">åº”ç”¨å›¾æ ‡</div>
                    <label class="setting-label">é€‰æ‹©åº”ç”¨</label>
                    <select class="modal-input" id="iconAppSelect">
                        <option value="chat">XChat</option>
                        <option value="settings">è®¾ç½®</option>
                        <option value="theme">ä¸»é¢˜</option>
                    </select>
                    <label class="setting-label">ä¸Šä¼ å›¾æ ‡</label>
                    <div class="file-input-wrapper" style="width: 100%; margin: 0;">
                        <input type="file" id="iconImageFile" accept="image/*" onchange="updateAppIcon(event)">
                        é€‰æ‹©å›¾ç‰‡
                    </div>
                    <button onclick="saveCustomIcon()" style="width: 100%; padding: 12px; background: #007AFF; color: white; border: none; border-radius: 8px; cursor: pointer; margin-top: 20px;">ä¿å­˜å›¾æ ‡</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="addContactModal">
        <div class="modal-content">
            <div class="modal-header">æ·»åŠ AIè”ç³»äºº</div>
            <div class="modal-body">
                <input type="text" class="modal-input" id="contactName" placeholder="è”ç³»äººå§“å">
                <div class="avatar-upload" style="margin-bottom: 15px;">
                    <div style="width: 60px; height: 60px; border-radius: 30px; background: linear-gradient(135deg, #007AFF, #5AC8FA); margin: 0 auto; display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; background-size: cover; background-position: center;" id="newContactAvatar">ğŸ¤–</div>
                    <input type="file" accept="image/*" onchange="updateContactAvatar(event)" style="position: absolute; opacity: 0; width: 100%; height: 100%; cursor: pointer;">
                </div>
                <textarea class="modal-textarea" id="contactPrompt" placeholder="ä¸ªæ€§åŒ–promptï¼Œæè¿°è¿™ä¸ªAIçš„ç‰¹ç‚¹å’Œå›ç­”é£æ ¼..."></textarea>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="modal-btn confirm" onclick="addContact()">æ·»åŠ </button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="editProfileModal">
        <div class="modal-content">
            <div class="modal-header">ç¼–è¾‘ä¸ªäººèµ„æ–™</div>
            <div class="modal-body">
                <input type="text" class="modal-input" id="editProfileName" placeholder="æ‚¨çš„æ˜µç§°">
                <textarea class="modal-textarea" id="editProfileBio" placeholder="ä¸ªäººç®€ä»‹..."></textarea>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="modal-btn confirm" onclick="saveProfile()">ä¿å­˜</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="commentModal">
        <div class="modal-content">
            <div class="modal-header">å‘è¡¨è¯„è®º</div>
            <div class="modal-body">
                <textarea class="modal-textarea" id="commentInput" placeholder="å†™ä¸‹ä½ çš„è¯„è®º..."></textarea>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="modal-btn confirm" onclick="postComment()">å‘è¡¨</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="imageModal">
        <div class="modal-content">
            <div class="modal-header">ğŸ“¸ å‘é€å›¾ç‰‡</div>
            <div class="modal-body">
                <input type="text" class="modal-input" id="imageTitle" placeholder="å›¾ç‰‡æ ‡é¢˜">
                <textarea class="modal-textarea" id="imageDesc" placeholder="è¯·æè¿°è¿™å¼ å›¾ç‰‡çš„å†…å®¹..."></textarea>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="modal-btn confirm" onclick="sendImage()">å‘é€</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="voiceModal">
        <div class="modal-content">
            <div class="modal-header">ğŸ¤ å‘é€è¯­éŸ³</div>
            <div class="modal-body">
                <input type="text" class="modal-input" id="voiceDuration" placeholder="è¯­éŸ³æ—¶é•¿ï¼ˆç§’ï¼‰">
                <textarea class="modal-textarea" id="voiceContent" placeholder="è¯·è¾“å…¥è¦å‘é€çš„è¯­éŸ³å†…å®¹..."></textarea>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="modal-btn confirm" onclick="sendVoice()">å‘é€</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="linkModal">
        <div class="modal-content">
            <div class="modal-header">ğŸ”— åˆ†äº«é“¾æ¥</div>
            <div class="modal-body">
                <input type="text" class="modal-input" id="linkTitle" placeholder="é“¾æ¥æ ‡é¢˜">
                <input type="text" class="modal-input" id="linkUrl" placeholder="é“¾æ¥åœ°å€">
                <textarea class="modal-textarea" id="linkDesc" placeholder="é“¾æ¥æè¿°..."></textarea>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="modal-btn confirm" onclick="sendLink()">å‘é€</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="moneyModal">
        <div class="modal-content">
            <div class="modal-header">ğŸ’° è½¬è´¦çº¢åŒ…</div>
            <div class="modal-body">
                <input type="number" class="modal-input" id="moneyAmount" placeholder="è½¬è´¦é‡‘é¢">
                <input type="text" class="modal-input" id="moneyNote" placeholder="è½¬è´¦å¤‡æ³¨">
                <select class="modal-input" id="moneyType">
                    <option value="transfer">è½¬è´¦</option>
                    <option value="redpack">çº¢åŒ…</option>
                </select>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="modal-btn confirm" onclick="sendMoney()">å‘é€</button>
            </div>
        </div>
    </div>
    
    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="handleImportFile(event)">
    <script>
        // ç²¾ç®€å…¨å±€çŠ¶æ€ç®¡ç†
        const state = {
            currentContact: null,
            currentTab: 'chats',
            currentMomentId: null,
            contacts: [],
            messages: {},
            moments: [],
            profile: {
                name: 'æˆ‘',
                bio: 'è¿™ä¸ªäººå¾ˆæ‡’ï¼Œä»€ä¹ˆéƒ½æ²¡æœ‰ç•™ä¸‹...',
                avatar: 'ğŸ˜Š'
            },
            appIcons: {
                chat: 'ğŸ’¬',
                settings: 'âš™ï¸',
                theme: 'ğŸ¨'
            },
            config: {
                apiProvider: 'openai',
                apiUrl: 'https://api.openai.com/v1/chat/completions',
                apiKey: '',
                modelName: 'gpt-3.5-turbo'
            }
        };

        // åˆå§‹åŒ–
        function initApp() {
            loadData();
            renderChatList();
            renderMoments();
            updateClock();
            setInterval(updateClock, 1000);
            initPWA();
        }

        // PWAåŠŸèƒ½åˆå§‹åŒ–
        function initPWA() {
            // æ£€æµ‹æ˜¯å¦å·²ç»åœ¨PWAæ¨¡å¼ä¸‹è¿è¡Œ
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone || document.referrer.includes('android-app://');
            if (!isStandalone) {
                document.getElementById('pwaHint').style.display = 'block';
            }
        }

        function closePwaHint() {
            document.getElementById('pwaHint').classList.add('hidden');
        }

        // æ›´æ–°æ—¶é—´
        function updateClock() {
            const now = new Date();
            const time = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', hour12: false });
            const date = now.toLocaleDateString('zh-CN', { month: 'long', day: 'numeric', weekday: 'long' });
            document.getElementById('currentTime').textContent = time;
            document.getElementById('currentDate').textContent = date;
        }

        // å¯¼èˆªæ§åˆ¶
        function goHome() {
            document.getElementById('homeScreen').style.display = 'flex';
            document.getElementById('settingsScreen').style.display = 'none';
            document.getElementById('themeScreen').style.display = 'none';
        }

        function openChatApp() {
            document.getElementById('homeScreen').style.display = 'none';
            document.getElementById('chatApp').style.display = 'flex';
            document.getElementById('chatScreen').style.display = 'none';
            document.getElementById('addContactBtn').style.display = 'block';
        }

        function openSettings() {
            document.getElementById('homeScreen').style.display = 'none';
            document.getElementById('settingsScreen').style.display = 'flex';
        }

        function openTheme() {
            document.getElementById('homeScreen').style.display = 'none';
            document.getElementById('themeScreen').style.display = 'flex';
        }

        function openChat(contactId) {
            state.currentContact = state.contacts.find(c => c.id === contactId);
            document.getElementById('chatApp').style.display = 'none';
            document.getElementById('chatScreen').style.display = 'flex';
            document.getElementById('chatTitle').textContent = state.currentContact.name;
            document.getElementById('addContactBtn').style.display = 'none';
            renderMessages();
        }

        function backToChatApp() {
            document.getElementById('chatScreen').style.display = 'none';
            document.getElementById('chatApp').style.display = 'flex';
            document.getElementById('addContactBtn').style.display = 'block';
        }

        function switchTab(tabId) {
            state.currentTab = tabId;
            document.querySelectorAll('.chat-nav .nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.classList.add('active');

            document.getElementById('chatList').style.display = 'none';
            document.getElementById('momentsList').style.display = 'none';
            document.getElementById('profileScreen').style.display = 'none';

            if (tabId === 'chats') {
                document.getElementById('chatList').style.display = 'block';
                document.getElementById('addContactBtn').style.display = 'block';
            } else if (tabId === 'moments') {
                document.getElementById('momentsList').style.display = 'block';
                document.getElementById('addContactBtn').style.display = 'none';
            } else if (tabId === 'me') {
                document.getElementById('profileScreen').style.display = 'block';
                document.getElementById('addContactBtn').style.display = 'none';
            } else {
                // è”ç³»äººtab
                document.getElementById('chatList').style.display = 'block';
                document.getElementById('addContactBtn').style.display = 'block';
            }
        }

        // èŠå¤©åŠŸèƒ½
        function renderMessages() {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';
            const messages = state.messages[state.currentContact.id] || [];
            messages.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${msg.sender === 'user' ? 'user' : 'ai'}`;
                
                const bubble = document.createElement('div');
                bubble.className = 'message-bubble';
                bubble.innerHTML = msg.content;
                
                messageDiv.appendChild(bubble);
                chatMessages.appendChild(messageDiv);
            });
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const messageText = input.value.trim();
            if (messageText === '') return;

            const userMessage = { sender: 'user', content: messageText };
            if (!state.messages[state.currentContact.id]) {
                state.messages[state.currentContact.id] = [];
            }
            state.messages[state.currentContact.id].push(userMessage);
            renderMessages();
            input.value = '';

            const aiMessage = { sender: 'ai', content: `<div class="loading"></div>` };
            state.messages[state.currentContact.id].push(aiMessage);
            renderMessages();
            
            try {
                // æ¨¡æ‹Ÿ API è°ƒç”¨
                const response = await fetch('https://api.example.com/ai_response', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: messageText, contact: state.currentContact.name })
                });
                const data = await response.json();
                state.messages[state.currentContact.id][state.messages[state.currentContact.id].length - 1].content = data.response;
            } catch (error) {
                state.messages[state.currentContact.id][state.messages[state.currentContact.id].length - 1].content = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•ã€‚';
            }
            
            renderMessages();
            saveData();
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }
        
        // è”ç³»äºº/æœ‹å‹åœˆåŠŸèƒ½
        function renderChatList() {
            const chatList = document.getElementById('chatList');
            chatList.innerHTML = '';
            state.contacts.forEach(contact => {
                const item = document.createElement('div');
                item.className = 'chat-item';
                item.onclick = () => openChat(contact.id);
                item.innerHTML = `
                    <div class="chat-avatar" style="background-image: url(${contact.avatar})">${contact.avatar.startsWith('data') ? '' : contact.avatar}</div>
                    <div class="chat-info">
                        <div class="chat-name">${contact.name}</div>
                        <div class="chat-preview">ç‚¹å‡»å¼€å§‹èŠå¤©...</div>
                    </div>
                `;
                chatList.appendChild(item);
            });
        }

        function renderMoments() {
            const momentsList = document.getElementById('momentsList');
            momentsList.innerHTML = '';
            state.moments.forEach(moment => {
                const item = document.createElement('div');
                item.className = 'moment-item';
                item.innerHTML = `
                    <div class="moment-header">
                        <div class="chat-avatar" style="background-image: url(${moment.author.avatar})">${moment.author.avatar.startsWith('data') ? '' : moment.author.avatar}</div>
                        <div class="chat-info">
                            <div class="chat-name">${moment.author.name}</div>
                            <div class="moment-time">${moment.time}</div>
                        </div>
                    </div>
                    <div class="moment-content">${moment.content}</div>
                    <div class="moment-actions">
                        <span class="moment-action" onclick="toggleLike('${moment.id}')">â¤ï¸ ${moment.likes.length}</span>
                        <span class="moment-action" onclick="openCommentModal('${moment.id}')">ğŸ’¬ ${moment.comments.length}</span>
                    </div>
                    ${moment.comments.length > 0 ? `<div class="moment-comments">
                        ${moment.comments.map(c => `<div class="comment-item"><span class="comment-author">${c.author}ï¼š</span>${c.text}</div>`).join('')}
                    </div>` : ''}
                `;
                momentsList.appendChild(item);
            });
        }

        function openAddContactModal() {
            document.getElementById('addContactModal').style.display = 'flex';
        }

        function addContact() {
            const name = document.getElementById('contactName').value;
            const prompt = document.getElementById('contactPrompt').value;
            const avatar = document.getElementById('newContactAvatar').style.backgroundImage.slice(5, -2) || 'ğŸ¤–';
            if (!name || !prompt) {
                alert('å§“åå’Œpromptä¸èƒ½ä¸ºç©ºï¼');
                return;
            }
            const newContact = {
                id: Date.now(),
                name,
                prompt,
                avatar,
            };
            state.contacts.push(newContact);
            saveData();
            renderChatList();
            closeModal();
        }

        // ä¸ªäººèµ„æ–™
        function openEditProfileModal() {
            document.getElementById('editProfileName').value = state.profile.name;
            document.getElementById('editProfileBio').value = state.profile.bio;
            document.getElementById('editProfileModal').style.display = 'flex';
        }

        function saveProfile() {
            state.profile.name = document.getElementById('editProfileName').value;
            state.profile.bio = document.getElementById('editProfileBio').value;
            saveData();
            closeModal();
            updateProfile();
        }

        function updateProfile() {
            document.getElementById('profileName').textContent = state.profile.name;
            document.getElementById('profileBio').textContent = state.profile.bio;
            if (state.profile.avatar.startsWith('data')) {
                document.getElementById('profileAvatar').textContent = '';
                document.getElementById('profileAvatar').style.backgroundImage = `url(${state.profile.avatar})`;
            } else {
                document.getElementById('profileAvatar').textContent = state.profile.avatar;
            }
        }

        function updateProfileAvatar(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    state.profile.avatar = e.target.result;
                    saveData();
                    updateProfile();
                };
                reader.readAsDataURL(file);
            }
        }

        function updateContactAvatar(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const avatarDiv = document.getElementById('newContactAvatar');
                    avatarDiv.textContent = '';
                    avatarDiv.style.backgroundImage = `url(${e.target.result})`;
                };
                reader.readAsDataURL(file);
            }
        }

        // æ•°æ®æŒä¹…åŒ–
        function saveData() {
            localStorage.setItem('xphone_state', JSON.stringify(state));
        }

        function loadData() {
            const savedState = localStorage.getItem('xphone_state');
            if (savedState) {
                const parsedState = JSON.parse(savedState);
                Object.assign(state, parsedState);
            }
            updateProfile();
            updateAppIcons();
        }

        // APIè®¾ç½®
        function updateApiSettings() {
            const provider = document.getElementById('apiProvider').value;
            let url = '';
            let model = '';
            if (provider === 'openai') {
                url = 'https://api.openai.com/v1/chat/completions';
                model = 'gpt-3.5-turbo';
            } else if (provider === 'claude') {
                url = 'https://api.anthropic.com/v1/messages';
                model = 'claude-3-opus-20240229';
            }
            document.getElementById('apiUrl').value = url;
            document.getElementById('modelName').value = model;
        }

        function saveSettings() {
            state.config.apiProvider = document.getElementById('apiProvider').value;
            state.config.apiUrl = document.getElementById('apiUrl').value;
            state.config.apiKey = document.getElementById('apiKey').value;
            state.config.modelName = document.getElementById('modelName').value;
            saveData();
            alert('è®¾ç½®å·²ä¿å­˜ï¼');
        }

        // ä¸»é¢˜åŠŸèƒ½
        function uploadWallpaper(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.documentElement.style.setProperty('--bg-image', `url(${e.target.result})`);
                    state.wallpaper = e.target.result;
                    saveData();
                };
                reader.readAsDataURL(file);
            }
        }

        function updateAppIcon(event) {
            const file = event.target.files[0];
            const app = document.getElementById('iconAppSelect').value;
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    state.appIcons[app] = e.target.result;
                    saveData();
                    updateAppIcons();
                };
                reader.readAsDataURL(file);
            }
        }

        function updateAppIcons() {
            for (const app in state.appIcons) {
                const iconElement = document.getElementById(`${app}-app-icon`);
                if (iconElement) {
                    const icon = state.appIcons[app];
                    if (icon.startsWith('data')) {
                        iconElement.textContent = '';
                        iconElement.style.backgroundImage = `url(${icon})`;
                    } else {
                        iconElement.textContent = icon;
                    }
                }
            }
        }

        // æ•°æ®å¯¼å…¥å¯¼å‡º
        function exportData() {
            const dataStr = JSON.stringify(state, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'xphone_data.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function importData() {
            document.getElementById('importFile').click();
        }

        function handleImportFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedState = JSON.parse(e.target.result);
                    Object.assign(state, importedState);
                    saveData();
                    initApp();
                    alert('æ•°æ®å¯¼å…¥æˆåŠŸï¼');
                } catch (error) {
                    alert('å¯¼å…¥å¤±è´¥ï¼š' + error.message);
                }
            };
            reader.readAsText(file);
        }

        // æ¨¡æ€æ¡†æ§åˆ¶
        function openImageModal() { document.getElementById('imageModal').style.display = 'flex'; }
        function openVoiceModal() { document.getElementById('voiceModal').style.display = 'flex'; }
        function openLinkModal() { document.getElementById('linkModal').style.display = 'flex'; }
        function openMoneyModal() { document.getElementById('moneyModal').style.display = 'flex'; }
    
        function closeModal() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.style.display = 'none';
            });
            document.querySelectorAll('.modal-input, .modal-textarea').forEach(input => {
                input.value = '';
            });
        }
    
        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal')) {
                closeModal();
            }
        });
    
        // é˜»æ­¢æ»šåŠ¨ç©¿é€
        document.addEventListener('touchmove', function(event) {
            if (document.querySelector('.modal[style*="flex"]')) {
                event.preventDefault();
            }
        }, { passive: false });
    
        // åˆå§‹åŒ–åº”ç”¨
        window.addEventListener('load', function() {
            initApp();
        });
    </script>
</body>
</html>
