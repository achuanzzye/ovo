<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<title>ç‹¸ç‹¸èŠå¤©å™¨</title>
<style>
  :root{
    --safe-top: env(safe-area-inset-top,0px);
    --safe-right: env(safe-area-inset-right,0px);
    --safe-bottom: env(safe-area-inset-bottom,0px);
    --safe-left: env(safe-area-inset-left,0px);
    --glass: rgba(255,255,255,0.12);
    --glass-strong: rgba(255,255,255,0.18);
    --line: rgba(255,255,255,0.08);
    --brand: #0a84ff;
  }
  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
  html,body{height:100%;margin:0;padding:0;overflow:hidden;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"PingFang SC","Hiragino Sans GB","Microsoft YaHei",sans-serif;background:#000;color:#fff}
  /* èƒŒæ™¯ä¸ä¸»å± */
  .bg{position:fixed;inset:0;background: #000 center/cover no-repeat;z-index:-1;transition:background-image .2s ease}
  .home{
    position:relative;height:100svh;overflow:auto;
    padding: calc(var(--safe-top) + 40px) 20px calc(var(--safe-bottom) + 140px) 20px;
    background: linear-gradient(180deg, rgba(0,0,0,.35) 0%, rgba(0,0,0,.55) 100%);
  }
  .clock{
    display:flex;flex-direction:column;align-items:center;gap:8px;margin:6vh 0 2vh;
    user-select:none;
  }
  .clock-time{font-size:64px;font-weight:300;letter-spacing:1px}
  .clock-date{font-size:16px;opacity:.85}
  .tips{
    margin-top:18px;opacity:.8;font-size:13px;text-align:center;line-height:1.6
  }
  /* Dock æ  */
  .dock{
    position:fixed;left:20px;right:20px;bottom:calc(20px + var(--safe-bottom));
    height:84px;border-radius:26px;background:var(--glass);backdrop-filter: blur(18px);
    display:flex;align-items:center;justify-content:center;gap:22px;border:1px solid var(--line);
    padding:0 14px;
  }
  .dock-btn{
    width:58px;height:58px;border-radius:16px;border:1px solid var(--line);
    display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,.08);
    cursor:pointer;transition:.18s;position:relative;overflow:hidden
  }
  .dock-btn:active{transform:scale(.95);background:rgba(255,255,255,.16)}
  .dock-emoji{font-size:26px;line-height:1}
  .dock-img{width:28px;height:28px;object-fit:contain}
  .badge{
    position:absolute;top:6px;right:6px;min-width:18px;height:18px;border-radius:9px;
    background:#ff3b30;font-size:11px;display:flex;align-items:center;justify-content:center;padding:0 5px
  }

  /* åº”ç”¨å±‚ï¼šèŠå¤©/é€šè®¯å½•/æœ‹å‹åœˆ/ä¸»é¢˜ */
  .layer{position:fixed;inset:0;display:none;background:rgba(0,0,0,.75);backdrop-filter: blur(18px)}
  .layer.show{display:block}
  .nav{
    height:calc(56px + var(--safe-top));
    padding-top:var(--safe-top);
    display:flex;align-items:center;gap:8px;padding-inline:14px;
    border-bottom:1px solid var(--line);
    background:rgba(0,0,0,.85)
  }
  .nav .back{border:none;background:none;color:#fff;font-size:18px;padding:10px 8px}
  .nav .title{flex:1;text-align:center;margin-right:46px;font-weight:600}
  .body{position:absolute;inset:calc(56px + var(--safe-top)) 0 calc(var(--safe-bottom) + 0px) 0;overflow:auto}
  .list{padding:6px 0}
  .item{display:flex;gap:12px;align-items:center;padding:14px 16px;border-bottom:1px solid var(--line)}
  .avatar{
    width:50px;height:50px;border-radius:25px;display:grid;place-items:center;
    background:linear-gradient(135deg,#0a84ff,#5ac8fa);color:#fff;font-weight:600
  }
  .i-col{flex:1;min-width:0}
  .i-title{font-size:16px;margin-bottom:4px}
  .i-sub{font-size:13px;opacity:.8;white-space:nowrap;text-overflow:ellipsis;overflow:hidden}

  /* èŠå¤©ç•Œé¢ */
  .chat-wrap{position:absolute;inset:calc(56px + var(--safe-top)) 0 calc(110px + var(--safe-bottom)) 0;overflow:auto;padding:16px}
  .msg{display:flex;gap:8px;margin-bottom:12px}
  .msg.user{flex-direction:row-reverse}
  .bubble{
    max-width:74%;padding:12px 14px;border-radius:16px;word-break:break-word;
    background:rgba(255,255,255,.14);border:1px solid var(--line)
  }
  .msg.user .bubble{
    background:#0a84ff;border-color:transparent;color:#fff;border-bottom-right-radius:6px
  }
  .msg.ai .bubble{border-bottom-left-radius:6px}
  .composer{
    position:absolute;left:0;right:0;bottom:0;height:calc(110px + var(--safe-bottom));
    padding:10px 12px calc(10px + var(--safe-bottom)) 12px;border-top:1px solid var(--line);
    background:rgba(0,0,0,.85)
  }
  .tools{display:flex;gap:8px;margin-bottom:8px}
  .tbtn{
    flex:1;height:36px;border-radius:18px;border:1px solid var(--line);background:rgba(255,255,255,.10);
    color:#fff;font-size:12px;display:flex;align-items:center;justify-content:center;gap:6px
  }
  .inputbar{display:flex;gap:10px}
  .inputbar input{
    flex:1;height:40px;border-radius:20px;border:1px solid var(--line);
    background:rgba(255,255,255,.12);color:#fff;padding:0 14px;outline:none
  }
  .send{width:44px;height:40px;border-radius:20px;border:none;background:var(--brand);color:#fff;font-weight:700}
  .loading{width:18px;height:18px;border:2px solid rgba(255,255,255,.35);border-top-color:#fff;border-radius:50%;animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}

  /* ä¸»é¢˜è®¾ç½® */
  .section{padding:14px 16px;border-bottom:1px solid var(--line)}
  .label{font-size:13px;opacity:.8;margin-bottom:10px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .choose{display:inline-flex;align-items:center;gap:10px;border:1px solid var(--line);padding:10px 12px;border-radius:12px;background:rgba(255,255,255,.08)}
  .choose input[type="file"]{opacity:0;position:absolute;width:100%;height:100%;left:0;top:0;cursor:pointer}
  .icon-slot{
    width:64px;height:64px;border-radius:16px;border:1px dashed var(--line);
    display:grid;place-items:center;background:rgba(255,255,255,.06);position:relative;overflow:hidden
  }
  .icon-slot img{width:28px;height:28px;object-fit:contain}
  .icon-slot .small{position:absolute;bottom:6px;font-size:10px;opacity:.7}
  .emoji-input{width:64px;height:64px;border-radius:16px;border:1px dashed var(--line);background:rgba(255,255,255,.06);display:grid;place-items:center}
  .emoji-input input{width:90%;text-align:center;border:none;background:transparent;color:#fff;font-size:22px;outline:none}
  .hint{font-size:12px;opacity:.7;margin-top:6px}
</style>
</head>
<body>
  <div class="bg" id="bg"></div>

  <!-- ä¸»å±ï¼šä»…æ—¶é—´æ—¥æœŸ -->
  <main class="home" id="home">
    <section class="clock">
      <div class="clock-time" id="clockTime">00:00</div>
      <div class="clock-date" id="clockDate">æ˜ŸæœŸä¸€ 1æœˆ1æ—¥</div>
      <div class="tips">å‘ä¸‹ä¸éœ€è¦æ»‘ï¼Œå…¥å£éƒ½åœ¨ä¸‹æ–¹ Dockã€‚<br/>â€œä¸»é¢˜â€é‡Œå¯æ›´æ¢å£çº¸ä¸ Dock å›¾æ ‡ã€‚</div>
    </section>
  </main>

  <!-- Dock æ ï¼šèŠå¤©/é€šè®¯å½•/æœ‹å‹åœˆ/ä¸»é¢˜ -->
  <nav class="dock">
    <button class="dock-btn" id="dockChat" title="å¾®ä¿¡"><span class="dock-emoji" id="dockChatEmoji">ğŸ’¬</span></button>
    <button class="dock-btn" id="dockContacts" title="é€šè®¯å½•"><span class="dock-emoji" id="dockContactsEmoji">ğŸ“’</span></button>
    <button class="dock-btn" id="dockMoments" title="æœ‹å‹åœˆ"><span class="dock-emoji" id="dockMomentsEmoji">ğŸ“°</span><span class="badge" id="momentsBadge" style="display:none;">3</span></button>
    <button class="dock-btn" id="dockTheme" title="ä¸»é¢˜"><span class="dock-emoji" id="dockThemeEmoji">ğŸ¨</span></button>
  </nav>

  <!-- èŠå¤©åˆ—è¡¨å±‚ -->
  <section class="layer" id="layerChat">
    <header class="nav">
      <button class="back" data-back>&larr;</button>
      <div class="title">å¾®ä¿¡</div>
    </header>
    <div class="body">
      <div class="list" id="chatList"></div>
    </div>
  </section>

  <!-- èŠå¤©çª—å£å±‚ -->
  <section class="layer" id="layerDialog">
    <header class="nav">
      <button class="back" data-back>&larr;</button>
      <div class="title" id="dialogTitle">å¯¹è¯</div>
    </header>
    <div class="chat-wrap" id="chatWrap"></div>
    <div class="composer">
      <div class="tools">
        <button class="tbtn" data-tool="img">ğŸ–¼ï¸ å›¾ç‰‡</button>
        <button class="tbtn" data-tool="mic">ğŸ¤ è¯­éŸ³</button>
        <button class="tbtn" data-tool="link">ğŸ”— é“¾æ¥</button>
        <button class="tbtn" data-tool="pay">ğŸ’° è½¬è´¦</button>
      </div>
      <div class="inputbar">
        <input id="inputMsg" placeholder="è¾“å…¥æ¶ˆæ¯..." />
        <button class="send" id="btnSend"><span id="sendIcon">â¤</span></button>
      </div>
    </div>
  </section>

  <!-- é€šè®¯å½•å±‚ -->
  <section class="layer" id="layerContacts">
    <header class="nav">
      <button class="back" data-back>&larr;</button>
      <div class="title">é€šè®¯å½•</div>
    </header>
    <div class="body">
      <div class="section">
        <div class="label">è”ç³»äºº</div>
        <div class="list" id="contactList"></div>
      </div>
    </div>
  </section>

  <!-- æœ‹å‹åœˆå±‚ï¼ˆç¤ºä¾‹ï¼‰ -->
  <section class="layer" id="layerMoments">
    <header class="nav">
      <button class="back" data-back>&larr;</button>
      <div class="title">æœ‹å‹åœˆ</div>
    </header>
    <div class="body">
      <div class="list" id="momentsList">
        <!-- ç¤ºä¾‹åŠ¨æ€ -->
      </div>
    </div>
  </section>

  <!-- ä¸»é¢˜å±‚ï¼ˆå£çº¸ + Dock å›¾æ ‡ï¼‰ -->
  <section class="layer" id="layerTheme">
    <header class="nav">
      <button class="back" data-back>&larr;</button>
      <div class="title">ä¸»é¢˜</div>
    </header>
    <div class="body">
      <div class="section">
        <div class="label">å£çº¸</div>
        <div class="row">
          <label class="choose" style="position:relative">
            <input type="file" accept="image/*" id="wallpaperFile" />
            ä¸Šä¼ å›¾ç‰‡
          </label>
          <button class="tbtn" id="btnResetBg">æ¢å¤é»˜è®¤</button>
        </div>
        <div class="hint">æ”¯æŒæœ¬åœ°ä¸Šä¼ ï¼Œè‡ªåŠ¨ä¿å­˜ï¼›æ¢å¤é»˜è®¤ä¼šæ¸…é™¤ä¿å­˜çš„å£çº¸ã€‚</div>
      </div>

      <div class="section">
        <div class="label">Dock å›¾æ ‡ï¼ˆä¸Šä¼ å›¾ç‰‡æˆ–å¡« Emojiï¼Œä¼˜å…ˆä½¿ç”¨ä¸Šä¼ å›¾ï¼‰</div>
        <div class="row" id="iconEditor">
          <!-- å››ä¸ªä½ï¼šchat / contacts / moments / theme -->
          <div>
            <div class="icon-slot"><img id="iconChatImg" alt=""><span class="small">èŠå¤©</span></div>
            <div class="row" style="margin-top:8px">
              <label class="choose" style="position:relative"><input type="file" accept="image/*" data-icon="chat">ä¸Šä¼ </label>
              <div class="emoji-input"><input maxlength="4" placeholder="ğŸ’¬" data-emoji="chat"></div>
            </div>
          </div>
          <div>
            <div class="icon-slot"><img id="iconContactsImg" alt=""><span class="small">é€šè®¯å½•</span></div>
            <div class="row" style="margin-top:8px">
              <label class="choose" style="position:relative"><input type="file" accept="image/*" data-icon="contacts">ä¸Šä¼ </label>
              <div class="emoji-input"><input maxlength="4" placeholder="ğŸ“’" data-emoji="contacts"></div>
            </div>
          </div>
          <div>
            <div class="icon-slot"><img id="iconMomentsImg" alt=""><span class="small">æœ‹å‹åœˆ</span></div>
            <div class="row" style="margin-top:8px">
              <label class="choose" style="position:relative"><input type="file" accept="image/*" data-icon="moments">ä¸Šä¼ </label>
              <div class="emoji-input"><input maxlength="4" placeholder="ğŸ“°" data-emoji="moments"></div>
            </div>
          </div>
          <div>
            <div class="icon-slot"><img id="iconThemeImg" alt=""><span class="small">ä¸»é¢˜</span></div>
            <div class="row" style="margin-top:8px">
              <label class="choose" style="position:relative"><input type="file" accept="image/*" data-icon="theme">ä¸Šä¼ </label>
              <div class="emoji-input"><input maxlength="4" placeholder="ğŸ¨" data-emoji="theme"></div>
            </div>
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <button class="tbtn" id="btnSaveIcons">ä¿å­˜å›¾æ ‡</button>
          <button class="tbtn" id="btnResetIcons">é‡ç½®å›¾æ ‡</button>
        </div>
        <div class="hint">æç¤ºï¼šå›¾æ ‡å»ºè®®ä½¿ç”¨é€æ˜ PNG/SVGï¼Œå°äº 64Ã—64 æ›´æ¸…æ™°ï¼ŒEmoji å¡«å†™ç¤ºä¾‹ï¼šğŸ’¬ ğŸ“’ ğŸ“° ğŸ¨ã€‚</div>
      </div>
    </div>
  </section>

<script>
/* ====== çŠ¶æ€ä¸åˆå§‹åŒ– ====== */
const state = {
  contacts: [],
  dialogs: {}, // {id: [{sender:'ai'|'user', text, html}]}
  currentDialog: null,
  theme: {
    bg: localStorage.getItem('theme.bg') || '',
    icons: JSON.parse(localStorage.getItem('theme.icons') || '{"chat":{},"contacts":{},"moments":{},"theme":{}}'),
    emojis: JSON.parse(localStorage.getItem('theme.emojis') || '{"chat":"ğŸ’¬","contacts":"ğŸ“’","moments":"ğŸ“°","theme":"ğŸ¨"}')
  }
};

// é»˜è®¤è”ç³»äºº
const defaultContacts = [
  { id: 'ai-assistant', name:'AIåŠ©æ‰‹', avatar:'ğŸ¤–', preview:'ä½ å¥½ï¼æˆ‘æ˜¯AIåŠ©æ‰‹~' },
  { id: 'lili', name:'ç‹¸ç‹¸', avatar:'ğŸ¦', preview:'å””â€¦â€¦ä»Šå¤©æƒ³å·æ‡’ã€‚' }
];

/* ====== å·¥å…·å‡½æ•° ====== */
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);
function saveTheme(){
  localStorage.setItem('theme.bg', state.theme.bg || '');
  localStorage.setItem('theme.icons', JSON.stringify(state.theme.icons || {}));
  localStorage.setItem('theme.emojis', JSON.stringify(state.theme.emojis || {}));
}
function setDockIcon(place){
  const cfg = state.theme.icons?.[place] || {};
  const emojiEl = {
    chat: $('#dockChatEmoji'),
    contacts: $('#dockContactsEmoji'),
    moments: $('#dockMomentsEmoji'),
    theme: $('#dockThemeEmoji')
  }[place];
  if(!emojiEl) return;
  // æœ‰è‡ªå®šä¹‰å›¾ç‰‡å°±ç”¨å›¾ç‰‡ï¼Œæ²¡æœ‰å°±æ˜¾ç¤º emoji
  if(cfg.dataUrl){
    emojiEl.innerHTML = `<img class="dock-img" src="${cfg.dataUrl}" alt="">`;
  }else{
    emojiEl.textContent = state.theme.emojis?.[place] || '';
  }
}
function applyAllDockIcons(){
  ['chat','contacts','moments','theme'].forEach(setDockIcon);
}
function setBg(dataUrl){
  const bgEl = $('#bg');
  if(dataUrl){
    bgEl.style.backgroundImage = `url(${dataUrl})`;
  }else{
    // é»˜è®¤æ¸å˜
    bgEl.style.backgroundImage = 'linear-gradient(135deg,#1e3c72 0%,#2a5298 100%)';
  }
}

/* ====== æ—¶é—´ä¸ä¸»å± ====== */
function updateClock(){
  const now = new Date();
  const hh = String(now.getHours()).padStart(2,'0');
  const mm = String(now.getMinutes()).padStart(2,'0');
  $('#clockTime').textContent = `${hh}:${mm}`;
  const dateStr = now.toLocaleDateString('zh-CN',{weekday:'long',month:'long',day:'numeric'});
  $('#clockDate').textContent = dateStr;
}
setInterval(updateClock, 1000); updateClock();

/* ====== å±‚åˆ‡æ¢ ====== */
function openLayer(id){ $(id).classList.add('show'); }
function closeTopLayer(){
  // å…³é—­æœ€ä¸Šé¢çš„ä¸€ä¸ªå±‚ï¼ˆæœ€åä¸€ä¸ª .layer.showï¼‰
  const layers = Array.from($$('.layer.show'));
  if(layers.length) layers[layers.length-1].classList.remove('show');
}

// Dock ç»‘å®š
$('#dockChat').onclick = ()=> openLayer('#layerChat');
$('#dockContacts').onclick = ()=> openLayer('#layerContacts');
$('#dockMoments').onclick = ()=> { openLayer('#layerMoments'); $('#momentsBadge').style.display='none'; };
$('#dockTheme').onclick = ()=> openLayer('#layerTheme');
$$('[data-back]').forEach(b=> b.onclick = closeTopLayer);

/* ====== æ•°æ®å‡†å¤‡ ====== */
function initData(){
  // è”ç³»äºº
  const savedContacts = JSON.parse(localStorage.getItem('contacts') || 'null');
  state.contacts = savedContacts || defaultContacts;
  // å¯¹è¯
  state.dialogs = JSON.parse(localStorage.getItem('dialogs') || '{}');
  state.contacts.forEach(c => {
    if(!state.dialogs[c.id]){
      state.dialogs[c.id] = [{sender:'ai', text:`ä½ å¥½ï¼Œæˆ‘æ˜¯${c.name}ï¼Œæœ‰ä»€ä¹ˆæƒ³èŠçš„å˜›ï¼Ÿ`}];
    }
  });
  localStorage.setItem('contacts', JSON.stringify(state.contacts));
  localStorage.setItem('dialogs', JSON.stringify(state.dialogs));
}
initData();

/* ====== æ¸²æŸ“ï¼šèŠå¤©åˆ—è¡¨/é€šè®¯å½•/æœ‹å‹åœˆ ====== */
function renderChatList(){
  const wrap = $('#chatList'); wrap.innerHTML = '';
  state.contacts.forEach(c=>{
    const last = state.dialogs[c.id]?.slice(-1)[0];
    const sub = last ? (last.text?.slice(0,24) + (last.text.length>24?'â€¦':'')) : 'æš‚æ— æ¶ˆæ¯';
    const row = document.createElement('div'); row.className='item';
    row.innerHTML = `
      <div class="avatar">${c.avatar || 'ğŸ‘¤'}</div>
      <div class="i-col">
        <div class="i-title">${c.name}</div>
        <div class="i-sub">${sub}</div>
      </div>
    `;
    row.onclick = ()=> openDialog(c.id);
    wrap.appendChild(row);
  });
}
function renderContacts(){
  const wrap = $('#contactList'); wrap.innerHTML = '';
  state.contacts.forEach(c=>{
    const row = document.createElement('div'); row.className='item';
    row.innerHTML = `
      <div class="avatar">${c.avatar || 'ğŸ‘¤'}</div>
      <div class="i-col">
        <div class="i-title">${c.name}</div>
        <div class="i-sub">ç‚¹æ­¤å¼€å§‹ä¸ ${c.name} å¯¹è¯</div>
      </div>
    `;
    row.onclick = ()=> { openLayer('#layerChat'); openDialog(c.id); };
    wrap.appendChild(row);
  });
}
function renderMoments(){
  const wrap = $('#momentsList'); wrap.innerHTML = '';
  const demos = [
    {who:'AIåŠ©æ‰‹', avatar:'ğŸ¤–', text:'æ¬¢è¿æ¥åˆ°æœ‹å‹åœˆï½è¯•è¯•å‘ä¸€æ¡é“¾æ¥ç»™æˆ‘ï¼', time:'åˆšåˆš'},
    {who:'ç‹¸ç‹¸', avatar:'ğŸ¦', text:'ä»Šæ—¥å åœï¼šå‰ã€‚ä¸æ‹˜æ³¥äºå°èŠ‚ï¼Œå¿ƒæƒ…ä¼šæ›´èˆ’ç•…ã€‚', time:'1å°æ—¶å‰'}
  ];
  demos.forEach(m=>{
    const row = document.createElement('div'); row.className='item';
    row.innerHTML = `
      <div class="avatar">${m.avatar}</div>
      <div class="i-col">
        <div class="i-title">${m.who}</div>
        <div class="i-sub">${m.text}</div>
      </div>
      <div class="i-sub" style="min-width:60px;text-align:right">${m.time}</div>
    `;
    wrap.appendChild(row);
  });
}

/* ====== å¯¹è¯çª—å£ ====== */
function openDialog(id){
  state.currentDialog = id;
  $('#dialogTitle').textContent = state.contacts.find(c=>c.id===id)?.name || 'å¯¹è¯';
  renderDialog();
  // åˆ‡æ¢å±‚åˆ°å¯¹è¯
  $('#layerDialog').classList.add('show');
}
function renderDialog(){
  const wrap = $('#chatWrap'); wrap.innerHTML = '';
  const msgs = state.dialogs[state.currentDialog] || [];
  msgs.forEach(m=>{
    const row = document.createElement('div');
    row.className = 'msg ' + (m.sender==='user'?'user':'ai');
    const b = document.createElement('div'); b.className = 'bubble';
    if(m.html){ b.innerHTML = m.text; } else { b.textContent = m.text; }
    row.appendChild(b); wrap.appendChild(row);
  });
  wrap.scrollTop = wrap.scrollHeight;
}
function saveDialogs(){ localStorage.setItem('dialogs', JSON.stringify(state.dialogs)); }

$('#btnSend').onclick = ()=>{
  const input = $('#inputMsg');
  const text = (input.value||'').trim();
  if(!text || !state.currentDialog) return;
  pushMsg('user', text);
  input.value = '';
  sendAI(text);
};
$('#inputMsg').addEventListener('keypress', e=>{
  if(e.key==='Enter'){ e.preventDefault(); $('#btnSend').click(); }
});
function pushMsg(sender, text, html=false){
  const id = state.currentDialog;
  if(!state.dialogs[id]) state.dialogs[id]=[];
  state.dialogs[id].push({sender, text, html});
  saveDialogs();
  renderDialog();
}
function sendAI(text){
  const icon = $('#sendIcon'); const prev = icon.innerHTML;
  icon.innerHTML = '<div class="loading"></div>';
  // æ¼”ç¤ºç”¨ï¼šæœ¬åœ°å›å¤ï¼Œä¸ä¾èµ–å¤–ç½‘
  setTimeout(()=>{
    const reply = generateLocalReply(text);
    pushMsg('ai', reply);
    icon.innerHTML = prev;
  }, 500);
}
function generateLocalReply(input){
  // è½»é‡è§„åˆ™ï¼šé“¾æ¥å›æ˜¾ã€é—®å€™ã€æ™®é€šé—²èŠ
  const link = input.match(/https?:\/\/\S+/);
  if(link) return `æ”¶åˆ°é“¾æ¥ï¼š${link[0]} ï¼›æˆ‘å·²è®°ä¸‹ã€‚`;
  if(/(ä½ å¥½|hi|hello)/i.test(input)) return 'ä½ å¥½å‘€ï½éœ€è¦æˆ‘åšç‚¹ä»€ä¹ˆï¼Ÿ';
  if(/(å›¾ç‰‡|ç…§ç‰‡)/.test(input)) return 'å¦‚æœè¦å‘å›¾ç‰‡ï¼Œç‚¹ä¸€ä¸‹è¾“å…¥æ¡†ä¸Šæ–¹çš„ã€Œå›¾ç‰‡ã€æŒ‰é’®å°±è¡Œã€‚';
  return 'æˆ‘åœ¨å¬ï½ç»§ç»­è¯´è¯´çœ‹ã€‚';
}

/* ====== å·¥å…·æŒ‰é’®ï¼ˆç‰¹æ®Šæ¶ˆæ¯ï¼‰ ====== */
document.querySelectorAll('.tbtn').forEach(btn=>{
  btn.onclick = ()=>{
    const tool = btn.dataset.tool;
    if(!state.currentDialog) return;
    if(tool==='img'){
      const html = `<div class="special-message image" style="border-radius:12px;padding:10px;background:linear-gradient(135deg,#74b9ff,#0984e3);color:#fff">
        <div style="font-weight:700;margin-bottom:6px">ğŸ“¸ å›¾ç‰‡</div>
        <div>ï¼ˆç¤ºä¾‹ï¼‰è¿™æ˜¯ä¸€å¼ æ¥è‡ªç›¸å†Œçš„å›¾ç‰‡æè¿°ã€‚</div>
      </div>`;
      pushMsg('user', html, true);
      pushMsg('ai', 'æˆ‘çœ‹åˆ°äº†ä½ çš„å›¾ç‰‡æè¿°ï½å¾ˆæœ‰è¶£ï¼');
    }else if(tool==='mic'){
      const html = `<div class="special-message voice" style="border-radius:12px;padding:10px;background:linear-gradient(135deg,#fd79a8,#e84393);color:#fff">
        <div style="font-weight:700;margin-bottom:6px">ğŸ¤ è¯­éŸ³</div>
        <div>æ—¶é•¿ï¼š15ç§’<br>å†…å®¹ï¼šä»Šå¤©å¿ƒæƒ…ä¸é”™ï¼</div>
      </div>`;
      pushMsg('user', html, true);
      pushMsg('ai', 'è¯­éŸ³æ”¶åˆ°ï½æˆ‘ä¹Ÿè¢«ä½ çš„å¥½å¿ƒæƒ…æ„ŸæŸ“å•¦ï¼');
    }else if(tool==='link'){
      const html = `<div class="special-message link" style="border-radius:12px;padding:10px;background:linear-gradient(135deg,#55a3ff,#3742fa);color:#fff">
        <div style="font-weight:700;margin-bottom:6px">ğŸ”— é“¾æ¥</div>
        <div>æ ‡é¢˜ï¼šç¤ºä¾‹é¡µé¢<br>é“¾æ¥ï¼šhttps://example.com</div>
      </div>`;
      pushMsg('user', html, true);
      pushMsg('ai', 'è°¢è°¢é“¾æ¥ï¼Œæˆ‘è®°ä¸‹å•¦ï½');
    }else if(tool==='pay'){
      const html = `<div class="special-message money" style="border-radius:12px;padding:10px;background:linear-gradient(135deg,#ffeaa7,#fdcb6e);color:#2d3436">
        <div style="font-weight:700;margin-bottom:6px">ğŸ’° è½¬è´¦</div>
        <div>é‡‘é¢ï¼šÂ¥6.66<br>å¤‡æ³¨ï¼šç»™ç‹¸ç‹¸ä¹°è‹¹æœï¼</div>
      </div>`;
      pushMsg('user', html, true);
      pushMsg('ai', 'æ”¶åˆ°è½¬è´¦ï¼ˆç¤ºä¾‹ï¼‰è°¢è°¢ï½æˆ‘æ›¿ä½ è®°è´¦å•¦ã€‚');
    }
  }
});

/* ====== ä¸»é¢˜ï¼šå£çº¸/å›¾æ ‡ ====== */
// åŠ è½½å£çº¸
if(state.theme.bg){ setBg(state.theme.bg); } else { setBg(''); }
// æ–‡ä»¶ -> dataURL
function fileToDataUrl(file){
  return new Promise((resolve,reject)=>{
    const reader = new FileReader();
    reader.onload = e=> resolve(e.target.result);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}
$('#wallpaperFile').addEventListener('change', async (e)=>{
  const file = e.target.files?.[0];
  if(!file) return;
  const dataUrl = await fileToDataUrl(file);
  state.theme.bg = dataUrl; saveTheme(); setBg(dataUrl);
});
$('#btnResetBg').onclick = ()=>{ state.theme.bg=''; saveTheme(); setBg(''); };

// å›¾æ ‡ç¼–è¾‘å™¨ï¼šå›æ˜¾ emoji ä¸å›¾ç‰‡
function refreshIconEditors(){
  const places = ['chat','contacts','moments','theme'];
  places.forEach(p=>{
    const imgEl = {
      chat: $('#iconChatImg'), contacts: $('#iconContactsImg'),
      moments: $('#iconMomentsImg'), theme: $('#iconThemeImg')
    }[p];
    const emojiInput = document.querySelector(`input[data-emoji="${p}"]`);
    const conf = state.theme.icons[p]||{};
    imgEl.src = conf.dataUrl || '';
    imgEl.style.display = conf.dataUrl ? 'block' : 'none';
    emojiInput.value = state.theme.emojis[p] || '';
  });
}
refreshIconEditors(); applyAllDockIcons();

document.querySelectorAll('input[type="file"][data-icon]').forEach(inp=>{
  inp.addEventListener('change', async (e)=>{
    const slot = e.target.getAttribute('data-icon');
    const file = e.target.files?.[0];
    if(!file) return;
    const dataUrl = await fileToDataUrl(file);
    state.theme.icons[slot] = { dataUrl };
    saveTheme(); refreshIconEditors(); applyAllDockIcons();
  });
});
document.querySelectorAll('input[data-emoji]').forEach(inp=>{
  inp.addEventListener('input', e=>{
    const slot = e.target.getAttribute('data-emoji');
    state.theme.emojis[slot] = e.target.value || '';
  });
});
$('#btnSaveIcons').onclick = ()=>{ saveTheme(); applyAllDockIcons(); alert('å·²ä¿å­˜ Dock å›¾æ ‡'); };
$('#btnResetIcons').onclick = ()=>{
  state.theme.icons = {chat:{},contacts:{},moments:{},theme:{}};
  state.theme.emojis = {chat:'ğŸ’¬',contacts:'ğŸ“’',moments:'ğŸ“°',theme:'ğŸ¨'};
  saveTheme(); refreshIconEditors(); applyAllDockIcons();
};

/* ====== å¯åŠ¨æ¸²æŸ“ ====== */
renderChatList(); renderContacts(); renderMoments();

// é»˜è®¤æ‰“å¼€æ—¶ç»™æœ‹å‹åœˆä¸€ä¸ªâ€œæœªè¯»â€å¾½æ ‡ç¤ºæ„
setTimeout(()=>{ $('#momentsBadge').style.display='inline-flex'; }, 600);

// èƒŒæ™¯è§¦æ‘¸å°ä¼˜åŒ–ï¼šé˜²æ­¢æ¨¡æ€æ‰“å¼€æ—¶æ»šåŠ¨ç©¿é€
document.addEventListener('touchmove', function(e){
  if($$('.layer.show').length){ e.preventDefault(); }
}, {passive:false});
</script>
</body>
</html>