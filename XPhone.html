<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<title>狸狸聊天器</title>
<style>
  :root{
    --safe-top: env(safe-area-inset-top,0px);
    --safe-right: env(safe-area-inset-right,0px);
    --safe-bottom: env(safe-area-inset-bottom,0px);
    --safe-left: env(safe-area-inset-left,0px);
    --glass: rgba(255,255,255,0.12);
    --glass-strong: rgba(255,255,255,0.18);
    --line: rgba(255,255,255,0.08);
    --brand: #0a84ff;
  }
  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
  html,body{height:100%;margin:0;padding:0;overflow:hidden;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"PingFang SC","Hiragino Sans GB","Microsoft YaHei",sans-serif;background:#000;color:#fff}
  /* 背景与主屏 */
  .bg{position:fixed;inset:0;background: #000 center/cover no-repeat;z-index:-1;transition:background-image .2s ease}
  .home{
    position:relative;height:100svh;overflow:auto;
    padding: calc(var(--safe-top) + 40px) 20px calc(var(--safe-bottom) + 140px) 20px;
    background: linear-gradient(180deg, rgba(0,0,0,.35) 0%, rgba(0,0,0,.55) 100%);
  }
  .clock{
    display:flex;flex-direction:column;align-items:center;gap:8px;margin:6vh 0 2vh;
    user-select:none;
  }
  .clock-time{font-size:64px;font-weight:300;letter-spacing:1px}
  .clock-date{font-size:16px;opacity:.85}
  .tips{
    margin-top:18px;opacity:.8;font-size:13px;text-align:center;line-height:1.6
  }
  /* Dock 栏 */
  .dock{
    position:fixed;left:20px;right:20px;bottom:calc(20px + var(--safe-bottom));
    height:84px;border-radius:26px;background:var(--glass);backdrop-filter: blur(18px);
    display:flex;align-items:center;justify-content:center;gap:22px;border:1px solid var(--line);
    padding:0 14px;
  }
  .dock-btn{
    width:58px;height:58px;border-radius:16px;border:1px solid var(--line);
    display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,.08);
    cursor:pointer;transition:.18s;position:relative;overflow:hidden
  }
  .dock-btn:active{transform:scale(.95);background:rgba(255,255,255,.16)}
  .dock-emoji{font-size:26px;line-height:1}
  .dock-img{width:28px;height:28px;object-fit:contain}
  .badge{
    position:absolute;top:6px;right:6px;min-width:18px;height:18px;border-radius:9px;
    background:#ff3b30;font-size:11px;display:flex;align-items:center;justify-content:center;padding:0 5px
  }

  /* 应用层：聊天/通讯录/朋友圈/主题 */
  .layer{position:fixed;inset:0;display:none;background:rgba(0,0,0,.75);backdrop-filter: blur(18px)}
  .layer.show{display:block}
  .nav{
    height:calc(56px + var(--safe-top));
    padding-top:var(--safe-top);
    display:flex;align-items:center;gap:8px;padding-inline:14px;
    border-bottom:1px solid var(--line);
    background:rgba(0,0,0,.85)
  }
  .nav .back{border:none;background:none;color:#fff;font-size:18px;padding:10px 8px}
  .nav .title{flex:1;text-align:center;margin-right:46px;font-weight:600}
  .body{position:absolute;inset:calc(56px + var(--safe-top)) 0 calc(var(--safe-bottom) + 0px) 0;overflow:auto}
  .list{padding:6px 0}
  .item{display:flex;gap:12px;align-items:center;padding:14px 16px;border-bottom:1px solid var(--line)}
  .avatar{
    width:50px;height:50px;border-radius:25px;display:grid;place-items:center;
    background:linear-gradient(135deg,#0a84ff,#5ac8fa);color:#fff;font-weight:600
  }
  .i-col{flex:1;min-width:0}
  .i-title{font-size:16px;margin-bottom:4px}
  .i-sub{font-size:13px;opacity:.8;white-space:nowrap;text-overflow:ellipsis;overflow:hidden}

  /* 聊天界面 */
  .chat-wrap{position:absolute;inset:calc(56px + var(--safe-top)) 0 calc(110px + var(--safe-bottom)) 0;overflow:auto;padding:16px}
  .msg{display:flex;gap:8px;margin-bottom:12px}
  .msg.user{flex-direction:row-reverse}
  .bubble{
    max-width:74%;padding:12px 14px;border-radius:16px;word-break:break-word;
    background:rgba(255,255,255,.14);border:1px solid var(--line)
  }
  .msg.user .bubble{
    background:#0a84ff;border-color:transparent;color:#fff;border-bottom-right-radius:6px
  }
  .msg.ai .bubble{border-bottom-left-radius:6px}
  .composer{
    position:absolute;left:0;right:0;bottom:0;height:calc(110px + var(--safe-bottom));
    padding:10px 12px calc(10px + var(--safe-bottom)) 12px;border-top:1px solid var(--line);
    background:rgba(0,0,0,.85)
  }
  .tools{display:flex;gap:8px;margin-bottom:8px}
  .tbtn{
    flex:1;height:36px;border-radius:18px;border:1px solid var(--line);background:rgba(255,255,255,.10);
    color:#fff;font-size:12px;display:flex;align-items:center;justify-content:center;gap:6px
  }
  .inputbar{display:flex;gap:10px}
  .inputbar input{
    flex:1;height:40px;border-radius:20px;border:1px solid var(--line);
    background:rgba(255,255,255,.12);color:#fff;padding:0 14px;outline:none
  }
  .send{width:44px;height:40px;border-radius:20px;border:none;background:var(--brand);color:#fff;font-weight:700}
  .loading{width:18px;height:18px;border:2px solid rgba(255,255,255,.35);border-top-color:#fff;border-radius:50%;animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}

  /* 主题设置 */
  .section{padding:14px 16px;border-bottom:1px solid var(--line)}
  .label{font-size:13px;opacity:.8;margin-bottom:10px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .choose{display:inline-flex;align-items:center;gap:10px;border:1px solid var(--line);padding:10px 12px;border-radius:12px;background:rgba(255,255,255,.08)}
  .choose input[type="file"]{opacity:0;position:absolute;width:100%;height:100%;left:0;top:0;cursor:pointer}
  .icon-slot{
    width:64px;height:64px;border-radius:16px;border:1px dashed var(--line);
    display:grid;place-items:center;background:rgba(255,255,255,.06);position:relative;overflow:hidden
  }
  .icon-slot img{width:28px;height:28px;object-fit:contain}
  .icon-slot .small{position:absolute;bottom:6px;font-size:10px;opacity:.7}
  .emoji-input{width:64px;height:64px;border-radius:16px;border:1px dashed var(--line);background:rgba(255,255,255,.06);display:grid;place-items:center}
  .emoji-input input{width:90%;text-align:center;border:none;background:transparent;color:#fff;font-size:22px;outline:none}
  .hint{font-size:12px;opacity:.7;margin-top:6px}
</style>
</head>
<body>
  <div class="bg" id="bg"></div>

  <!-- 主屏：仅时间日期 -->
  <main class="home" id="home">
    <section class="clock">
      <div class="clock-time" id="clockTime">00:00</div>
      <div class="clock-date" id="clockDate">星期一 1月1日</div>
      <div class="tips">向下不需要滑，入口都在下方 Dock。<br/>“主题”里可更换壁纸与 Dock 图标。</div>
    </section>
  </main>

  <!-- Dock 栏：聊天/通讯录/朋友圈/主题 -->
  <nav class="dock">
    <button class="dock-btn" id="dockChat" title="微信"><span class="dock-emoji" id="dockChatEmoji">💬</span></button>
    <button class="dock-btn" id="dockContacts" title="通讯录"><span class="dock-emoji" id="dockContactsEmoji">📒</span></button>
    <button class="dock-btn" id="dockMoments" title="朋友圈"><span class="dock-emoji" id="dockMomentsEmoji">📰</span><span class="badge" id="momentsBadge" style="display:none;">3</span></button>
    <button class="dock-btn" id="dockTheme" title="主题"><span class="dock-emoji" id="dockThemeEmoji">🎨</span></button>
  </nav>

  <!-- 聊天列表层 -->
  <section class="layer" id="layerChat">
    <header class="nav">
      <button class="back" data-back>&larr;</button>
      <div class="title">微信</div>
    </header>
    <div class="body">
      <div class="list" id="chatList"></div>
    </div>
  </section>

  <!-- 聊天窗口层 -->
  <section class="layer" id="layerDialog">
    <header class="nav">
      <button class="back" data-back>&larr;</button>
      <div class="title" id="dialogTitle">对话</div>
    </header>
    <div class="chat-wrap" id="chatWrap"></div>
    <div class="composer">
      <div class="tools">
        <button class="tbtn" data-tool="img">🖼️ 图片</button>
        <button class="tbtn" data-tool="mic">🎤 语音</button>
        <button class="tbtn" data-tool="link">🔗 链接</button>
        <button class="tbtn" data-tool="pay">💰 转账</button>
      </div>
      <div class="inputbar">
        <input id="inputMsg" placeholder="输入消息..." />
        <button class="send" id="btnSend"><span id="sendIcon">➤</span></button>
      </div>
    </div>
  </section>

  <!-- 通讯录层 -->
  <section class="layer" id="layerContacts">
    <header class="nav">
      <button class="back" data-back>&larr;</button>
      <div class="title">通讯录</div>
    </header>
    <div class="body">
      <div class="section">
        <div class="label">联系人</div>
        <div class="list" id="contactList"></div>
      </div>
    </div>
  </section>

  <!-- 朋友圈层（示例） -->
  <section class="layer" id="layerMoments">
    <header class="nav">
      <button class="back" data-back>&larr;</button>
      <div class="title">朋友圈</div>
    </header>
    <div class="body">
      <div class="list" id="momentsList">
        <!-- 示例动态 -->
      </div>
    </div>
  </section>

  <!-- 主题层（壁纸 + Dock 图标） -->
  <section class="layer" id="layerTheme">
    <header class="nav">
      <button class="back" data-back>&larr;</button>
      <div class="title">主题</div>
    </header>
    <div class="body">
      <div class="section">
        <div class="label">壁纸</div>
        <div class="row">
          <label class="choose" style="position:relative">
            <input type="file" accept="image/*" id="wallpaperFile" />
            上传图片
          </label>
          <button class="tbtn" id="btnResetBg">恢复默认</button>
        </div>
        <div class="hint">支持本地上传，自动保存；恢复默认会清除保存的壁纸。</div>
      </div>

      <div class="section">
        <div class="label">Dock 图标（上传图片或填 Emoji，优先使用上传图）</div>
        <div class="row" id="iconEditor">
          <!-- 四个位：chat / contacts / moments / theme -->
          <div>
            <div class="icon-slot"><img id="iconChatImg" alt=""><span class="small">聊天</span></div>
            <div class="row" style="margin-top:8px">
              <label class="choose" style="position:relative"><input type="file" accept="image/*" data-icon="chat">上传</label>
              <div class="emoji-input"><input maxlength="4" placeholder="💬" data-emoji="chat"></div>
            </div>
          </div>
          <div>
            <div class="icon-slot"><img id="iconContactsImg" alt=""><span class="small">通讯录</span></div>
            <div class="row" style="margin-top:8px">
              <label class="choose" style="position:relative"><input type="file" accept="image/*" data-icon="contacts">上传</label>
              <div class="emoji-input"><input maxlength="4" placeholder="📒" data-emoji="contacts"></div>
            </div>
          </div>
          <div>
            <div class="icon-slot"><img id="iconMomentsImg" alt=""><span class="small">朋友圈</span></div>
            <div class="row" style="margin-top:8px">
              <label class="choose" style="position:relative"><input type="file" accept="image/*" data-icon="moments">上传</label>
              <div class="emoji-input"><input maxlength="4" placeholder="📰" data-emoji="moments"></div>
            </div>
          </div>
          <div>
            <div class="icon-slot"><img id="iconThemeImg" alt=""><span class="small">主题</span></div>
            <div class="row" style="margin-top:8px">
              <label class="choose" style="position:relative"><input type="file" accept="image/*" data-icon="theme">上传</label>
              <div class="emoji-input"><input maxlength="4" placeholder="🎨" data-emoji="theme"></div>
            </div>
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <button class="tbtn" id="btnSaveIcons">保存图标</button>
          <button class="tbtn" id="btnResetIcons">重置图标</button>
        </div>
        <div class="hint">提示：图标建议使用透明 PNG/SVG，小于 64×64 更清晰，Emoji 填写示例：💬 📒 📰 🎨。</div>
      </div>
    </div>
  </section>

<script>
/* ====== 状态与初始化 ====== */
const state = {
  contacts: [],
  dialogs: {}, // {id: [{sender:'ai'|'user', text, html}]}
  currentDialog: null,
  theme: {
    bg: localStorage.getItem('theme.bg') || '',
    icons: JSON.parse(localStorage.getItem('theme.icons') || '{"chat":{},"contacts":{},"moments":{},"theme":{}}'),
    emojis: JSON.parse(localStorage.getItem('theme.emojis') || '{"chat":"💬","contacts":"📒","moments":"📰","theme":"🎨"}')
  }
};

// 默认联系人
const defaultContacts = [
  { id: 'ai-assistant', name:'AI助手', avatar:'🤖', preview:'你好！我是AI助手~' },
  { id: 'lili', name:'狸狸', avatar:'🦝', preview:'唔……今天想偷懒。' }
];

/* ====== 工具函数 ====== */
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);
function saveTheme(){
  localStorage.setItem('theme.bg', state.theme.bg || '');
  localStorage.setItem('theme.icons', JSON.stringify(state.theme.icons || {}));
  localStorage.setItem('theme.emojis', JSON.stringify(state.theme.emojis || {}));
}
function setDockIcon(place){
  const cfg = state.theme.icons?.[place] || {};
  const emojiEl = {
    chat: $('#dockChatEmoji'),
    contacts: $('#dockContactsEmoji'),
    moments: $('#dockMomentsEmoji'),
    theme: $('#dockThemeEmoji')
  }[place];
  if(!emojiEl) return;
  // 有自定义图片就用图片，没有就显示 emoji
  if(cfg.dataUrl){
    emojiEl.innerHTML = `<img class="dock-img" src="${cfg.dataUrl}" alt="">`;
  }else{
    emojiEl.textContent = state.theme.emojis?.[place] || '';
  }
}
function applyAllDockIcons(){
  ['chat','contacts','moments','theme'].forEach(setDockIcon);
}
function setBg(dataUrl){
  const bgEl = $('#bg');
  if(dataUrl){
    bgEl.style.backgroundImage = `url(${dataUrl})`;
  }else{
    // 默认渐变
    bgEl.style.backgroundImage = 'linear-gradient(135deg,#1e3c72 0%,#2a5298 100%)';
  }
}

/* ====== 时间与主屏 ====== */
function updateClock(){
  const now = new Date();
  const hh = String(now.getHours()).padStart(2,'0');
  const mm = String(now.getMinutes()).padStart(2,'0');
  $('#clockTime').textContent = `${hh}:${mm}`;
  const dateStr = now.toLocaleDateString('zh-CN',{weekday:'long',month:'long',day:'numeric'});
  $('#clockDate').textContent = dateStr;
}
setInterval(updateClock, 1000); updateClock();

/* ====== 层切换 ====== */
function openLayer(id){ $(id).classList.add('show'); }
function closeTopLayer(){
  // 关闭最上面的一个层（最后一个 .layer.show）
  const layers = Array.from($$('.layer.show'));
  if(layers.length) layers[layers.length-1].classList.remove('show');
}

// Dock 绑定
$('#dockChat').onclick = ()=> openLayer('#layerChat');
$('#dockContacts').onclick = ()=> openLayer('#layerContacts');
$('#dockMoments').onclick = ()=> { openLayer('#layerMoments'); $('#momentsBadge').style.display='none'; };
$('#dockTheme').onclick = ()=> openLayer('#layerTheme');
$$('[data-back]').forEach(b=> b.onclick = closeTopLayer);

/* ====== 数据准备 ====== */
function initData(){
  // 联系人
  const savedContacts = JSON.parse(localStorage.getItem('contacts') || 'null');
  state.contacts = savedContacts || defaultContacts;
  // 对话
  state.dialogs = JSON.parse(localStorage.getItem('dialogs') || '{}');
  state.contacts.forEach(c => {
    if(!state.dialogs[c.id]){
      state.dialogs[c.id] = [{sender:'ai', text:`你好，我是${c.name}，有什么想聊的嘛？`}];
    }
  });
  localStorage.setItem('contacts', JSON.stringify(state.contacts));
  localStorage.setItem('dialogs', JSON.stringify(state.dialogs));
}
initData();

/* ====== 渲染：聊天列表/通讯录/朋友圈 ====== */
function renderChatList(){
  const wrap = $('#chatList'); wrap.innerHTML = '';
  state.contacts.forEach(c=>{
    const last = state.dialogs[c.id]?.slice(-1)[0];
    const sub = last ? (last.text?.slice(0,24) + (last.text.length>24?'…':'')) : '暂无消息';
    const row = document.createElement('div'); row.className='item';
    row.innerHTML = `
      <div class="avatar">${c.avatar || '👤'}</div>
      <div class="i-col">
        <div class="i-title">${c.name}</div>
        <div class="i-sub">${sub}</div>
      </div>
    `;
    row.onclick = ()=> openDialog(c.id);
    wrap.appendChild(row);
  });
}
function renderContacts(){
  const wrap = $('#contactList'); wrap.innerHTML = '';
  state.contacts.forEach(c=>{
    const row = document.createElement('div'); row.className='item';
    row.innerHTML = `
      <div class="avatar">${c.avatar || '👤'}</div>
      <div class="i-col">
        <div class="i-title">${c.name}</div>
        <div class="i-sub">点此开始与 ${c.name} 对话</div>
      </div>
    `;
    row.onclick = ()=> { openLayer('#layerChat'); openDialog(c.id); };
    wrap.appendChild(row);
  });
}
function renderMoments(){
  const wrap = $('#momentsList'); wrap.innerHTML = '';
  const demos = [
    {who:'AI助手', avatar:'🤖', text:'欢迎来到朋友圈～试试发一条链接给我！', time:'刚刚'},
    {who:'狸狸', avatar:'🦝', text:'今日占卜：吉。不拘泥于小节，心情会更舒畅。', time:'1小时前'}
  ];
  demos.forEach(m=>{
    const row = document.createElement('div'); row.className='item';
    row.innerHTML = `
      <div class="avatar">${m.avatar}</div>
      <div class="i-col">
        <div class="i-title">${m.who}</div>
        <div class="i-sub">${m.text}</div>
      </div>
      <div class="i-sub" style="min-width:60px;text-align:right">${m.time}</div>
    `;
    wrap.appendChild(row);
  });
}

/* ====== 对话窗口 ====== */
function openDialog(id){
  state.currentDialog = id;
  $('#dialogTitle').textContent = state.contacts.find(c=>c.id===id)?.name || '对话';
  renderDialog();
  // 切换层到对话
  $('#layerDialog').classList.add('show');
}
function renderDialog(){
  const wrap = $('#chatWrap'); wrap.innerHTML = '';
  const msgs = state.dialogs[state.currentDialog] || [];
  msgs.forEach(m=>{
    const row = document.createElement('div');
    row.className = 'msg ' + (m.sender==='user'?'user':'ai');
    const b = document.createElement('div'); b.className = 'bubble';
    if(m.html){ b.innerHTML = m.text; } else { b.textContent = m.text; }
    row.appendChild(b); wrap.appendChild(row);
  });
  wrap.scrollTop = wrap.scrollHeight;
}
function saveDialogs(){ localStorage.setItem('dialogs', JSON.stringify(state.dialogs)); }

$('#btnSend').onclick = ()=>{
  const input = $('#inputMsg');
  const text = (input.value||'').trim();
  if(!text || !state.currentDialog) return;
  pushMsg('user', text);
  input.value = '';
  sendAI(text);
};
$('#inputMsg').addEventListener('keypress', e=>{
  if(e.key==='Enter'){ e.preventDefault(); $('#btnSend').click(); }
});
function pushMsg(sender, text, html=false){
  const id = state.currentDialog;
  if(!state.dialogs[id]) state.dialogs[id]=[];
  state.dialogs[id].push({sender, text, html});
  saveDialogs();
  renderDialog();
}
function sendAI(text){
  const icon = $('#sendIcon'); const prev = icon.innerHTML;
  icon.innerHTML = '<div class="loading"></div>';
  // 演示用：本地回复，不依赖外网
  setTimeout(()=>{
    const reply = generateLocalReply(text);
    pushMsg('ai', reply);
    icon.innerHTML = prev;
  }, 500);
}
function generateLocalReply(input){
  // 轻量规则：链接回显、问候、普通闲聊
  const link = input.match(/https?:\/\/\S+/);
  if(link) return `收到链接：${link[0]} ；我已记下。`;
  if(/(你好|hi|hello)/i.test(input)) return '你好呀～需要我做点什么？';
  if(/(图片|照片)/.test(input)) return '如果要发图片，点一下输入框上方的「图片」按钮就行。';
  return '我在听～继续说说看。';
}

/* ====== 工具按钮（特殊消息） ====== */
document.querySelectorAll('.tbtn').forEach(btn=>{
  btn.onclick = ()=>{
    const tool = btn.dataset.tool;
    if(!state.currentDialog) return;
    if(tool==='img'){
      const html = `<div class="special-message image" style="border-radius:12px;padding:10px;background:linear-gradient(135deg,#74b9ff,#0984e3);color:#fff">
        <div style="font-weight:700;margin-bottom:6px">📸 图片</div>
        <div>（示例）这是一张来自相册的图片描述。</div>
      </div>`;
      pushMsg('user', html, true);
      pushMsg('ai', '我看到了你的图片描述～很有趣！');
    }else if(tool==='mic'){
      const html = `<div class="special-message voice" style="border-radius:12px;padding:10px;background:linear-gradient(135deg,#fd79a8,#e84393);color:#fff">
        <div style="font-weight:700;margin-bottom:6px">🎤 语音</div>
        <div>时长：15秒<br>内容：今天心情不错！</div>
      </div>`;
      pushMsg('user', html, true);
      pushMsg('ai', '语音收到～我也被你的好心情感染啦！');
    }else if(tool==='link'){
      const html = `<div class="special-message link" style="border-radius:12px;padding:10px;background:linear-gradient(135deg,#55a3ff,#3742fa);color:#fff">
        <div style="font-weight:700;margin-bottom:6px">🔗 链接</div>
        <div>标题：示例页面<br>链接：https://example.com</div>
      </div>`;
      pushMsg('user', html, true);
      pushMsg('ai', '谢谢链接，我记下啦～');
    }else if(tool==='pay'){
      const html = `<div class="special-message money" style="border-radius:12px;padding:10px;background:linear-gradient(135deg,#ffeaa7,#fdcb6e);color:#2d3436">
        <div style="font-weight:700;margin-bottom:6px">💰 转账</div>
        <div>金额：¥6.66<br>备注：给狸狸买苹果！</div>
      </div>`;
      pushMsg('user', html, true);
      pushMsg('ai', '收到转账（示例）谢谢～我替你记账啦。');
    }
  }
});

/* ====== 主题：壁纸/图标 ====== */
// 加载壁纸
if(state.theme.bg){ setBg(state.theme.bg); } else { setBg(''); }
// 文件 -> dataURL
function fileToDataUrl(file){
  return new Promise((resolve,reject)=>{
    const reader = new FileReader();
    reader.onload = e=> resolve(e.target.result);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}
$('#wallpaperFile').addEventListener('change', async (e)=>{
  const file = e.target.files?.[0];
  if(!file) return;
  const dataUrl = await fileToDataUrl(file);
  state.theme.bg = dataUrl; saveTheme(); setBg(dataUrl);
});
$('#btnResetBg').onclick = ()=>{ state.theme.bg=''; saveTheme(); setBg(''); };

// 图标编辑器：回显 emoji 与图片
function refreshIconEditors(){
  const places = ['chat','contacts','moments','theme'];
  places.forEach(p=>{
    const imgEl = {
      chat: $('#iconChatImg'), contacts: $('#iconContactsImg'),
      moments: $('#iconMomentsImg'), theme: $('#iconThemeImg')
    }[p];
    const emojiInput = document.querySelector(`input[data-emoji="${p}"]`);
    const conf = state.theme.icons[p]||{};
    imgEl.src = conf.dataUrl || '';
    imgEl.style.display = conf.dataUrl ? 'block' : 'none';
    emojiInput.value = state.theme.emojis[p] || '';
  });
}
refreshIconEditors(); applyAllDockIcons();

document.querySelectorAll('input[type="file"][data-icon]').forEach(inp=>{
  inp.addEventListener('change', async (e)=>{
    const slot = e.target.getAttribute('data-icon');
    const file = e.target.files?.[0];
    if(!file) return;
    const dataUrl = await fileToDataUrl(file);
    state.theme.icons[slot] = { dataUrl };
    saveTheme(); refreshIconEditors(); applyAllDockIcons();
  });
});
document.querySelectorAll('input[data-emoji]').forEach(inp=>{
  inp.addEventListener('input', e=>{
    const slot = e.target.getAttribute('data-emoji');
    state.theme.emojis[slot] = e.target.value || '';
  });
});
$('#btnSaveIcons').onclick = ()=>{ saveTheme(); applyAllDockIcons(); alert('已保存 Dock 图标'); };
$('#btnResetIcons').onclick = ()=>{
  state.theme.icons = {chat:{},contacts:{},moments:{},theme:{}};
  state.theme.emojis = {chat:'💬',contacts:'📒',moments:'📰',theme:'🎨'};
  saveTheme(); refreshIconEditors(); applyAllDockIcons();
};

/* ====== 启动渲染 ====== */
renderChatList(); renderContacts(); renderMoments();

// 默认打开时给朋友圈一个“未读”徽标示意
setTimeout(()=>{ $('#momentsBadge').style.display='inline-flex'; }, 600);

// 背景触摸小优化：防止模态打开时滚动穿透
document.addEventListener('touchmove', function(e){
  if($$('.layer.show').length){ e.preventDefault(); }
}, {passive:false});
</script>
</body>
</html>