<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no,viewport-fit=cover" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<title>ç‹¸ç‹¸èŠå¤©å™¨</title>
<style>
/* ============ Reset & Vars ============ */
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
:root{
  --bg-image: linear-gradient(135deg,#1e3c72 0%,#2a5298 100%);
  --glass: rgba(255,255,255,.15);
  --glass-2: rgba(255,255,255,.25);
  --border: rgba(255,255,255,.2);
  --text: #fff;
  --accent: #007AFF;
  --muted: rgba(255,255,255,.65);
  --bubble: rgba(255,255,255,.15);
}
html,body{height:100%;background:#000;color:var(--text);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Inter,system-ui,Helvetica,Arial,sans-serif}
body{
  height:100vh;height:100svh;overflow:hidden;
  padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
}
button{font:inherit}

/* ============ App Container & BG ============ */
.app-container{position:relative;width:100%;height:100%;background:var(--bg-image) center/cover no-repeat;}

/* ============ Home (Clock only) ============ */
.home-screen{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 24px 160px;gap:10px}
.clock{
  font-size: clamp(56px, 12vw, 120px);
  font-weight:700;line-height:1.05;letter-spacing:2px;text-align:center;text-shadow:0 8px 40px rgba(0,0,0,.35);
}
.date{font-size:clamp(14px,3.4vw,18px);color:var(--muted);letter-spacing:.5px}

/* ============ Dock (only clickable items live here) ============ */
.dock{
  position:fixed;left:20px;right:20px;
  bottom: calc(env(safe-area-inset-bottom) + 20px);
  height:80px;display:flex;align-items:center;justify-content:center;gap:22px;
  border-radius:24px;background:var(--glass);backdrop-filter: blur(20px);
  border:1px solid var(--border);
}

/* Dock icon as masked square that supports custom pictures */
.dock-icon{
  width:58px;height:58px;position:relative;cursor:pointer;flex:0 0 58px;
  display:flex;align-items:center;justify-content:center;border-radius:16px;
  background: rgba(255,255,255,.10);transition:transform .15s ease;
  overflow:hidden; /* é¿å…å›¾åƒå¤–æº¢ */
  border:1px solid rgba(255,255,255,.18);
}
.dock-icon:active{transform:scale(.94)}
.dock-icon-inner{
  position:absolute;inset:0;
  background:var(--icon-bg,transparent) center/cover no-repeat;
  /* Icon â€œmaskâ€ for shape (rounded squircle) â€” Safari/WebKit support */
  -webkit-mask-image: radial-gradient(18px at 18px 18px, #000 98%, transparent 102%),
                      radial-gradient(18px at calc(100% - 18px) 18px, #000 98%, transparent 102%),
                      radial-gradient(18px at 18px calc(100% - 18px), #000 98%, transparent 102%),
                      radial-gradient(18px at calc(100% - 18px) calc(100% - 18px), #000 98%, transparent 102%),
                      linear-gradient(#000,#000);
  -webkit-mask-composite: source-over, source-over, source-over, source-over, xor;
          mask-image: none; /* å…¼å®¹æ€§å¤„ç†ï¼Œä¸»è¦é  -webkit-mask */
}
.dock-icon-label{
  position:absolute;bottom:-18px;left:0;right:0;text-align:center;
  font-size:10px;color:#fff;opacity:.85;pointer-events:none;
}

/* Emoji fallbackï¼ˆå½“æ²¡æœ‰è‡ªå®šä¹‰å›¾æ ‡æ—¶æ˜¾ç¤ºï¼‰ */
.dock-icon-emoji{
  position:relative;z-index:1;font-size:22px;filter: drop-shadow(0 2px 8px rgba(0,0,0,.35));
}

/* ============ Screens ============ */
.screen{position:absolute;inset:0;display:none;background:rgba(0,0,0,.92)}
.screen.active{display:block}

/* ============ Chat App ============ */
.chat-header{
  height: calc(56px + env(safe-area-inset-top));
  padding: env(safe-area-inset-top) 16px 0;
  display:flex;align-items:center;gap:10px;border-bottom:1px solid rgba(255,255,255,.1)
}
.back-btn{background:none;border:none;color:#fff;font-size:18px;padding:8px}
.chat-title{font-weight:600;font-size:18px}
.chat-nav{height:46px;display:flex;align-items:center;border-bottom:1px solid rgba(255,255,255,.08)}
.nav-item{flex:1;text-align:center;color:rgba(255,255,255,.65);padding:10px 0;cursor:pointer}
.nav-item.active{color:#fff;border-bottom:2px solid var(--accent)}
.chat-list,.moments-list{height:calc(100% - 56px - env(safe-area-inset-top) - 46px);overflow:auto}
.chat-item{display:flex;align-items:center;gap:12px;padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.06);cursor:pointer}
.chat-item:active{background:rgba(255,255,255,.08)}
.chat-avatar{width:48px;height:48px;border-radius:24px;background:linear-gradient(135deg,#007AFF,#5AC8FA);display:flex;align-items:center;justify-content:center}
.chat-name{font-size:16px}
.chat-preview{font-size:13px;color:rgba(255,255,255,.65);margin-top:4px}

.chat-screen .chat-messages{height:calc(100% - 60px - env(safe-area-inset-top) - 120px);overflow:auto;padding:16px}
.message{display:flex;margin-bottom:12px}
.message-bubble{max-width:72%;padding:12px 14px;border-radius:18px;word-wrap:break-word}
.message.ai .message-bubble{background:var(--bubble);border-bottom-left-radius:6px}
.message.user{justify-content:flex-end}
.message.user .message-bubble{background:var(--accent);color:#fff;border-bottom-right-radius:6px}

.chat-input-area{height:calc(120px + env(safe-area-inset-bottom));padding:10px 16px calc(10px + env(safe-area-inset-bottom));border-top:1px solid rgba(255,255,255,.08)}
.chat-tools{display:flex;gap:8px;margin-bottom:10px}
.tool-btn{flex:1;height:36px;border:none;border-radius:18px;background:var(--bubble);color:#fff;cursor:pointer;font-size:12px}
.tool-btn:active{transform:scale(.97)}
.chat-input{display:flex;gap:8px}
.chat-input input{flex:1;height:40px;border:none;border-radius:20px;padding:0 14px;background:var(--bubble);color:#fff;outline:none}
.send-btn{width:40px;height:40px;border:none;border-radius:20px;background:var(--accent);color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center}

/* ============ Settings (API) ============ */
.settings-header{height: calc(56px + env(safe-area-inset-top));padding: env(safe-area-inset-top) 16px 0;display:flex;align-items:center;gap:10px;border-bottom:1px solid rgba(255,255,255,.1)}
.settings-content{height:calc(100% - 56px - env(safe-area-inset-top));overflow:auto;padding:16px}
.setting-item{background:var(--glass);backdrop-filter:blur(16px);border:1px solid var(--border);border-radius:12px;padding:14px 14px 10px;margin-bottom:12px}
.setting-item label{display:block;margin-bottom:8px;font-weight:600}
.setting-item input,.setting-item select{width:100%;height:40px;border:none;border-radius:10px;padding:0 12px;background:rgba(255,255,255,.14);color:#fff;outline:none}

/* ============ Theme (wallpaper + icons) ============ */
.theme-header{height: calc(56px + env(safe-area-inset-top));padding: env(safe-area-inset-top) 16px 0;display:flex;align-items:center;gap:10px;border-bottom:1px solid rgba(255,255,255,.1)}
.theme-content{height:calc(100% - 56px - env(safe-area-inset-top));overflow:auto;padding:16px}
.card{background:var(--glass);border:1px solid var(--border);backdrop-filter:blur(16px);border-radius:14px;padding:14px;margin-bottom:14px}
.card h4{margin-bottom:10px}

/* icon list preview */
.icon-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
.icon-preview{
  width:64px;height:64px;border-radius:16px;position:relative;overflow:hidden;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.08);
}
.icon-preview-inner{
  position:absolute;inset:0;background: center/cover no-repeat;
  -webkit-mask-image: radial-gradient(20px at 20px 20px, #000 98%, transparent 102%),
                      radial-gradient(20px at calc(100% - 20px) 20px, #000 98%, transparent 102%),
                      radial-gradient(20px at 20px calc(100% - 20px), #000 98%, transparent 102%),
                      radial-gradient(20px at calc(100% - 20px) calc(100% - 20px), #000 98%, transparent 102%),
                      linear-gradient(#000,#000);
  -webkit-mask-composite: source-over, source-over, source-over, source-over, xor;
}
.icon-actions{display:flex;gap:6px;margin-top:6px}
.small-btn{flex:1;height:34px;border:none;border-radius:10px;background:var(--accent);color:#fff;cursor:pointer}

/* ============ Modal & etc ============ */
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.78);z-index:1000;align-items:center;justify-content:center;padding:20px}
.modal-content{width:100%;max-width:420px;background:rgba(255,255,255,.96);color:#333;border-radius:16px;padding:18px}
.modal-header{font-weight:700;margin-bottom:12px;text-align:center}
.modal-input,.modal-textarea,.modal-select{width:100%;border:1px solid #e5e7eb;border-radius:10px;padding:10px;margin:6px 0;outline:none}
.modal-buttons{display:flex;gap:10px;margin-top:12px}
.modal-btn{flex:1;border:none;border-radius:10px;padding:10px;font-weight:700;cursor:pointer}
.modal-btn.cancel{background:#f3f4f6;color:#374151}
.modal-btn.confirm{background:#007AFF;color:#fff}

/* util */
.loading{width:20px;height:20px;border:2px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

@media (max-width:375px){
  .dock{gap:18px}
}
</style>
</head>
<body>
<div class="app-container" id="appContainer">
  <!-- Home (Clock Only) -->
  <section class="home-screen" id="homeScreen">
    <div class="clock" id="clock">00:00</div>
    <div class="date" id="dateText">8æœˆ15æ—¥ å‘¨äº”</div>
  </section>

  <!-- Dock -->
  <nav class="dock">
    <div class="dock-icon" onclick="openChatApp()" title="å¾®ä¿¡/èŠå¤©">
      <div class="dock-icon-inner" id="icon-chat"></div>
      <div class="dock-icon-emoji">ğŸ’¬</div>
      <div class="dock-icon-label">å¾®ä¿¡</div>
    </div>
    <div class="dock-icon" onclick="openSettings()" title="è®¾ç½®">
      <div class="dock-icon-inner" id="icon-settings"></div>
      <div class="dock-icon-emoji">âš™ï¸</div>
      <div class="dock-icon-label">è®¾ç½®</div>
    </div>
    <div class="dock-icon" onclick="openTheme()" title="ä¸»é¢˜">
      <div class="dock-icon-inner" id="icon-theme"></div>
      <div class="dock-icon-emoji">ğŸ–¼ï¸</div>
      <div class="dock-icon-label">ä¸»é¢˜</div>
    </div>
  </nav>

  <!-- Chat APP -->
  <section class="screen" id="chatApp">
    <div class="chat-nav">
      <div class="nav-item active" onclick="switchTab('chats')">å¾®ä¿¡</div>
      <div class="nav-item" onclick="switchTab('contacts')">é€šè®¯å½•</div>
      <div class="nav-item" onclick="switchTab('moments')">æœ‹å‹åœˆ</div>
      <div class="nav-item" onclick="goHome()">æˆ‘</div>
    </div>

    <div class="chat-list" id="chatList"></div>

    <div class="moments-list" id="momentsList" style="display:none;">
      <div class="chat-item" style="border:none">
        <div class="chat-avatar">ğŸ¤–</div>
        <div>
          <div class="chat-name">AIåŠ©æ‰‹</div>
          <div class="chat-preview">æ¬¢è¿ä½¿ç”¨ï¼ä½ å¯ä»¥åœ¨ä¸»é¢˜é‡Œæ¢å£çº¸/å›¾æ ‡ï¼Œåœ¨è®¾ç½®é‡Œé…ç½® APIã€‚</div>
        </div>
      </div>
    </div>

    <button class="add-contact-btn" onclick="openAddContactModal()" id="addContactBtn" style="position:fixed;right:20px;bottom:calc(env(safe-area-inset-bottom) + 110px);width:56px;height:56px;border-radius:28px;background:#007AFF;border:none;color:#fff;box-shadow:0 6px 22px rgba(0,123,255,.4);font-size:24px;">+</button>
  </section>

  <!-- Chat Screen -->
  <section class="screen" id="chatScreen">
    <div class="chat-header">
      <button class="back-btn" onclick="backToChatApp()">â†</button>
      <div class="chat-title" id="chatTitle">AIåŠ©æ‰‹</div>
    </div>
    <div class="chat-messages" id="chatMessages"></div>
    <div class="chat-input-area">
      <div class="chat-tools">
        <button class="tool-btn" onclick="openImageModal()">ğŸ–¼ï¸ å›¾ç‰‡</button>
        <button class="tool-btn" onclick="openVoiceModal()">ğŸ¤ è¯­éŸ³</button>
        <button class="tool-btn" onclick="openLinkModal()">ğŸ”— é“¾æ¥</button>
        <button class="tool-btn" onclick="openMoneyModal()">ğŸ’° è½¬è´¦</button>
      </div>
      <div class="chat-input">
        <input id="messageInput" placeholder="è¾“å…¥æ¶ˆæ¯..." onkeypress="handleKeyPress(event)"/>
        <button class="send-btn" onclick="sendMessage()"><span id="sendIcon">â¤</span></button>
      </div>
    </div>
  </section>

  <!-- Settings (API) -->
  <section class="screen" id="settingsScreen">
    <div class="settings-header">
      <button class="back-btn" onclick="goHome()">â†</button>
      <div>APIè®¾ç½®</div>
    </div>
    <div class="settings-content">
      <div class="setting-item">
        <label>APIæœåŠ¡å•†</label>
        <select id="apiProvider" onchange="updateApiSettings()">
          <option value="openai">OpenAI</option>
          <option value="claude">Claude</option>
          <option value="custom">è‡ªå®šä¹‰</option>
        </select>
      </div>
      <div class="setting-item">
        <label>APIåœ°å€</label>
        <input id="apiUrl" placeholder="https://api.openai.com/v1/chat/completions"/>
      </div>
      <div class="setting-item">
        <label>APIå¯†é’¥</label>
        <input id="apiKey" type="password" placeholder="è¾“å…¥ä½ çš„APIå¯†é’¥"/>
      </div>
      <div class="setting-item">
        <label>é»˜è®¤æ¨¡å‹</label>
        <input id="modelName" placeholder="gpt-3.5-turbo"/>
      </div>
      <div class="setting-item">
        <button class="small-btn" style="width:100%" onclick="saveSettings()">ä¿å­˜è®¾ç½®</button>
      </div>
    </div>
  </section>

  <!-- Theme (wallpaper + icons) -->
  <section class="screen" id="themeScreen">
    <div class="theme-header">
      <button class="back-btn" onclick="goHome()">â†</button>
      <div>ä¸»é¢˜ï¼ˆå£çº¸ & å›¾æ ‡ï¼‰</div>
    </div>
    <div class="theme-content">
      <div class="card">
        <h4>å£çº¸</h4>
        <input type="file" accept="image/*" class="modal-input" onchange="uploadWallpaper(event)"/>
        <div style="font-size:12px;color:#ddd;margin-top:6px">æç¤ºï¼šå·²æŒ‰ <code>cover</code> é“ºæ»¡ï¼Œæ”¯æŒ Safari å…¨å±ä¸å®‰å…¨åŒºã€‚</div>
      </div>

      <div class="card">
        <h4>Dock å›¾æ ‡ï¼ˆæ”¯æŒè‡ªå®šä¹‰ï¼‰</h4>
        <div class="icon-grid" id="iconGrid">
          <!-- åŠ¨æ€æ¸²æŸ“ chat / settings / theme ä¸‰ä¸ªå›¾æ ‡çš„é¢„è§ˆä¸æŒ‰é’® -->
        </div>
      </div>

      <div class="card">
        <h4>ä¸€é”®é‡ç½®ä¸»é¢˜</h4>
        <button class="small-btn" onclick="resetTheme()">æ¢å¤é»˜è®¤</button>
      </div>
    </div>
  </section>
</div>

<!-- ======= Modals (Add contact & special messages) ======= -->
<div class="modal" id="addContactModal">
  <div class="modal-content">
    <div class="modal-header">æ·»åŠ AIè”ç³»äºº</div>
    <input class="modal-input" id="contactName" placeholder="è”ç³»äººå§“å" />
    <input class="modal-input" id="contactEmoji" placeholder="å¤´åƒè¡¨æƒ… (å¦‚: ğŸ¤–)" />
    <textarea class="modal-textarea" id="contactPrompt" placeholder="ä¸ªæ€§åŒ–promptï¼Œæè¿°è¿™ä¸ªAIçš„ç‰¹ç‚¹å’Œå›ç­”é£æ ¼..."></textarea>
    <div class="modal-buttons">
      <button class="modal-btn cancel" onclick="closeModal()">å–æ¶ˆ</button>
      <button class="modal-btn confirm" onclick="addContact()">æ·»åŠ </button>
    </div>
  </div>
</div>

<div class="modal" id="imageModal">
  <div class="modal-content">
    <div class="modal-header">ğŸ“¸ å‘é€å›¾ç‰‡</div>
    <input class="modal-input" id="imageTitle" placeholder="å›¾ç‰‡æ ‡é¢˜" />
    <textarea class="modal-textarea" id="imageDesc" placeholder="è¯·æè¿°è¿™å¼ å›¾ç‰‡çš„å†…å®¹..."></textarea>
    <div class="modal-buttons">
      <button class="modal-btn cancel" onclick="closeModal()">å–æ¶ˆ</button>
      <button class="modal-btn confirm" onclick="sendImage()">å‘é€</button>
    </div>
  </div>
</div>

<div class="modal" id="voiceModal">
  <div class="modal-content">
    <div class="modal-header">ğŸ¤ å‘é€è¯­éŸ³</div>
    <input class="modal-input" id="voiceDuration" placeholder="è¯­éŸ³æ—¶é•¿ï¼ˆç§’ï¼‰" />
    <textarea class="modal-textarea" id="voiceContent" placeholder="è¯·è¾“å…¥è¦å‘é€çš„è¯­éŸ³å†…å®¹..."></textarea>
    <div class="modal-buttons">
      <button class="modal-btn cancel" onclick="closeModal()">å–æ¶ˆ</button>
      <button class="modal-btn confirm" onclick="sendVoice()">å‘é€</button>
    </div>
  </div>
</div>

<div class="modal" id="linkModal">
  <div class="modal-content">
    <div class="modal-header">ğŸ”— åˆ†äº«é“¾æ¥</div>
    <input class="modal-input" id="linkTitle" placeholder="é“¾æ¥æ ‡é¢˜" />
    <input class="modal-input" id="linkUrl" placeholder="é“¾æ¥åœ°å€" />
    <textarea class="modal-textarea" id="linkDesc" placeholder="é“¾æ¥æè¿°..."></textarea>
    <div class="modal-buttons">
      <button class="modal-btn cancel" onclick="closeModal()">å–æ¶ˆ</button>
      <button class="modal-btn confirm" onclick="sendLink()">å‘é€</button>
    </div>
  </div>
</div>

<div class="modal" id="moneyModal">
  <div class="modal-content">
    <div class="modal-header">ğŸ’° è½¬è´¦çº¢åŒ…</div>
    <input class="modal-input" id="moneyAmount" placeholder="è½¬è´¦é‡‘é¢" />
    <input class="modal-input" id="moneyNote" placeholder="è½¬è´¦å¤‡æ³¨" />
    <select class="modal-select" id="moneyType">
      <option value="transfer">è½¬è´¦</option>
      <option value="redpack">çº¢åŒ…</option>
    </select>
    <div class="modal-buttons">
      <button class="modal-btn cancel" onclick="closeModal()">å–æ¶ˆ</button>
      <button class="modal-btn confirm" onclick="sendMoney()">å‘é€</button>
    </div>
  </div>
</div>

<script>
/* ================== State & Storage ================== */
const state = {
  currentContact: null,
  currentTab: 'chats',
  contacts: [],
  messages: {},
  config: {
    apiProvider: 'openai',
    apiUrl: 'https://api.openai.com/v1/chat/completions',
    apiKey: '',
    modelName: 'gpt-3.5-turbo'
  },
  theme: {
    wallpaper: null, // dataURL or css gradient
    icons: { chat:null, settings:null, theme:null } // dataURL for 3 dock icons
  }
};

const LS_KEYS = {
  contacts: 'contacts',
  messages: 'messages',
  config: 'aiChatConfig',
  theme: 'aiThemeConfig'
};

/* ================== Clock ================== */
function pad(n){return n<10?('0'+n):n}
function updateClock(){
  const now = new Date();
  const h = pad(now.getHours()), m = pad(now.getMinutes());
  const weekday = ['å‘¨æ—¥','å‘¨ä¸€','å‘¨äºŒ','å‘¨ä¸‰','å‘¨å››','å‘¨äº”','å‘¨å…­'][now.getDay()];
  const dateStr = `${now.getMonth()+1}æœˆ${now.getDate()}æ—¥ ${weekday}`;
  document.getElementById('clock').textContent = `${h}:${m}`;
  document.getElementById('dateText').textContent = dateStr;
}
setInterval(updateClock, 1000); updateClock();

/* ================== Screen Switch ================== */
function show(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  if(id) document.getElementById(id).classList.add('active');
}
function goHome(){ document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); }
function openChatApp(){ show('chatApp'); switchTab('chats'); }
function openSettings(){ show('settingsScreen'); updateSettingsUI(); }
function openTheme(){ show('themeScreen'); renderIconGrid(); }

/* ================== Tabs ================== */
function switchTab(tab){
  state.currentTab = tab;
  document.querySelectorAll('.chat-nav .nav-item').forEach(n=>n.classList.remove('active'));
  const tabs = ['chats','contacts','moments','me'];
  const idx = tabs.indexOf(tab);
  if(idx>-1) document.querySelectorAll('.chat-nav .nav-item')[idx].classList.add('active');

  document.getElementById('chatList').style.display = tab==='chats' ? 'block' : 'none';
  document.getElementById('momentsList').style.display = tab==='moments' ? 'block' : 'none';
  document.getElementById('addContactBtn').style.display = tab==='chats' ? 'block' : 'none';

  if(tab==='me'){ goHome(); }
}

/* ================== Contacts & Messages ================== */
function initContacts(){
  const defaultContacts = [{id:'ai-assistant',name:'AIåŠ©æ‰‹',emoji:'ğŸ¤–',prompt:'ä½ æ˜¯ä¸€ä¸ªæœ‰ç”¨çš„AIåŠ©æ‰‹ï¼Œè¯·ç”¨ä¸­æ–‡å›ç­”é—®é¢˜ï¼Œå›ç­”è¦ç®€æ´æ˜äº†ã€‚'}];
  const savedContacts = localStorage.getItem(LS_KEYS.contacts);
  const savedMessages = localStorage.getItem(LS_KEYS.messages);
  state.contacts = savedContacts ? JSON.parse(savedContacts) : defaultContacts;
  state.messages = savedMessages ? JSON.parse(savedMessages) : {};
  state.contacts.forEach(c=>{ if(!state.messages[c.id]) state.messages[c.id]=[]; });

  // åˆå§‹æ¬¢è¿è¯­ï¼ˆä»…é¦–æ¬¡ï¼‰
  if(!state.messages['ai-assistant'] || state.messages['ai-assistant'].length===0){
    state.messages['ai-assistant']=[{text:'ä½ å¥½ï¼æˆ‘æ˜¯AIåŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ',sender:'ai',isHtml:false,timestamp:Date.now()}];
    localStorage.setItem(LS_KEYS.messages, JSON.stringify(state.messages));
  }
  renderChatList();
}
function renderChatList(){
  const list = document.getElementById('chatList'); list.innerHTML='';
  state.contacts.forEach(contact=>{
    const msgs = state.messages[contact.id]||[];
    const last = msgs[msgs.length-1];
    const preview = last ? (last.text.replace(/<[^>]*>?/gm,'').slice(0,24)+(last.text.length>24?'...':'')) : 'æš‚æ— æ¶ˆæ¯';
    const item = document.createElement('div'); item.className='chat-item';
    item.onclick=()=>openChat(contact);
    item.innerHTML = `
      <div class="chat-avatar">${contact.emoji}</div>
      <div>
        <div class="chat-name">${contact.name}</div>
        <div class="chat-preview">${preview}</div>
      </div>`;
    list.appendChild(item);
  });
}
function openChat(contact){
  state.currentContact = contact;
  show('chatScreen');
  document.getElementById('chatTitle').textContent = contact.name;
  loadChatMessages();
}
function backToChatApp(){ show('chatApp'); }
function loadChatMessages(){
  const wrap = document.getElementById('chatMessages'); wrap.innerHTML='';
  (state.messages[state.currentContact.id]||[]).forEach(m=>addMessage(m.text,m.sender,m.isHtml,true));
  wrap.scrollTop = wrap.scrollHeight;
}
function addMessage(text,sender,isHtml=false,skipSave=false){
  const wrap = document.getElementById('chatMessages');
  const row = document.createElement('div'); row.className=`message ${sender}`;
  const bubble = document.createElement('div'); bubble.className='message-bubble';
  isHtml ? bubble.innerHTML=text : bubble.textContent=text;
  row.appendChild(bubble); wrap.appendChild(row);
  if(!skipSave) saveMessage(text,sender,isHtml);
  wrap.scrollTop = wrap.scrollHeight;
}
function saveMessage(text,sender,isHtml=false){
  const id = state.currentContact.id;
  if(!state.messages[id]) state.messages[id]=[];
  state.messages[id].push({text,sender,isHtml,timestamp:Date.now()});
  localStorage.setItem(LS_KEYS.messages, JSON.stringify(state.messages));
  renderChatList();
}

/* ================== Send Message & API ================== */
function handleKeyPress(e){ if(e.key==='Enter') sendMessage(); }
async function sendMessage(){
  const input = document.getElementById('messageInput');
  const message = (input.value||'').trim(); if(!message || !state.currentContact) return;

  // å…ˆæ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
  addMessage(message,'user'); input.value='';

  // æœªé…ç½® API ä¹Ÿä¸é˜»æ–­ä½ èŠå¤©ï¼šç»™å‡ºæç¤ºä½†ä¸é˜‰å‰² UI
  if(!state.config.apiKey){
    const t = 'ï¼ˆæç¤ºï¼‰æœªé…ç½® APIï¼Œå…ˆåœ¨â€œè®¾ç½®â€é‡Œå¡«ä¸€ä¸‹ apiKey æ‰èƒ½è”ç½‘å¯¹è¯~';
    addMessage(t,'ai'); return;
  }

  const sendIcon = document.getElementById('sendIcon');
  sendIcon.innerHTML = '<div class="loading"></div>';

  try{
    const reply = await callAI(message);
    addMessage(reply,'ai');
  }catch(err){
    addMessage('æŠ±æ­‰ï¼ŒAIæœåŠ¡ä¸å¯ç”¨ï¼š'+ err.message,'ai');
  }finally{
    sendIcon.innerHTML='â¤';
  }
}
async function callAI(message){
  const c = state.currentContact;
  let body = {
    model: state.config.modelName,
    messages: [{role:'system',content:c.prompt},{role:'user',content:message}],
    max_tokens: 1000, temperature: 0.7
  };
  if(state.config.apiProvider==='claude'){
    body = {model:state.config.modelName,system:c.prompt,messages:[{role:'user',content:message}],max_tokens:1000};
  }
  const res = await fetch(state.config.apiUrl, {
    method:'POST',
    headers:{
      'Content-Type':'application/json',
      'Authorization':`Bearer ${state.config.apiKey}`,
      ...(state.config.apiProvider==='claude'? {'anthropic-version':'2023-06-01'} : {})
    },
    body: JSON.stringify(body)
  });
  if(!res.ok) throw new Error(`APIè¯·æ±‚å¤±è´¥: ${res.status}`);
  const data = await res.json();
  return state.config.apiProvider==='claude' ? data.content[0].text : data.choices[0].message.content;
}

/* ================== Add Contact ================== */
function openAddContactModal(){ document.getElementById('addContactModal').style.display='flex'; }
function closeModal(){ document.querySelectorAll('.modal').forEach(m=>m.style.display='none'); document.querySelectorAll('.modal-input,.modal-textarea').forEach(i=>i.value=''); }
function addContact(){
  const name = document.getElementById('contactName').value.trim();
  const emoji = document.getElementById('contactEmoji').value.trim();
  const prompt = document.getElementById('contactPrompt').value.trim();
  if(!name || !emoji || !prompt){ alert('è¯·å¡«å†™æ‰€æœ‰å­—æ®µ'); return; }
  const c = {id:'contact-'+Date.now(), name, emoji, prompt};
  state.contacts.push(c); state.messages[c.id]=[];
  localStorage.setItem(LS_KEYS.contacts, JSON.stringify(state.contacts));
  localStorage.setItem(LS_KEYS.messages, JSON.stringify(state.messages));
  renderChatList(); closeModal();
}

/* ================== Settings (API) ================== */
function loadSettings(){
  const saved = localStorage.getItem(LS_KEYS.config);
  if(saved){ try{ Object.assign(state.config, JSON.parse(saved)); }catch{} }
}
function updateSettingsUI(){
  document.getElementById('apiProvider').value = state.config.apiProvider;
  document.getElementById('apiUrl').value = state.config.apiUrl;
  document.getElementById('apiKey').value = state.config.apiKey;
  document.getElementById('modelName').value = state.config.modelName;
}
function updateApiSettings(){
  const provider = document.getElementById('apiProvider').value;
  if(provider==='openai'){
    document.getElementById('apiUrl').value='https://api.openai.com/v1/chat/completions';
    document.getElementById('modelName').value='gpt-3.5-turbo';
  }else if(provider==='claude'){
    document.getElementById('apiUrl').value='https://api.anthropic.com/v1/messages';
    document.getElementById('modelName').value='claude-3-sonnet-20240229';
  }
}
function saveSettings(){
  state.config.apiProvider = document.getElementById('apiProvider').value;
  state.config.apiUrl = document.getElementById('apiUrl').value.trim();
  state.config.apiKey = document.getElementById('apiKey').value.trim();
  state.config.modelName = document.getElementById('modelName').value.trim();
  localStorage.setItem(LS_KEYS.config, JSON.stringify(state.config));
  alert('ä¿å­˜æˆåŠŸï¼');
}

/* ================== Theme (Wallpaper + Icons) ================== */
function loadTheme(){
  const saved = localStorage.getItem(LS_KEYS.theme);
  if(saved){ try{ Object.assign(state.theme, JSON.parse(saved)); }catch{} }
  applyWallpaper(state.theme.wallpaper);
  applyIcon('chat', state.theme.icons.chat);
  applyIcon('settings', state.theme.icons.settings);
  applyIcon('theme', state.theme.icons.theme);
}
function saveTheme(){ localStorage.setItem(LS_KEYS.theme, JSON.stringify(state.theme)); }

/* Wallpaper */
function uploadWallpaper(e){
  const file = e.target.files && e.target.files[0]; if(!file) return;
  const reader = new FileReader();
  reader.onload = ev=>{
    state.theme.wallpaper = ev.target.result; // dataURL
    saveTheme(); applyWallpaper(state.theme.wallpaper);
  };
  reader.readAsDataURL(file);
}
function applyWallpaper(raw){
  const el = document.getElementById('appContainer');
  if(!raw){
    el.style.setProperty('--bg-image','linear-gradient(135deg,#1e3c72 0%,#2a5298 100%)');
    return;
  }
  const css = raw.startsWith('url(') ? raw : `url(${raw})`;
  // å…¨å±é“ºæ»¡ + å±…ä¸­ å·²ç”±å®¹å™¨ CSS æ§åˆ¶ï¼šbackground: var(--bg-image) center/cover no-repeat
  el.style.setProperty('--bg-image', css);
}

/* Icons */
const ICONS = [
  {key:'chat', label:'å¾®ä¿¡', target:'icon-chat'},
  {key:'settings', label:'è®¾ç½®', target:'icon-settings'},
  {key:'theme', label:'ä¸»é¢˜', target:'icon-theme'}
];
function renderIconGrid(){
  const grid = document.getElementById('iconGrid'); grid.innerHTML='';
  ICONS.forEach(ic=>{
    const wrap = document.createElement('div');
    wrap.innerHTML = `
      <div class="icon-preview">
        <div class="icon-preview-inner" id="preview-${ic.key}" style="background:${state.theme.icons[ic.key] ? `url(${state.theme.icons[ic.key]}) center/cover no-repeat` : 'transparent'}"></div>
      </div>
      <div class="icon-actions">
        <button class="small-btn" onclick="uploadIcon('${ic.key}')">ä¸Šä¼  ${ic.label}</button>
        <button class="small-btn" style="background:#6b7280" onclick="clearIcon('${ic.key}')">æ¸…é™¤</button>
      </div>
    `;
    grid.appendChild(wrap);
  });
}
function uploadIcon(key){
  const input = document.createElement('input');
  input.type='file'; input.accept='image/*';
  input.onchange = (e)=>{
    const file = e.target.files && e.target.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = ev=>{
      state.theme.icons[key] = ev.target.result; // dataURL
      saveTheme(); applyIcon(key, state.theme.icons[key]);
      const prev = document.getElementById(`preview-${key}`);
      if(prev) prev.style.background = `url(${state.theme.icons[key]}) center/cover no-repeat`;
    };
    reader.readAsDataURL(file);
  };
  input.click();
}
function clearIcon(key){
  state.theme.icons[key] = null; saveTheme(); applyIcon(key,null);
  const prev = document.getElementById(`preview-${key}`);
  if(prev) prev.style.background = 'transparent';
}
function applyIcon(key,dataUrl){
  const targetId = ICONS.find(i=>i.key===key)?.target;
  const el = document.getElementById(targetId);
  if(!el) return;
  el.style.setProperty('--icon-bg', dataUrl ? `url(${dataUrl})` : 'transparent');
}

/* ================== Special Messages (Image/Voice/Link/Money) ================== */
function createSpecialMessage(type, header, content){
  const colorMap = {
    image:'linear-gradient(135deg,#74b9ff,#0984e3)',
    voice:'linear-gradient(135deg,#fd79a8,#e84393)',
    link:'linear-gradient(135deg,#55a3ff,#3742fa)',
    money:'linear-gradient(135deg,#ffeaa7,#fdcb6e)'
  };
  const darkText = type==='money' ? 'style="color:#2d3436"' : '';
  return `<div class="special-message" style="border-radius:12px;padding:14px;margin:10px 0;background:${colorMap[type]};color:#fff;box-shadow:0 4px 12px rgba(0,0,0,.3);" ${darkText}>
    <div style="font-weight:700;margin-bottom:6px;display:flex;align-items:center;gap:6px">${header}</div>
    <div>${content}</div>
  </div>`;
}
function openImageModal(){ document.getElementById('imageModal').style.display='flex'; }
function openVoiceModal(){ document.getElementById('voiceModal').style.display='flex'; }
function openLinkModal(){ document.getElementById('linkModal').style.display='flex'; }
function openMoneyModal(){ document.getElementById('moneyModal').style.display='flex'; }

function sendImage(){
  const title = document.getElementById('imageTitle').value.trim();
  const desc  = document.getElementById('imageDesc').value.trim();
  if(!desc) return alert('è¯·è¾“å…¥å›¾ç‰‡æè¿°');
  const msg = createSpecialMessage('image', 'ğŸ“¸ ' + (title||'å›¾ç‰‡'), desc);
  addMessage(msg,'user',true);
  setTimeout(()=>addMessage('æˆ‘çœ‹åˆ°äº†ä½ æè¿°çš„å›¾ç‰‡ï¼š'+desc+'ã€‚','ai'),500);
  closeModal();
}
function sendVoice(){
  const d = document.getElementById('voiceDuration').value.trim();
  const c = document.getElementById('voiceContent').value.trim();
  if(!c) return alert('è¯·è¾“å…¥è¯­éŸ³å†…å®¹');
  const msg = createSpecialMessage('voice','ğŸ¤ è¯­éŸ³æ¶ˆæ¯',`æ—¶é•¿: ${d||'æœªçŸ¥'}ç§’<br>å†…å®¹: ${c}`);
  addMessage(msg,'user',true);
  setTimeout(()=>addMessage('æˆ‘æ”¶åˆ°äº†ä½ çš„è¯­éŸ³ï¼š'+c,'ai'),500);
  closeModal();
}
function sendLink(){
  const t = document.getElementById('linkTitle').value.trim();
  const u = document.getElementById('linkUrl').value.trim();
  const d = document.getElementById('linkDesc').value.trim();
  if(!t || !u) return alert('è¯·è¾“å…¥é“¾æ¥æ ‡é¢˜å’Œåœ°å€');
  const msg = createSpecialMessage('link','ğŸ”— '+t,`é“¾æ¥: ${u}<br>${d?('æè¿°: '+d):''}`);
  addMessage(msg,'user',true);
  setTimeout(()=>addMessage('æ„Ÿè°¢åˆ†äº«ï¼š'+t,'ai'),500);
  closeModal();
}
function sendMoney(){
  const amt = document.getElementById('moneyAmount').value.trim();
  const note = document.getElementById('moneyNote').value.trim();
  const ty = document.getElementById('moneyType').value;
  if(!amt) return alert('è¯·è¾“å…¥é‡‘é¢');
  const tag = ty==='redpack'?'çº¢åŒ…':'è½¬è´¦';
  const msg = createSpecialMessage('money','ğŸ’° '+tag,`é‡‘é¢: Â¥${amt}${note?('<br>å¤‡æ³¨: '+note):''}`);
  addMessage(msg,'user',true);
  setTimeout(()=>addMessage(`æ”¶åˆ°ä½ çš„${tag}ï¼šÂ¥${amt}ã€‚${note?('å¤‡æ³¨ï¼š'+note):''}`,'ai'),500);
  closeModal();
}

/* ================== Theme Reset ================== */
function resetTheme(){
  state.theme.wallpaper=null;
  state.theme.icons={chat:null,settings:null,theme:null};
  saveTheme(); loadTheme(); renderIconGrid();
}

/* ================== Init ================== */
window.addEventListener('load', ()=>{
  loadSettings();
  loadTheme();
  initContacts();
  renderIconGrid();
});
</script>
</body>
</html>